{
  "$defs": {
    "AlertConfig": {
      "description": "Configuration for alerts.",
      "properties": {
        "type": {
          "$ref": "#/$defs/AlertType"
        },
        "url": {
          "description": "Webhook URL",
          "title": "Url",
          "type": "string"
        },
        "on_events": {
          "default": [
            "on_failure"
          ],
          "description": "Events to trigger alert: on_start, on_success, on_failure",
          "items": {
            "type": "string"
          },
          "title": "On Events",
          "type": "array"
        },
        "metadata": {
          "description": "Extra metadata for alert",
          "title": "Metadata",
          "type": "object"
        }
      },
      "required": [
        "type",
        "url"
      ],
      "title": "AlertConfig",
      "type": "object"
    },
    "AlertType": {
      "description": "Types of alerting channels.",
      "enum": [
        "webhook",
        "slack",
        "teams"
      ],
      "title": "AlertType",
      "type": "string"
    },
    "EngineType": {
      "description": "Supported execution engines.",
      "enum": [
        "spark",
        "pandas"
      ],
      "title": "EngineType",
      "type": "string"
    },
    "ErrorStrategy": {
      "description": "Strategy for handling node failures.",
      "enum": [
        "fail_fast",
        "fail_later",
        "ignore"
      ],
      "title": "ErrorStrategy",
      "type": "string"
    },
    "LogLevel": {
      "description": "Logging levels.",
      "enum": [
        "DEBUG",
        "INFO",
        "WARNING",
        "ERROR"
      ],
      "title": "LogLevel",
      "type": "string"
    },
    "LoggingConfig": {
      "description": "Logging configuration.",
      "properties": {
        "level": {
          "allOf": [
            {
              "$ref": "#/$defs/LogLevel"
            }
          ],
          "default": "INFO"
        },
        "structured": {
          "default": false,
          "description": "Output JSON logs",
          "title": "Structured",
          "type": "boolean"
        },
        "metadata": {
          "description": "Extra metadata in logs",
          "title": "Metadata",
          "type": "object"
        }
      },
      "title": "LoggingConfig",
      "type": "object"
    },
    "NodeConfig": {
      "description": "Configuration for a single node.",
      "properties": {
        "name": {
          "description": "Unique node name",
          "title": "Name",
          "type": "string"
        },
        "description": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Human-readable description",
          "title": "Description"
        },
        "depends_on": {
          "description": "List of node dependencies",
          "items": {
            "type": "string"
          },
          "title": "Depends On",
          "type": "array"
        },
        "read": {
          "anyOf": [
            {
              "$ref": "#/$defs/ReadConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "transform": {
          "anyOf": [
            {
              "$ref": "#/$defs/TransformConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "write": {
          "anyOf": [
            {
              "$ref": "#/$defs/WriteConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "cache": {
          "default": false,
          "description": "Cache result for reuse",
          "title": "Cache",
          "type": "boolean"
        },
        "log_level": {
          "anyOf": [
            {
              "$ref": "#/$defs/LogLevel"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Override log level for this node"
        },
        "on_error": {
          "allOf": [
            {
              "$ref": "#/$defs/ErrorStrategy"
            }
          ],
          "default": "fail_later",
          "description": "Failure handling strategy"
        },
        "validation": {
          "anyOf": [
            {
              "$ref": "#/$defs/ValidationConfig"
            },
            {
              "type": "null"
            }
          ],
          "default": null
        },
        "sensitive": {
          "anyOf": [
            {
              "type": "boolean"
            },
            {
              "items": {
                "type": "string"
              },
              "type": "array"
            }
          ],
          "default": false,
          "description": "If true or list of columns, masks sample data in stories",
          "title": "Sensitive"
        }
      },
      "required": [
        "name"
      ],
      "title": "NodeConfig",
      "type": "object"
    },
    "PipelineConfig": {
      "description": "Configuration for a pipeline.",
      "properties": {
        "pipeline": {
          "description": "Pipeline name",
          "title": "Pipeline",
          "type": "string"
        },
        "description": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Pipeline description",
          "title": "Description"
        },
        "layer": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Logical layer (bronze/silver/gold)",
          "title": "Layer"
        },
        "nodes": {
          "description": "List of nodes in this pipeline",
          "items": {
            "$ref": "#/$defs/NodeConfig"
          },
          "title": "Nodes",
          "type": "array"
        }
      },
      "required": [
        "pipeline",
        "nodes"
      ],
      "title": "PipelineConfig",
      "type": "object"
    },
    "ReadConfig": {
      "description": "Configuration for reading data.",
      "properties": {
        "connection": {
          "description": "Connection name from project.yaml",
          "title": "Connection",
          "type": "string"
        },
        "format": {
          "description": "Data format (csv, parquet, delta, etc.)",
          "title": "Format",
          "type": "string"
        },
        "table": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Table name for SQL/Delta",
          "title": "Table"
        },
        "path": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Path for file-based sources",
          "title": "Path"
        },
        "options": {
          "description": "Format-specific options",
          "title": "Options",
          "type": "object"
        }
      },
      "required": [
        "connection",
        "format"
      ],
      "title": "ReadConfig",
      "type": "object"
    },
    "RetryConfig": {
      "description": "Retry configuration.",
      "properties": {
        "enabled": {
          "default": true,
          "title": "Enabled",
          "type": "boolean"
        },
        "max_attempts": {
          "default": 3,
          "maximum": 10,
          "minimum": 1,
          "title": "Max Attempts",
          "type": "integer"
        },
        "backoff": {
          "default": "exponential",
          "pattern": "^(exponential|linear|constant)$",
          "title": "Backoff",
          "type": "string"
        }
      },
      "title": "RetryConfig",
      "type": "object"
    },
    "StoryConfig": {
      "description": "Story generation configuration.\n\nStories are ODIBI's core value - execution reports with lineage.\nThey must use a connection for consistent, traceable output.",
      "properties": {
        "connection": {
          "description": "Connection name for story output (uses connection's path resolution)",
          "title": "Connection",
          "type": "string"
        },
        "path": {
          "description": "Path for stories (relative to connection base_path)",
          "title": "Path",
          "type": "string"
        },
        "max_sample_rows": {
          "default": 10,
          "maximum": 100,
          "minimum": 0,
          "title": "Max Sample Rows",
          "type": "integer"
        },
        "auto_generate": {
          "default": true,
          "title": "Auto Generate",
          "type": "boolean"
        },
        "retention_days": {
          "anyOf": [
            {
              "minimum": 1,
              "type": "integer"
            },
            {
              "type": "null"
            }
          ],
          "default": 30,
          "description": "Days to keep stories",
          "title": "Retention Days"
        },
        "retention_count": {
          "anyOf": [
            {
              "minimum": 1,
              "type": "integer"
            },
            {
              "type": "null"
            }
          ],
          "default": 100,
          "description": "Max number of stories to keep",
          "title": "Retention Count"
        }
      },
      "required": [
        "connection",
        "path"
      ],
      "title": "StoryConfig",
      "type": "object"
    },
    "TransformConfig": {
      "description": "Configuration for transforming data.",
      "properties": {
        "steps": {
          "description": "List of transformation steps (SQL strings or TransformStep configs)",
          "items": {
            "anyOf": [
              {
                "type": "string"
              },
              {
                "$ref": "#/$defs/TransformStep"
              }
            ]
          },
          "title": "Steps",
          "type": "array"
        }
      },
      "required": [
        "steps"
      ],
      "title": "TransformConfig",
      "type": "object"
    },
    "TransformStep": {
      "description": "Single transformation step.",
      "properties": {
        "sql": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Sql"
        },
        "function": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Function"
        },
        "operation": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "title": "Operation"
        },
        "params": {
          "title": "Params",
          "type": "object"
        }
      },
      "title": "TransformStep",
      "type": "object"
    },
    "ValidationConfig": {
      "description": "Configuration for data validation.",
      "properties": {
        "schema": {
          "anyOf": [
            {
              "type": "object"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Schema validation rules",
          "title": "Schema"
        },
        "not_empty": {
          "default": false,
          "description": "Ensure result is not empty",
          "title": "Not Empty",
          "type": "boolean"
        },
        "no_nulls": {
          "description": "Columns that must not have nulls",
          "items": {
            "type": "string"
          },
          "title": "No Nulls",
          "type": "array"
        },
        "ranges": {
          "additionalProperties": {
            "additionalProperties": {
              "type": "number"
            },
            "type": "object"
          },
          "description": "Value ranges {col: {min: 0, max: 100}}",
          "title": "Ranges",
          "type": "object"
        },
        "allowed_values": {
          "additionalProperties": {
            "items": {},
            "type": "array"
          },
          "description": "Allowed values {col: [val1, val2]}",
          "title": "Allowed Values",
          "type": "object"
        }
      },
      "title": "ValidationConfig",
      "type": "object"
    },
    "WriteConfig": {
      "description": "Configuration for writing data.",
      "properties": {
        "connection": {
          "description": "Connection name from project.yaml",
          "title": "Connection",
          "type": "string"
        },
        "format": {
          "description": "Output format (csv, parquet, delta, etc.)",
          "title": "Format",
          "type": "string"
        },
        "table": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Table name for SQL/Delta",
          "title": "Table"
        },
        "path": {
          "anyOf": [
            {
              "type": "string"
            },
            {
              "type": "null"
            }
          ],
          "default": null,
          "description": "Path for file-based outputs",
          "title": "Path"
        },
        "mode": {
          "allOf": [
            {
              "$ref": "#/$defs/WriteMode"
            }
          ],
          "default": "overwrite",
          "description": "Write mode"
        },
        "options": {
          "description": "Format-specific options",
          "title": "Options",
          "type": "object"
        }
      },
      "required": [
        "connection",
        "format"
      ],
      "title": "WriteConfig",
      "type": "object"
    },
    "WriteMode": {
      "description": "Write modes for output operations.",
      "enum": [
        "overwrite",
        "append"
      ],
      "title": "WriteMode",
      "type": "string"
    }
  },
  "description": "Complete project configuration from YAML.\n\nRepresents the entire YAML structure with validation.\nAll settings are top-level (no nested defaults).",
  "properties": {
    "project": {
      "description": "Project name",
      "title": "Project",
      "type": "string"
    },
    "engine": {
      "allOf": [
        {
          "$ref": "#/$defs/EngineType"
        }
      ],
      "default": "pandas",
      "description": "Execution engine"
    },
    "connections": {
      "additionalProperties": {
        "type": "object"
      },
      "description": "Named connections (at least one required)",
      "title": "Connections",
      "type": "object"
    },
    "pipelines": {
      "description": "Pipeline definitions (at least one required)",
      "items": {
        "$ref": "#/$defs/PipelineConfig"
      },
      "title": "Pipelines",
      "type": "array"
    },
    "story": {
      "allOf": [
        {
          "$ref": "#/$defs/StoryConfig"
        }
      ],
      "description": "Story generation configuration (mandatory)"
    },
    "description": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Project description",
      "title": "Description"
    },
    "version": {
      "default": "1.0.0",
      "description": "Project version",
      "title": "Version",
      "type": "string"
    },
    "owner": {
      "anyOf": [
        {
          "type": "string"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Project owner/contact",
      "title": "Owner"
    },
    "retry": {
      "$ref": "#/$defs/RetryConfig"
    },
    "logging": {
      "$ref": "#/$defs/LoggingConfig"
    },
    "alerts": {
      "description": "Alert configurations",
      "items": {
        "$ref": "#/$defs/AlertConfig"
      },
      "title": "Alerts",
      "type": "array"
    },
    "environments": {
      "anyOf": [
        {
          "additionalProperties": {
            "type": "object"
          },
          "type": "object"
        },
        {
          "type": "null"
        }
      ],
      "default": null,
      "description": "Environment-specific overrides (Phase 3 - not implemented)",
      "title": "Environments"
    }
  },
  "required": [
    "project",
    "connections",
    "pipelines",
    "story"
  ],
  "title": "ProjectConfig",
  "type": "object"
}