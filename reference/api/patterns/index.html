
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A declarative data engineering framework - Explicit over implicit, Stories over magic.">
      
      
      
        <link rel="canonical" href="https://henryodibi11.github.io/Odibi/reference/api/patterns/">
      
      
        <link rel="prev" href="../../../api/context/">
      
      
        <link rel="next" href="../validation/">
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Patterns - Odibi Framework</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="teal">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#patterns-api" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Odibi Framework" class="md-header__button md-logo" aria-label="Odibi Framework" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Odibi Framework
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Patterns
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="green" data-md-color-accent="teal"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="green" data-md-color-accent="teal"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/henryodibi11/Odibi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    henryodibi11/Odibi
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  
  Start Here

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../philosophy/" class="md-tabs__link">
          
  
  
  Learn

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../guides/the_definitive_guide/" class="md-tabs__link">
          
  
  
  Guides

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../validation/" class="md-tabs__link">
          
  
  
  Operate

        </a>
      </li>
    
  

    
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../../cheatsheet/" class="md-tabs__link">
          
  
  
  Reference

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


  

<nav class="md-nav md-nav--primary md-nav--lifted md-nav--integrated" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Odibi Framework" class="md-nav__button md-logo" aria-label="Odibi Framework" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Odibi Framework
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/henryodibi11/Odibi" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    henryodibi11/Odibi
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Start Here
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Start Here
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Home
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../golden_path/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Golden Path
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../playbook/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Playbook
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/installation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Installation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quickstart
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2" >
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Learn
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Learn
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../philosophy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Philosophy
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../explanation/architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/medallion_architecture/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Medallion Architecture
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Core Concepts
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Core Concepts
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/pipelines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipelines & Nodes
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/connections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connections
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/engines/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Engines
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/transformers/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Transformers
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Loading Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/state/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    State Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/stories/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Stories
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/orchestration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Orchestration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/bulk_copy/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bulk Copy (SQL Server)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data Engineering 101
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data Engineering 101
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learning/curriculum/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Curriculum
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learning/data_engineering_101/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Data Engineering 101
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../learning/glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Dimensional Modeling (Tutorial)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dimensional Modeling (Tutorial)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/01_introduction/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Introduction
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/02_dimension_pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dimension Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/03_date_dimension_pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Date Dimension
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/04_fact_pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fact Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/05_aggregation_pattern/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Aggregation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/06_full_star_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Full Star Schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/07_semantic_layer_intro/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Semantic Layer Intro
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/08_defining_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Defining Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/09_defining_dimensions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Defining Dimensions
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/10_querying_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Querying Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/11_materializing_metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Materializing Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/12_semantic_full_example/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Full Semantic Example
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/dimensional_modeling/13_fk_validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FK Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Guides
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Guides
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/the_definitive_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    The Definitive Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/decision_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Decision Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Tutorials
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Tutorials
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/bronze_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Bronze Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/silver_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Silver Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/gold_layer/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Gold Layer
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/spark_engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Spark Engine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../tutorials/azure_connections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Azure Connections
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Examples (Copy/Paste)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Examples (Copy/Paste)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/canonical/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/canonical/01_hello_world/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    1. Hello World
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/canonical/02_incremental_sql/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    2. Incremental SQL
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/canonical/03_scd2_dimension/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    3. SCD2 Dimension
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/canonical/04_fact_table/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    4. Fact Table
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../examples/canonical/05_full_pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    5. Full Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5" id="__nav_3_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Patterns (Problem → Solution)
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Patterns (Problem → Solution)
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5_2" >
        
          
          <label class="md-nav__link" for="__nav_3_5_2" id="__nav_3_5_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data Loading
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data Loading
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/append_only_raw/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Append-Only Raw
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/incremental_stateful/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Incremental Stateful
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/merge_upsert/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Merge/Upsert
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/sql_server_merge/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SQL Server Merge
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/windowed_reprocess/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Windowed Reprocess
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/smart_read/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Smart Read
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/skip_if_unchanged/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Skip If Unchanged
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5_3" >
        
          
          <label class="md-nav__link" for="__nav_3_5_3" id="__nav_3_5_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Dimensional Modeling
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Dimensional Modeling
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/dimension/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Dimension Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/date_dimension/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Date Dimension
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/fact/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Fact Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/aggregation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Aggregation Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/scd2/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    SCD2 Pattern
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5_4" >
        
          
          <label class="md-nav__link" for="__nav_3_5_4" id="__nav_3_5_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Manufacturing
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Manufacturing
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/manufacturing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Phase Analysis
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_5_5" >
        
          
          <label class="md-nav__link" for="__nav_3_5_5" id="__nav_3_5_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Engineering
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_5_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_5_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Engineering
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/unit_conversion/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Unit Conversion
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/thermodynamics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Thermodynamics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../patterns/anti_patterns/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Anti-Patterns
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_6" id="__nav_3_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Common Tasks
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_6">
            <span class="md-nav__icon md-icon"></span>
            
  
    Common Tasks
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/writing_transformations/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Writing Transformations
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/custom_functions/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Custom Functions Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/variable_substitution/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Variable Substitution
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/explanation_feature/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Explanation Feature
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/api_data_sources/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    API Data Sources
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/recipes/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cookbook (Recipes)
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/testing/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Testing Pipelines
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/best_practices/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Best Practices
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_7" >
        
          
          <label class="md-nav__link" for="__nav_3_7" id="__nav_3_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Interfaces
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_7">
            <span class="md-nav__icon md-icon"></span>
            
  
    Interfaces
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/cli_master_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Master Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/python_api_guide/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Python API Guide
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3_8" >
        
          
          <label class="md-nav__link" for="__nav_3_8" id="__nav_3_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Semantic Layer
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_8">
            <span class="md-nav__icon md-icon"></span>
            
  
    Semantic Layer
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../semantics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../semantics/metrics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Defining Metrics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../semantics/query/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Querying
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../semantics/materialize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Materializing
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../semantics/runner/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Running Views
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Operate
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Operate
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_1" >
        
          
          <label class="md-nav__link" for="__nav_4_1" id="__nav_4_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Data Quality
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_1">
            <span class="md-nav__icon md-icon"></span>
            
  
    Data Quality
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Overview
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../validation/contracts/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Contracts
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../validation/tests/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Validation Tests
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/quality_gates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quality Gates
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/quarantine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Quarantine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../validation/fk/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    FK Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Observability
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            
  
    Observability
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/observability/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Observability
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/alerting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Alerting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/diagnostics/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Diagnostics
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/lineage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Lineage
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/schema_tracking/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Schema Tracking
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/catalog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Catalog
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/catalog_sync/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Catalog Sync
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4_3" >
        
          
          <label class="md-nav__link" for="__nav_4_3" id="__nav_4_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    
  
    Deployment
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Deployment
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/production_deployment/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Production Deployment
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/environments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Environments
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/secrets/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Secrets Management
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/setup_azure/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Azure Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/performance_tuning/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Performance Tuning
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../guides/wsl_setup/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    WSL Setup
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../troubleshooting/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Troubleshooting
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" checked>
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Reference
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            
  
    Reference
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../cheatsheet/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cheatsheet
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../yaml_schema/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    YAML Schema
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../templates/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Templates Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../configuration/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Configuration
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../supported_formats/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Supported Formats
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../PARITY_TABLE/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Engine Parity
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../glossary/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Glossary
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../features/cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI Reference
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ODIBI_DEEP_CONTEXT/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    AI Deep Context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
        
          
          
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5_10" checked>
        
          
          <label class="md-nav__link" for="__nav_5_10" id="__nav_5_10_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    API
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_5_10_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_5_10">
            <span class="md-nav__icon md-icon"></span>
            
  
    API
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../pipeline/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Pipeline
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../engine/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Engine
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../api/context/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Context
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    
  
    Patterns
  

    
  </span>
  
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    
  
    Patterns
  

    
  </span>
  
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#odibi.patterns.base" class="md-nav__link">
    <span class="md-ellipsis">
      
        base
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#odibi.patterns.scd2" class="md-nav__link">
    <span class="md-ellipsis">
      
        scd2
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="scd2">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.scd2.SCD2Pattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        SCD2Pattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="SCD2Pattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.scd2.SCD2Pattern.execute" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.scd2.SCD2Pattern.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#odibi.patterns.merge" class="md-nav__link">
    <span class="md-ellipsis">
      
        merge
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="merge">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.merge.MergePattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        MergePattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="MergePattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.merge.MergePattern.execute" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.merge.MergePattern.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#odibi.patterns.dimension" class="md-nav__link">
    <span class="md-ellipsis">
      
        dimension
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="dimension">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.dimension.AuditConfig" class="md-nav__link">
    <span class="md-ellipsis">
      
        AuditConfig
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.dimension.DimensionPattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        DimensionPattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DimensionPattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.dimension.DimensionPattern.execute" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.dimension.DimensionPattern.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#odibi.patterns.date_dimension" class="md-nav__link">
    <span class="md-ellipsis">
      
        date_dimension
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="date_dimension">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.date_dimension.DateDimensionPattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        DateDimensionPattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="DateDimensionPattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.date_dimension.DateDimensionPattern.execute" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.date_dimension.DateDimensionPattern.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#odibi.patterns.fact" class="md-nav__link">
    <span class="md-ellipsis">
      
        fact
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="fact">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.fact.FactPattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        FactPattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="FactPattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.fact.FactPattern.execute" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.fact.FactPattern.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#odibi.patterns.aggregation" class="md-nav__link">
    <span class="md-ellipsis">
      
        aggregation
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="aggregation">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.aggregation.AggregationPattern" class="md-nav__link">
    <span class="md-ellipsis">
      
        AggregationPattern
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="AggregationPattern">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.aggregation.AggregationPattern.execute" class="md-nav__link">
    <span class="md-ellipsis">
      
        execute
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#odibi.patterns.aggregation.AggregationPattern.validate" class="md-nav__link">
    <span class="md-ellipsis">
      
        validate
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Validation
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../config/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Config
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../connections/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Connections
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../cli/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    CLI
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
          
          
            <div class="md-content" data-md-component="content">
              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="patterns-api">Patterns API<a class="headerlink" href="#patterns-api" title="Permanent link">&para;</a></h1>


<div class="doc doc-object doc-module">



<h2 id="odibi.patterns.base" class="doc doc-heading">
            <code>odibi.patterns.base</code>


<a href="#odibi.patterns.base" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="odibi.patterns.scd2" class="doc doc-heading">
            <code>odibi.patterns.scd2</code>


<a href="#odibi.patterns.scd2" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="odibi.patterns.scd2.SCD2Pattern" class="doc doc-heading">
            <code>SCD2Pattern</code>


<a href="#odibi.patterns.scd2.SCD2Pattern" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="odibi.patterns.base.Pattern">Pattern</span></code></p>



        <p>SCD2 Pattern: Slowly Changing Dimension Type 2.</p>
<p>Tracks history by creating new rows for updates.</p>
<p>Configuration Options (via params dict):
    - <strong>keys</strong> (list): Business keys.
    - <strong>time_col</strong> (str): Timestamp column for versioning (default: current time).
    - <strong>valid_from_col</strong> (str): Name of start date column (default: valid_from).
    - <strong>valid_to_col</strong> (str): Name of end date column (default: valid_to).
    - <strong>is_current_col</strong> (str): Name of current flag column (default: is_current).</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>odibi/patterns/scd2.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">SCD2Pattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    SCD2 Pattern: Slowly Changing Dimension Type 2.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Tracks history by creating new rows for updates.</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    Configuration Options (via params dict):</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        - **keys** (list): Business keys.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">        - **time_col** (str): Timestamp column for versioning (default: current time).</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">        - **valid_from_col** (str): Name of start date column (default: valid_from).</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">        - **valid_to_col** (str): Name of end date column (default: valid_to).</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        - **is_current_col** (str): Name of current flag column (default: is_current).</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate SCD2 pattern configuration parameters.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        Ensures that all required parameters are present for SCD Type 2 operations. Checks that:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        - keys are provided (business keys to track changes)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        - target is provided (existing dimension table for comparison)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            ValueError: If keys are missing or target is missing.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="s2">&quot;SCD2Pattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">),</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">),</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">):</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>                <span class="s2">&quot;SCD2Pattern validation failed: &#39;keys&#39; parameter is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>                <span class="sa">f</span><span class="s2">&quot;SCD2Pattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;keys&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>                <span class="sa">f</span><span class="s2">&quot;Expected a list of business key column names, but got: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="sa">f</span><span class="s2">&quot;Available params: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="s2">&quot;Fix: Provide &#39;keys&#39; as a list, e.g., keys=[&#39;customer_id&#39;].&quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">):</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>                <span class="s2">&quot;SCD2Pattern validation failed: &#39;target&#39; parameter is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>                <span class="sa">f</span><span class="s2">&quot;SCD2Pattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;target&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>                <span class="sa">f</span><span class="s2">&quot;Expected a table name or path string, but got: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>                <span class="s2">&quot;Fix: Provide &#39;target&#39; as a string, e.g., target=&#39;dim_customer&#39;.&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="s2">&quot;SCD2Pattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>            <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">),</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">),</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="p">)</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the SCD2 pattern to track dimension history with versioning.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">        Implements Slowly Changing Dimension Type 2 logic by delegating to the scd2 transformer.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">        The execution flow:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">        1. Load existing target dimension table</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">        2. Compare source records with current dimension records using business keys</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">        3. Expire changed records (set valid_to date, is_current=false)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        4. Insert new versions for changed records (new valid_from, is_current=true)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        5. Insert new records for keys not in target</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        The result includes version history with valid_from, valid_to, and is_current columns.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">            context: Engine context containing the source DataFrame and execution environment.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">            DataFrame with SCD2 logic applied, including versioned records with valid_from,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            valid_to, and is_current columns.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            ValueError: If SCD2 parameters are invalid or cannot be parsed.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">            Exception: If target loading fails, change detection fails, or versioning fails.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">valid_from_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_from_col&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_from&quot;</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">valid_to_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_to_col&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_to&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">is_current_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_current_col&quot;</span><span class="p">,</span> <span class="s2">&quot;is_current&quot;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">track_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_cols&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="s2">&quot;SCD2 pattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">valid_from_col</span><span class="o">=</span><span class="n">valid_from_col</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">valid_to_col</span><span class="o">=</span><span class="n">valid_to_col</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="n">is_current_col</span><span class="o">=</span><span class="n">is_current_col</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="n">track_cols</span><span class="o">=</span><span class="n">track_cols</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="n">source_count</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;spark&quot;</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="n">source_count</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="n">source_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SCD2 source data loaded&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span> <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SCD2 could not determine source row count&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">valid_keys</span> <span class="o">=</span> <span class="n">SCD2Params</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">filtered_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_keys</span><span class="p">}</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="n">scd_params</span> <span class="o">=</span> <span class="n">SCD2Params</span><span class="p">(</span><span class="o">**</span><span class="n">filtered_params</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="sa">f</span><span class="s2">&quot;SCD2 invalid parameters: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="n">params</span><span class="o">=</span><span class="n">filtered_params</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="sa">f</span><span class="s2">&quot;Invalid SCD2 parameters in node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="sa">f</span><span class="s2">&quot;Provided params: </span><span class="si">{</span><span class="n">filtered_params</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="sa">f</span><span class="s2">&quot;Valid param names: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">valid_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="n">result_ctx</span> <span class="o">=</span> <span class="n">scd2</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">scd_params</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>                <span class="sa">f</span><span class="s2">&quot;SCD2 pattern execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="k">raise</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_ctx</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">result_count</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;spark&quot;</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="n">result_count</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">result_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="k">pass</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="s2">&quot;SCD2 pattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="n">result_rows</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="n">valid_from_col</span><span class="o">=</span><span class="n">valid_from_col</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">valid_to_col</span><span class="o">=</span><span class="n">valid_to_col</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">return</span> <span class="n">result_df</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.scd2.SCD2Pattern.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

<a href="#odibi.patterns.scd2.SCD2Pattern.execute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Execute the SCD2 pattern to track dimension history with versioning.</p>
<p>Implements Slowly Changing Dimension Type 2 logic by delegating to the scd2 transformer.
The execution flow:
1. Load existing target dimension table
2. Compare source records with current dimension records using business keys
3. Expire changed records (set valid_to date, is_current=false)
4. Insert new versions for changed records (new valid_from, is_current=true)
5. Insert new records for keys not in target</p>
<p>The result includes version history with valid_from, valid_to, and is_current columns.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="odibi.context.EngineContext">EngineContext</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine context containing the source DataFrame and execution environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with SCD2 logic applied, including versioned records with valid_from,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>valid_to, and is_current columns.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If SCD2 parameters are invalid or cannot be parsed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If target loading fails, change detection fails, or versioning fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/scd2.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the SCD2 pattern to track dimension history with versioning.</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">    Implements Slowly Changing Dimension Type 2 logic by delegating to the scd2 transformer.</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">    The execution flow:</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">    1. Load existing target dimension table</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">    2. Compare source records with current dimension records using business keys</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">    3. Expire changed records (set valid_to date, is_current=false)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    4. Insert new versions for changed records (new valid_from, is_current=true)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">    5. Insert new records for keys not in target</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    The result includes version history with valid_from, valid_to, and is_current columns.</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        context: Engine context containing the source DataFrame and execution environment.</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        DataFrame with SCD2 logic applied, including versioned records with valid_from,</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        valid_to, and is_current columns.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        ValueError: If SCD2 parameters are invalid or cannot be parsed.</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a><span class="sd">        Exception: If target loading fails, change detection fails, or versioning fails.</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">valid_from_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_from_col&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_from&quot;</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">valid_to_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_to_col&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_to&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">is_current_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_current_col&quot;</span><span class="p">,</span> <span class="s2">&quot;is_current&quot;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">track_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_cols&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="s2">&quot;SCD2 pattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">valid_from_col</span><span class="o">=</span><span class="n">valid_from_col</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="n">valid_to_col</span><span class="o">=</span><span class="n">valid_to_col</span><span class="p">,</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="n">is_current_col</span><span class="o">=</span><span class="n">is_current_col</span><span class="p">,</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">track_cols</span><span class="o">=</span><span class="n">track_cols</span><span class="p">,</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="n">source_count</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;spark&quot;</span><span class="p">:</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">source_count</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">source_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SCD2 source data loaded&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span> <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">)</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;SCD2 could not determine source row count&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">valid_keys</span> <span class="o">=</span> <span class="n">SCD2Params</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">filtered_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_keys</span><span class="p">}</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">scd_params</span> <span class="o">=</span> <span class="n">SCD2Params</span><span class="p">(</span><span class="o">**</span><span class="n">filtered_params</span><span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="sa">f</span><span class="s2">&quot;SCD2 invalid parameters: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="n">params</span><span class="o">=</span><span class="n">filtered_params</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="sa">f</span><span class="s2">&quot;Invalid SCD2 parameters in node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="sa">f</span><span class="s2">&quot;Provided params: </span><span class="si">{</span><span class="n">filtered_params</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="sa">f</span><span class="s2">&quot;Valid param names: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">valid_keys</span><span class="p">)</span><span class="si">}</span><span class="s2">.&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">result_ctx</span> <span class="o">=</span> <span class="n">scd2</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">scd_params</span><span class="p">)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="sa">f</span><span class="s2">&quot;SCD2 pattern execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="k">raise</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_ctx</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>    <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="n">result_count</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;spark&quot;</span><span class="p">:</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>            <span class="n">result_count</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>            <span class="n">result_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>        <span class="k">pass</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="s2">&quot;SCD2 pattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">result_rows</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">valid_from_col</span><span class="o">=</span><span class="n">valid_from_col</span><span class="p">,</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">valid_to_col</span><span class="o">=</span><span class="n">valid_to_col</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="k">return</span> <span class="n">result_df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.scd2.SCD2Pattern.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

<a href="#odibi.patterns.scd2.SCD2Pattern.validate" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Validate SCD2 pattern configuration parameters.</p>
<p>Ensures that all required parameters are present for SCD Type 2 operations. Checks that:
- keys are provided (business keys to track changes)
- target is provided (existing dimension table for comparison)</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If keys are missing or target is missing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/scd2.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate SCD2 pattern configuration parameters.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Ensures that all required parameters are present for SCD Type 2 operations. Checks that:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    - keys are provided (business keys to track changes)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    - target is provided (existing dimension table for comparison)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        ValueError: If keys are missing or target is missing.</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="s2">&quot;SCD2Pattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">),</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">),</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>    <span class="p">)</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">):</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="s2">&quot;SCD2Pattern validation failed: &#39;keys&#39; parameter is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>        <span class="p">)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="sa">f</span><span class="s2">&quot;SCD2Pattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;keys&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="sa">f</span><span class="s2">&quot;Expected a list of business key column names, but got: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;keys&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="sa">f</span><span class="s2">&quot;Available params: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="s2">&quot;Fix: Provide &#39;keys&#39; as a list, e.g., keys=[&#39;customer_id&#39;].&quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>        <span class="p">)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">):</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>            <span class="s2">&quot;SCD2Pattern validation failed: &#39;target&#39; parameter is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>        <span class="p">)</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="sa">f</span><span class="s2">&quot;SCD2Pattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;target&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="sa">f</span><span class="s2">&quot;Expected a table name or path string, but got: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;target&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="s2">&quot;Fix: Provide &#39;target&#39; as a string, e.g., target=&#39;dim_customer&#39;.&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="p">)</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="s2">&quot;SCD2Pattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;SCD2Pattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">),</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">),</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="odibi.patterns.merge" class="doc doc-heading">
            <code>odibi.patterns.merge</code>


<a href="#odibi.patterns.merge" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="odibi.patterns.merge.MergePattern" class="doc doc-heading">
            <code>MergePattern</code>


<a href="#odibi.patterns.merge.MergePattern" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="odibi.patterns.base.Pattern">Pattern</span></code></p>



        <p>Merge Pattern: Upsert/Merge logic.</p>
<p>Configuration Options (via params dict):
    - <strong>target</strong> (str): Target table/path.
    - <strong>keys</strong> (list): Join keys.
    - <strong>strategy</strong> (str): 'upsert', 'append_only', 'delete_match'.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>odibi/patterns/merge.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">MergePattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Merge Pattern: Upsert/Merge logic.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Configuration Options (via params dict):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">        - **target** (str): Target table/path.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">        - **keys** (list): Join keys.</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">        - **strategy** (str): &#39;upsert&#39;, &#39;append_only&#39;, &#39;delete_match&#39;.</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate merge pattern configuration parameters.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        Ensures that all required parameters are present for merge operations. Checks that:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        - target (or path) is provided (destination table/path for merge)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        - keys are provided (columns to match source and target rows)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            ValueError: If target/path is missing or keys are missing.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>        <span class="c1"># Support both &#39;target&#39; and &#39;path&#39; for compatibility with merge transformer</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>            <span class="s2">&quot;MergePattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>            <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">),</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">),</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>        <span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>                <span class="s2">&quot;MergePattern validation failed: &#39;target&#39; or &#39;path&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>            <span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>            <span class="n">provided_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>                <span class="sa">f</span><span class="s2">&quot;MergePattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;target&#39; or &#39;path&#39; is required. &quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>                <span class="sa">f</span><span class="s2">&quot;Expected: A target table path string. &quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>                <span class="sa">f</span><span class="s2">&quot;Provided params: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">provided_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>                <span class="sa">f</span><span class="s2">&quot;Fix: Add &#39;target&#39; or &#39;path&#39; to your pattern configuration.&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>            <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>                <span class="s2">&quot;MergePattern validation failed: &#39;keys&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>            <span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>            <span class="n">source_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>                <span class="sa">f</span><span class="s2">&quot;MergePattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;keys&#39; is required. &quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>                <span class="sa">f</span><span class="s2">&quot;Expected: A list of column names to match source and target rows for merge. &quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>                <span class="sa">f</span><span class="s2">&quot;Available source columns: </span><span class="si">{</span><span class="n">source_columns</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>                <span class="sa">f</span><span class="s2">&quot;Fix: Add &#39;keys&#39; with columns that uniquely identify rows (e.g., keys=[&#39;id&#39;]).&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="s2">&quot;MergePattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">),</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">),</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;upsert&quot;</span><span class="p">),</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the merge pattern to upsert data into the target table.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">        Performs a merge/upsert operation by delegating to the merge transformer. The merge</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">        strategy determines the behavior:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">        - &#39;upsert&#39;: Insert new rows, update matching rows</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">        - &#39;append_only&#39;: Insert new rows only, never update</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">        - &#39;delete_match&#39;: Delete rows matching the keys</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">        The merge transformer handles loading the target table, comparing keys, and applying</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">        the specified merge strategy.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">            context: Engine context containing the source DataFrame and execution environment.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">            Source DataFrame (unchanged, as merge writes to target directly).</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">            Exception: If merge operation fails, target loading fails, or parameters are invalid.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="c1"># Support both &#39;target&#39; and &#39;path&#39; for compatibility</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;upsert&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="s2">&quot;Merge pattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="n">source_count</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;spark&quot;</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="n">source_count</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="n">source_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="s2">&quot;Merge source data loaded&quot;</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Merge could not determine source row count&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">valid_keys</span> <span class="o">=</span> <span class="n">MergeParams</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">filtered_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_keys</span><span class="p">}</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="n">merge</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">filtered_params</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="sa">f</span><span class="s2">&quot;Merge pattern execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>            <span class="k">raise</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="s2">&quot;Merge pattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>        <span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>        <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.merge.MergePattern.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

<a href="#odibi.patterns.merge.MergePattern.execute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Execute the merge pattern to upsert data into the target table.</p>
<p>Performs a merge/upsert operation by delegating to the merge transformer. The merge
strategy determines the behavior:
- 'upsert': Insert new rows, update matching rows
- 'append_only': Insert new rows only, never update
- 'delete_match': Delete rows matching the keys</p>
<p>The merge transformer handles loading the target table, comparing keys, and applying
the specified merge strategy.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="odibi.context.EngineContext">EngineContext</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine context containing the source DataFrame and execution environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Source DataFrame (unchanged, as merge writes to target directly).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If merge operation fails, target loading fails, or parameters are invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/merge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the merge pattern to upsert data into the target table.</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">    Performs a merge/upsert operation by delegating to the merge transformer. The merge</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">    strategy determines the behavior:</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">    - &#39;upsert&#39;: Insert new rows, update matching rows</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">    - &#39;append_only&#39;: Insert new rows only, never update</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    - &#39;delete_match&#39;: Delete rows matching the keys</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="sd">    The merge transformer handles loading the target table, comparing keys, and applying</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="sd">    the specified merge strategy.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        context: Engine context containing the source DataFrame and execution environment.</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        Source DataFrame (unchanged, as merge writes to target directly).</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        Exception: If merge operation fails, target loading fails, or parameters are invalid.</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="c1"># Support both &#39;target&#39; and &#39;path&#39; for compatibility</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">strategy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;upsert&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="s2">&quot;Merge pattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>    <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>    <span class="n">source_count</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="s2">&quot;spark&quot;</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">source_count</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">source_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="s2">&quot;Merge source data loaded&quot;</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>        <span class="p">)</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Merge could not determine source row count&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">)</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="n">valid_keys</span> <span class="o">=</span> <span class="n">MergeParams</span><span class="o">.</span><span class="n">model_fields</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="n">filtered_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">valid_keys</span><span class="p">}</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="n">merge</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="o">**</span><span class="n">filtered_params</span><span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="sa">f</span><span class="s2">&quot;Merge pattern execution failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>        <span class="k">raise</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>    <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>        <span class="s2">&quot;Merge pattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>        <span class="n">strategy</span><span class="o">=</span><span class="n">strategy</span><span class="p">,</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="p">)</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.merge.MergePattern.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

<a href="#odibi.patterns.merge.MergePattern.validate" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Validate merge pattern configuration parameters.</p>
<p>Ensures that all required parameters are present for merge operations. Checks that:
- target (or path) is provided (destination table/path for merge)
- keys are provided (columns to match source and target rows)</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If target/path is missing or keys are missing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/merge.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-20">20</a></span>
<span class="normal"><a href="#__codelineno-0-21">21</a></span>
<span class="normal"><a href="#__codelineno-0-22">22</a></span>
<span class="normal"><a href="#__codelineno-0-23">23</a></span>
<span class="normal"><a href="#__codelineno-0-24">24</a></span>
<span class="normal"><a href="#__codelineno-0-25">25</a></span>
<span class="normal"><a href="#__codelineno-0-26">26</a></span>
<span class="normal"><a href="#__codelineno-0-27">27</a></span>
<span class="normal"><a href="#__codelineno-0-28">28</a></span>
<span class="normal"><a href="#__codelineno-0-29">29</a></span>
<span class="normal"><a href="#__codelineno-0-30">30</a></span>
<span class="normal"><a href="#__codelineno-0-31">31</a></span>
<span class="normal"><a href="#__codelineno-0-32">32</a></span>
<span class="normal"><a href="#__codelineno-0-33">33</a></span>
<span class="normal"><a href="#__codelineno-0-34">34</a></span>
<span class="normal"><a href="#__codelineno-0-35">35</a></span>
<span class="normal"><a href="#__codelineno-0-36">36</a></span>
<span class="normal"><a href="#__codelineno-0-37">37</a></span>
<span class="normal"><a href="#__codelineno-0-38">38</a></span>
<span class="normal"><a href="#__codelineno-0-39">39</a></span>
<span class="normal"><a href="#__codelineno-0-40">40</a></span>
<span class="normal"><a href="#__codelineno-0-41">41</a></span>
<span class="normal"><a href="#__codelineno-0-42">42</a></span>
<span class="normal"><a href="#__codelineno-0-43">43</a></span>
<span class="normal"><a href="#__codelineno-0-44">44</a></span>
<span class="normal"><a href="#__codelineno-0-45">45</a></span>
<span class="normal"><a href="#__codelineno-0-46">46</a></span>
<span class="normal"><a href="#__codelineno-0-47">47</a></span>
<span class="normal"><a href="#__codelineno-0-48">48</a></span>
<span class="normal"><a href="#__codelineno-0-49">49</a></span>
<span class="normal"><a href="#__codelineno-0-50">50</a></span>
<span class="normal"><a href="#__codelineno-0-51">51</a></span>
<span class="normal"><a href="#__codelineno-0-52">52</a></span>
<span class="normal"><a href="#__codelineno-0-53">53</a></span>
<span class="normal"><a href="#__codelineno-0-54">54</a></span>
<span class="normal"><a href="#__codelineno-0-55">55</a></span>
<span class="normal"><a href="#__codelineno-0-56">56</a></span>
<span class="normal"><a href="#__codelineno-0-57">57</a></span>
<span class="normal"><a href="#__codelineno-0-58">58</a></span>
<span class="normal"><a href="#__codelineno-0-59">59</a></span>
<span class="normal"><a href="#__codelineno-0-60">60</a></span>
<span class="normal"><a href="#__codelineno-0-61">61</a></span>
<span class="normal"><a href="#__codelineno-0-62">62</a></span>
<span class="normal"><a href="#__codelineno-0-63">63</a></span>
<span class="normal"><a href="#__codelineno-0-64">64</a></span>
<span class="normal"><a href="#__codelineno-0-65">65</a></span>
<span class="normal"><a href="#__codelineno-0-66">66</a></span>
<span class="normal"><a href="#__codelineno-0-67">67</a></span>
<span class="normal"><a href="#__codelineno-0-68">68</a></span>
<span class="normal"><a href="#__codelineno-0-69">69</a></span>
<span class="normal"><a href="#__codelineno-0-70">70</a></span>
<span class="normal"><a href="#__codelineno-0-71">71</a></span>
<span class="normal"><a href="#__codelineno-0-72">72</a></span>
<span class="normal"><a href="#__codelineno-0-73">73</a></span>
<span class="normal"><a href="#__codelineno-0-74">74</a></span>
<span class="normal"><a href="#__codelineno-0-75">75</a></span>
<span class="normal"><a href="#__codelineno-0-76">76</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate merge pattern configuration parameters.</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    Ensures that all required parameters are present for merge operations. Checks that:</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">    - target (or path) is provided (destination table/path for merge)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    - keys are provided (columns to match source and target rows)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        ValueError: If target/path is missing or keys are missing.</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>    <span class="c1"># Support both &#39;target&#39; and &#39;path&#39; for compatibility with merge transformer</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a>    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a>        <span class="s2">&quot;MergePattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a>        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a>        <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">),</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a>        <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">),</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>    <span class="p">)</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">target</span><span class="p">:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a>            <span class="s2">&quot;MergePattern validation failed: &#39;target&#39; or &#39;path&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>        <span class="p">)</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>        <span class="n">provided_params</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">}</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>            <span class="sa">f</span><span class="s2">&quot;MergePattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;target&#39; or &#39;path&#39; is required. &quot;</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>            <span class="sa">f</span><span class="s2">&quot;Expected: A target table path string. &quot;</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a>            <span class="sa">f</span><span class="s2">&quot;Provided params: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">provided_params</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a>            <span class="sa">f</span><span class="s2">&quot;Fix: Add &#39;target&#39; or &#39;path&#39; to your pattern configuration.&quot;</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a>        <span class="p">)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">):</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>            <span class="s2">&quot;MergePattern validation failed: &#39;keys&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">source_columns</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="s2">&quot;columns&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="p">[]</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>            <span class="sa">f</span><span class="s2">&quot;MergePattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;keys&#39; is required. &quot;</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="sa">f</span><span class="s2">&quot;Expected: A list of column names to match source and target rows for merge. &quot;</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="sa">f</span><span class="s2">&quot;Available source columns: </span><span class="si">{</span><span class="n">source_columns</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="sa">f</span><span class="s2">&quot;Fix: Add &#39;keys&#39; with columns that uniquely identify rows (e.g., keys=[&#39;id&#39;]).&quot;</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="s2">&quot;MergePattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;MergePattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>        <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">),</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">keys</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">),</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">strategy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;upsert&quot;</span><span class="p">),</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="odibi.patterns.dimension" class="doc doc-heading">
            <code>odibi.patterns.dimension</code>


<a href="#odibi.patterns.dimension" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="odibi.patterns.dimension.AuditConfig" class="doc doc-heading">
            <code>AuditConfig</code>


<a href="#odibi.patterns.dimension.AuditConfig" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="pydantic.BaseModel">BaseModel</span></code></p>



        <p>Configuration for audit columns.</p>








              <details class="mkdocstrings-source">
                <summary>Source code in <code>odibi/patterns/dimension.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-14">14</a></span>
<span class="normal"><a href="#__codelineno-0-15">15</a></span>
<span class="normal"><a href="#__codelineno-0-16">16</a></span>
<span class="normal"><a href="#__codelineno-0-17">17</a></span>
<span class="normal"><a href="#__codelineno-0-18">18</a></span>
<span class="normal"><a href="#__codelineno-0-19">19</a></span>
<span class="normal"><a href="#__codelineno-0-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="k">class</span><span class="w"> </span><span class="nc">AuditConfig</span><span class="p">(</span><span class="n">BaseModel</span><span class="p">):</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Configuration for audit columns.&quot;&quot;&quot;</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a>    <span class="n">load_timestamp</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Add load_timestamp column&quot;</span><span class="p">)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a>    <span class="n">source_system</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Source system name for source_system column&quot;</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">












  </div>

    </div>

</div>

<div class="doc doc-object doc-class">



<h3 id="odibi.patterns.dimension.DimensionPattern" class="doc doc-heading">
            <code>DimensionPattern</code>


<a href="#odibi.patterns.dimension.DimensionPattern" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="odibi.patterns.base.Pattern">Pattern</span></code></p>



        <p>Dimension Pattern: Builds complete dimension tables with surrogate keys and SCD support.</p>
<p>Features:
- Auto-generate integer surrogate keys (MAX(existing) + ROW_NUMBER for new rows)
- SCD Type 0 (static), 1 (overwrite), 2 (history tracking)
- Optional unknown member row (SK=0) for orphan FK handling
- Audit columns (load_timestamp, source_system)</p>
<p>Configuration Options (via params dict):
    - <strong>natural_key</strong> (str): Natural/business key column name
    - <strong>surrogate_key</strong> (str): Surrogate key column name to generate
    - <strong>scd_type</strong> (int): 0=static, 1=overwrite, 2=history tracking (default: 1)
    - <strong>track_cols</strong> (list): Columns to track for SCD1/2 changes
    - <strong>target</strong> (str): Target table path (required for SCD2 to read existing history)
    - <strong>unknown_member</strong> (bool): If true, insert a row with SK=0 for orphan FK handling
    - <strong>audit</strong> (dict): Audit configuration with load_timestamp and source_system</p>


<details class="supported-target-formats" open>
  <summary>Supported target formats</summary>
  <p>Spark:
    - Catalog tables: catalog.schema.table, warehouse.dim_customer
    - Delta paths: /path/to/delta (no extension)
    - Parquet: /path/to/file.parquet
    - CSV: /path/to/file.csv
    - JSON: /path/to/file.json
    - ORC: /path/to/file.orc
Pandas:
    - Parquet: path/to/file.parquet (or directory)
    - CSV: path/to/file.csv
    - JSON: path/to/file.json
    - Excel: path/to/file.xlsx, path/to/file.xls
    - Feather/Arrow: path/to/file.feather, path/to/file.arrow
    - Pickle: path/to/file.pickle, path/to/file.pkl
    - Connection-prefixed: warehouse.dim_customer</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>odibi/patterns/dimension.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="k">class</span><span class="w"> </span><span class="nc">DimensionPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">    Dimension Pattern: Builds complete dimension tables with surrogate keys and SCD support.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Features:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    - Auto-generate integer surrogate keys (MAX(existing) + ROW_NUMBER for new rows)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">    - SCD Type 0 (static), 1 (overwrite), 2 (history tracking)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">    - Optional unknown member row (SK=0) for orphan FK handling</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">    - Audit columns (load_timestamp, source_system)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">    Configuration Options (via params dict):</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        - **natural_key** (str): Natural/business key column name</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        - **surrogate_key** (str): Surrogate key column name to generate</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        - **scd_type** (int): 0=static, 1=overwrite, 2=history tracking (default: 1)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        - **track_cols** (list): Columns to track for SCD1/2 changes</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        - **target** (str): Target table path (required for SCD2 to read existing history)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        - **unknown_member** (bool): If true, insert a row with SK=0 for orphan FK handling</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        - **audit** (dict): Audit configuration with load_timestamp and source_system</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">    Supported target formats:</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        Spark:</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">            - Catalog tables: catalog.schema.table, warehouse.dim_customer</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">            - Delta paths: /path/to/delta (no extension)</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            - Parquet: /path/to/file.parquet</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            - CSV: /path/to/file.csv</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">            - JSON: /path/to/file.json</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">            - ORC: /path/to/file.orc</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        Pandas:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">            - Parquet: path/to/file.parquet (or directory)</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">            - CSV: path/to/file.csv</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">            - JSON: path/to/file.json</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            - Excel: path/to/file.xlsx, path/to/file.xls</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">            - Feather/Arrow: path/to/file.feather, path/to/file.arrow</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">            - Pickle: path/to/file.pickle, path/to/file.pkl</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">            - Connection-prefixed: warehouse.dim_customer</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate dimension pattern configuration parameters.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">        Ensures that all required parameters are present and valid. Checks that:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">        - natural_key is provided (business key column(s))</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">        - surrogate_key is provided (auto-generated primary key column name)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">        - scd_type is valid (0, 1, or 2)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">        - target is provided for SCD Type 2 (required for history comparison)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">        - track_cols is provided for SCD Type 1 and 2 (columns to monitor for changes)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">            ValueError: If natural_key or surrogate_key is missing, scd_type is invalid,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">                target is missing for SCD2, or track_cols is missing for SCD1/2.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="s2">&quot;DimensionPattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>        <span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;natural_key&quot;</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>                <span class="s2">&quot;DimensionPattern validation failed: &#39;natural_key&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>                <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;natural_key&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="s2">&quot;The natural_key identifies the business key column(s) that uniquely identify &quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="s2">&quot;each dimension record in the source system. &quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="s2">&quot;Provide natural_key as a string (single column) or list of strings (composite key).&quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;surrogate_key&quot;</span><span class="p">):</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>                <span class="s2">&quot;DimensionPattern validation failed: &#39;surrogate_key&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>            <span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;surrogate_key&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="s2">&quot;The surrogate_key is the auto-generated primary key column for the dimension table, &quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="s2">&quot;used to join with fact tables instead of the natural key. &quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="s2">&quot;Provide surrogate_key as a string specifying the column name (e.g., &#39;customer_sk&#39;).&quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">scd_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scd_type&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="k">if</span> <span class="n">scd_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="sa">f</span><span class="s2">&quot;DimensionPattern validation failed: invalid scd_type </span><span class="si">{</span><span class="n">scd_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;scd_type&#39; must be 0, 1, or 2. Got: </span><span class="si">{</span><span class="n">scd_type</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="s2">&quot;SCD Type 0: No changes tracked (static dimension). &quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>                <span class="s2">&quot;SCD Type 1: Overwrite changes (no history). &quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="s2">&quot;SCD Type 2: Track full history with valid_from/valid_to dates.&quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="k">if</span> <span class="n">scd_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">):</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="s2">&quot;DimensionPattern validation failed: &#39;target&#39; required for SCD2&quot;</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>                <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;target&#39; parameter is required for scd_type=2. &quot;</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>                <span class="s2">&quot;SCD Type 2 compares incoming data against existing records to detect changes, &quot;</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="s2">&quot;so a target DataFrame containing current dimension data must be provided. &quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="s2">&quot;Pass the existing dimension table as the &#39;target&#39; parameter.&quot;</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">if</span> <span class="n">scd_type</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_cols&quot;</span><span class="p">):</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="s2">&quot;DimensionPattern validation failed: &#39;track_cols&#39; required for SCD1/2&quot;</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>            <span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>                <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;track_cols&#39; parameter is required for scd_type 1 or 2. &quot;</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="s2">&quot;The track_cols specifies which columns to monitor for changes. &quot;</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="s2">&quot;When these columns change, SCD1 overwrites values or SCD2 creates new history records. &quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="s2">&quot;Provide track_cols as a list of column names (e.g., [&#39;address&#39;, &#39;phone&#39;, &#39;email&#39;]).&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>            <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="s2">&quot;DimensionPattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>        <span class="p">)</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the dimension pattern to build a dimension table with surrogate keys.</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        Builds a complete dimension table with auto-generated surrogate keys and optional</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">        slowly changing dimension (SCD) support. The execution flow varies by SCD type:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        - SCD Type 0: Insert new records only, never update existing</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        - SCD Type 1: Update existing records in-place, insert new records</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">        - SCD Type 2: Track full history with valid_from/valid_to dates and is_current flag</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        All modes generate surrogate keys starting from MAX(existing_sk) + 1 for new records.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        Optionally adds audit columns and ensures unknown member row (SK=0) exists.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">            context: Engine context containing the source DataFrame and execution environment.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">            DataFrame with surrogate keys assigned and SCD logic applied as configured.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">            Exception: If target loading fails, SCD processing fails, or surrogate key</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">                generation encounters errors.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">natural_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;natural_key&quot;</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">surrogate_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;surrogate_key&quot;</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="n">scd_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scd_type&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">track_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_cols&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="n">unknown_member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unknown_member&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="n">audit_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audit&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>            <span class="s2">&quot;DimensionPattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="n">natural_key</span><span class="o">=</span><span class="n">natural_key</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="n">surrogate_key</span><span class="o">=</span><span class="n">surrogate_key</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">scd_type</span><span class="o">=</span><span class="n">scd_type</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">track_cols</span><span class="o">=</span><span class="n">track_cols</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="n">unknown_member</span><span class="o">=</span><span class="n">unknown_member</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">source_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dimension source loaded&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span> <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="k">if</span> <span class="n">scd_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scd0</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="k">elif</span> <span class="n">scd_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scd1</span><span class="p">(</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                    <span class="n">context</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">track_cols</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>                <span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scd2</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="n">context</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">track_cols</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_audit_columns</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">audit_config</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="k">if</span> <span class="n">unknown_member</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_unknown_member</span><span class="p">(</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                    <span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">audit_config</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>                <span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">result_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="s2">&quot;DimensionPattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>                <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>                <span class="n">result_rows</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>                <span class="n">scd_type</span><span class="o">=</span><span class="n">scd_type</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="k">return</span> <span class="n">result_df</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>                <span class="sa">f</span><span class="s2">&quot;DimensionPattern failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>            <span class="k">raise</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_max_sk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">engine_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get the maximum surrogate key value from existing data.&quot;&quot;&quot;</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="k">if</span> <span class="n">df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>            <span class="k">return</span> <span class="mi">0</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="k">if</span> <span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                <span class="n">max_row</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">surrogate_key</span><span class="p">))</span><span class="o">.</span><span class="n">collect</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">max_row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="k">return</span> <span class="n">max_val</span> <span class="k">if</span> <span class="n">max_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>                <span class="k">if</span> <span class="n">surrogate_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>                    <span class="k">return</span> <span class="mi">0</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="n">max_val</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">max_val</span><span class="p">)</span> <span class="k">if</span> <span class="n">max_val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span><span class="n">max_val</span> <span class="o">!=</span> <span class="n">max_val</span><span class="p">)</span> <span class="k">else</span> <span class="mi">0</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="k">return</span> <span class="mi">0</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_surrogate_keys</span><span class="p">(</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">natural_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">surrogate_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">start_sk</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>    <span class="p">):</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate surrogate keys starting from start_sk + 1.&quot;&quot;&quot;</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.window</span><span class="w"> </span><span class="kn">import</span> <span class="n">Window</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">natural_key</span><span class="p">)</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>                <span class="n">surrogate_key</span><span class="p">,</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">start_sk</span><span class="p">))</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="p">)</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="n">natural_key</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="n">df</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">start_sk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">start_sk</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">))</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="n">df</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;int64&quot;</span><span class="p">)</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_scd0</span><span class="p">(</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="n">natural_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="n">surrogate_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>    <span class="p">):</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a><span class="sd">        SCD Type 0: Static dimension - never update existing records.</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a><span class="sd">        Only insert new records that don&#39;t exist in target.</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">existing_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_existing_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">if</span> <span class="n">target</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="n">source_df</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="k">if</span> <span class="n">existing_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surrogate_keys</span><span class="p">(</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">source_df</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">start_sk</span><span class="o">=</span><span class="mi">0</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>        <span class="n">max_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_max_sk</span><span class="p">(</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>            <span class="n">existing_keys</span> <span class="o">=</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">natural_key</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">new_records</span> <span class="o">=</span> <span class="n">source_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">existing_keys</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">natural_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left_anti&quot;</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="n">existing_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">existing_df</span><span class="p">[</span><span class="n">natural_key</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>            <span class="n">new_records</span> <span class="o">=</span> <span class="n">source_df</span><span class="p">[</span><span class="o">~</span><span class="n">source_df</span><span class="p">[</span><span class="n">natural_key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">existing_keys</span><span class="p">)]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">new_records</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>            <span class="k">return</span> <span class="n">existing_df</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="n">new_with_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surrogate_keys</span><span class="p">(</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>            <span class="n">context</span><span class="p">,</span> <span class="n">new_records</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">start_sk</span><span class="o">=</span><span class="n">max_sk</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="p">)</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>            <span class="k">return</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">new_with_sk</span><span class="p">,</span> <span class="n">allowMissingColumns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">new_with_sk</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_scd1</span><span class="p">(</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="n">natural_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="n">surrogate_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="n">track_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="n">target</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>    <span class="p">):</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a><span class="sd">        SCD Type 1: Overwrite changes - no history tracking.</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a><span class="sd">        Update existing records in place, insert new records.</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>        <span class="n">existing_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_existing_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="k">if</span> <span class="n">target</span> <span class="k">else</span> <span class="kc">None</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="n">source_df</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="k">if</span> <span class="n">existing_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surrogate_keys</span><span class="p">(</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">source_df</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">start_sk</span><span class="o">=</span><span class="mi">0</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>            <span class="p">)</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">max_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_max_sk</span><span class="p">(</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scd1_spark</span><span class="p">(</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">source_df</span><span class="p">,</span> <span class="n">existing_df</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">track_cols</span><span class="p">,</span> <span class="n">max_sk</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="p">)</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scd1_pandas</span><span class="p">(</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">source_df</span><span class="p">,</span> <span class="n">existing_df</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">track_cols</span><span class="p">,</span> <span class="n">max_sk</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_scd1_spark</span><span class="p">(</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">source_df</span><span class="p">,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="n">existing_df</span><span class="p">,</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="n">natural_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="n">surrogate_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">track_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="n">max_sk</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>    <span class="p">):</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="n">t_prefix</span> <span class="o">=</span> <span class="s2">&quot;__existing_&quot;</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>        <span class="n">renamed_existing</span> <span class="o">=</span> <span class="n">existing_df</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="n">renamed_existing</span> <span class="o">=</span> <span class="n">renamed_existing</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_prefix</span><span class="si">}{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>        <span class="n">joined</span> <span class="o">=</span> <span class="n">source_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="n">renamed_existing</span><span class="p">,</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="n">source_df</span><span class="p">[</span><span class="n">natural_key</span><span class="p">]</span> <span class="o">==</span> <span class="n">renamed_existing</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_prefix</span><span class="si">}{</span><span class="n">natural_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>            <span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>        <span class="p">)</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>        <span class="n">new_records</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_prefix</span><span class="si">}{</span><span class="n">natural_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>            <span class="n">source_df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>        <span class="p">)</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="n">update_records</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_prefix</span><span class="si">}{</span><span class="n">natural_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isNotNull</span><span class="p">())</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>        <span class="n">update_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_prefix</span><span class="si">}{</span><span class="n">surrogate_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">surrogate_key</span><span class="p">)]</span> <span class="o">+</span> <span class="p">[</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">source_df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>        <span class="p">]</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>        <span class="n">updated_records</span> <span class="o">=</span> <span class="n">update_records</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">update_cols</span><span class="p">)</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>        <span class="n">unchanged_keys</span> <span class="o">=</span> <span class="n">update_records</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">t_prefix</span><span class="si">}{</span><span class="n">natural_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">natural_key</span><span class="p">))</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>        <span class="n">unchanged</span> <span class="o">=</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">unchanged_keys</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">natural_key</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left_anti&quot;</span><span class="p">)</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>        <span class="n">new_with_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surrogate_keys</span><span class="p">(</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="n">context</span><span class="p">,</span> <span class="n">new_records</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">start_sk</span><span class="o">=</span><span class="n">max_sk</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="p">)</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">unchanged</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">updated_records</span><span class="p">,</span> <span class="n">allowMissingColumns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="n">new_with_sk</span><span class="p">,</span> <span class="n">allowMissingColumns</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="p">)</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_scd1_pandas</span><span class="p">(</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="n">source_df</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="n">existing_df</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">natural_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>        <span class="n">surrogate_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>        <span class="n">track_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>        <span class="n">max_sk</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>    <span class="p">):</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>        <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>            <span class="n">source_df</span><span class="p">,</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="n">existing_df</span><span class="p">[[</span><span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">]],</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="n">on</span><span class="o">=</span><span class="n">natural_key</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;_existing&quot;</span><span class="p">),</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>        <span class="p">)</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>        <span class="n">has_existing_sk</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">surrogate_key</span><span class="si">}</span><span class="s2">_existing&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>        <span class="k">if</span> <span class="n">has_existing_sk</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>            <span class="n">merged</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">surrogate_key</span><span class="si">}</span><span class="s2">_existing&quot;</span><span class="p">]</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>            <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">surrogate_key</span><span class="si">}</span><span class="s2">_existing&quot;</span><span class="p">])</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="n">new_mask</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>        <span class="n">new_records</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">new_mask</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">])</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>        <span class="n">existing_records</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="o">~</span><span class="n">new_mask</span><span class="p">]</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">new_records</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>            <span class="n">new_with_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_surrogate_keys</span><span class="p">(</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">new_records</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">start_sk</span><span class="o">=</span><span class="n">max_sk</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>            <span class="p">)</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>            <span class="n">new_with_sk</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>        <span class="n">unchanged</span> <span class="o">=</span> <span class="n">existing_df</span><span class="p">[</span><span class="o">~</span><span class="n">existing_df</span><span class="p">[</span><span class="n">natural_key</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">source_df</span><span class="p">[</span><span class="n">natural_key</span><span class="p">])]</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">unchanged</span><span class="p">,</span> <span class="n">existing_records</span><span class="p">,</span> <span class="n">new_with_sk</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_execute_scd2</span><span class="p">(</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="n">natural_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="n">surrogate_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="n">track_cols</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="p">):</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a><span class="sd">        SCD Type 2: History tracking - reuse existing scd2 transformer.</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a><span class="sd">        Surrogate keys are generated for new/changed records.</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="n">existing_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_existing_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>        <span class="n">valid_from_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_from_col&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_from&quot;</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>        <span class="n">valid_to_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_to_col&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_to&quot;</span><span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="n">is_current_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_current_col&quot;</span><span class="p">,</span> <span class="s2">&quot;is_current&quot;</span><span class="p">)</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="n">source_with_time</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">valid_from_col</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">())</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>            <span class="n">source_df</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>            <span class="c1"># Use timezone-aware timestamp for Delta Lake compatibility</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>            <span class="n">source_df</span><span class="p">[</span><span class="n">valid_from_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>            <span class="n">source_with_time</span> <span class="o">=</span> <span class="n">source_df</span>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">temp_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">with_df</span><span class="p">(</span><span class="n">source_with_time</span><span class="p">)</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>        <span class="n">scd_params</span> <span class="o">=</span> <span class="n">SCD2Params</span><span class="p">(</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>            <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="n">keys</span><span class="o">=</span><span class="p">[</span><span class="n">natural_key</span><span class="p">],</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>            <span class="n">track_cols</span><span class="o">=</span><span class="n">track_cols</span><span class="p">,</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>            <span class="n">effective_time_col</span><span class="o">=</span><span class="n">valid_from_col</span><span class="p">,</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="n">end_time_col</span><span class="o">=</span><span class="n">valid_to_col</span><span class="p">,</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>            <span class="n">current_flag_col</span><span class="o">=</span><span class="n">is_current_col</span><span class="p">,</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="p">)</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>        <span class="n">result_context</span> <span class="o">=</span> <span class="n">scd2</span><span class="p">(</span><span class="n">temp_context</span><span class="p">,</span> <span class="n">scd_params</span><span class="p">)</span>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_context</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>        <span class="n">max_sk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_max_sk</span><span class="p">(</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.window</span><span class="w"> </span><span class="kn">import</span> <span class="n">Window</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>            <span class="k">if</span> <span class="n">surrogate_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">natural_key</span><span class="p">,</span> <span class="n">valid_from_col</span><span class="p">)</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>                    <span class="n">surrogate_key</span><span class="p">,</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">max_sk</span><span class="p">))</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>                <span class="p">)</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>                <span class="n">null_sk_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">surrogate_key</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">())</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>                <span class="n">has_sk_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">surrogate_key</span><span class="p">)</span><span class="o">.</span><span class="n">isNotNull</span><span class="p">())</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>                <span class="k">if</span> <span class="n">null_sk_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>                    <span class="n">window</span> <span class="o">=</span> <span class="n">Window</span><span class="o">.</span><span class="n">orderBy</span><span class="p">(</span><span class="n">natural_key</span><span class="p">,</span> <span class="n">valid_from_col</span><span class="p">)</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>                    <span class="n">null_sk_df</span> <span class="o">=</span> <span class="n">null_sk_df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>                        <span class="n">surrogate_key</span><span class="p">,</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">row_number</span><span class="p">()</span><span class="o">.</span><span class="n">over</span><span class="p">(</span><span class="n">window</span><span class="p">)</span> <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">max_sk</span><span class="p">))</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="s2">&quot;int&quot;</span><span class="p">)</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>                    <span class="p">)</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">has_sk_df</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">null_sk_df</span><span class="p">)</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>            <span class="k">if</span> <span class="n">surrogate_key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">result_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">natural_key</span><span class="p">,</span> <span class="n">valid_from_col</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>                    <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>                <span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>                <span class="n">result_df</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_sk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_sk</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">result_df</span><span class="p">))</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>                <span class="n">null_mask</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                <span class="k">if</span> <span class="n">null_mask</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>                    <span class="n">null_df</span> <span class="o">=</span> <span class="n">result_df</span><span class="p">[</span><span class="n">null_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>                    <span class="n">null_df</span> <span class="o">=</span> <span class="n">null_df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="n">natural_key</span><span class="p">,</span> <span class="n">valid_from_col</span><span class="p">])</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                        <span class="n">drop</span><span class="o">=</span><span class="kc">True</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                    <span class="p">)</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>                    <span class="n">null_df</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_sk</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">max_sk</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="nb">len</span><span class="p">(</span><span class="n">null_df</span><span class="p">))</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                    <span class="n">result_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">result_df</span><span class="p">[</span><span class="o">~</span><span class="n">null_mask</span><span class="p">],</span> <span class="n">null_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>        <span class="k">return</span> <span class="n">result_df</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add_audit_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">audit_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add audit columns with load_timestamp defaulting to True for dimensions.&quot;&quot;&quot;</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>        <span class="n">config</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">audit_config</span><span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>        <span class="n">config</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s2">&quot;load_timestamp&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">_add_audit_columns</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">config</span><span class="p">)</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_ensure_unknown_member</span><span class="p">(</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>        <span class="n">natural_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>        <span class="n">surrogate_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>        <span class="n">audit_config</span><span class="p">:</span> <span class="nb">dict</span><span class="p">,</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>    <span class="p">):</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Ensure unknown member row exists with SK=0.</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a><span class="sd">        The unknown member is a special dimension row used to handle orphan facts</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a><span class="sd">        where the dimension lookup fails. It has a surrogate key of 0 and</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a><span class="sd">        standard &#39;Unknown&#39; placeholder values.</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">            context: Engine context containing engine type and configuration.</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a><span class="sd">            df: The dimension DataFrame to ensure unknown member in.</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><span class="sd">            natural_key: The natural key column name.</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">            surrogate_key: The surrogate key column name.</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">            audit_config: Audit configuration for source_system value.</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">            DataFrame with unknown member row added if not already present.</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>        <span class="n">valid_from_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_from_col&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_from&quot;</span><span class="p">)</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>        <span class="n">valid_to_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;valid_to_col&quot;</span><span class="p">,</span> <span class="s2">&quot;valid_to&quot;</span><span class="p">)</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>        <span class="n">is_current_col</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_current_col&quot;</span><span class="p">,</span> <span class="s2">&quot;is_current&quot;</span><span class="p">)</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>            <span class="n">existing_unknown</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">surrogate_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>            <span class="k">if</span> <span class="n">existing_unknown</span><span class="o">.</span><span class="n">count</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>                <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>            <span class="n">columns</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a>            <span class="n">unknown_values</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a>                <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">surrogate_key</span><span class="p">:</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a>                    <span class="n">unknown_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">natural_key</span><span class="p">:</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a>                    <span class="n">unknown_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">)</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">valid_from_col</span><span class="p">:</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>                    <span class="n">unknown_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">valid_to_col</span><span class="p">:</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>                    <span class="n">unknown_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">is_current_col</span><span class="p">:</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>                    <span class="n">unknown_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;load_timestamp&quot;</span><span class="p">:</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a>                    <span class="c1"># Use timezone-aware timestamp for Delta Lake compatibility</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>                    <span class="n">unknown_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">))</span>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;source_system&quot;</span><span class="p">:</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a>                    <span class="n">unknown_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">audit_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_system&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">))</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a>                    <span class="n">unknown_values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>            <span class="n">unknown_row</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span><span class="n">unknown_values</span><span class="p">],</span> <span class="n">columns</span><span class="p">)</span>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a>            <span class="k">return</span> <span class="n">unknown_row</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="k">if</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">surrogate_key</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>                <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>            <span class="n">unknown_row</span> <span class="o">=</span> <span class="p">{}</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>                <span class="k">if</span> <span class="n">col</span> <span class="o">==</span> <span class="n">surrogate_key</span><span class="p">:</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>                    <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">natural_key</span><span class="p">:</span>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>                    <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;-1&quot;</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">valid_from_col</span><span class="p">:</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>                    <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">tzinfo</span><span class="o">=</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">valid_to_col</span><span class="p">:</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a>                    <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="n">is_current_col</span><span class="p">:</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a>                    <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;load_timestamp&quot;</span><span class="p">:</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>                    <span class="c1"># Use timezone-aware timestamp for Delta Lake compatibility</span>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a>                    <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a>                <span class="k">elif</span> <span class="n">col</span> <span class="o">==</span> <span class="s2">&quot;source_system&quot;</span><span class="p">:</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a>                    <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">audit_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;source_system&quot;</span><span class="p">,</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">)</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>                    <span class="n">dtype</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>                    <span class="k">if</span> <span class="n">pd</span><span class="o">.</span><span class="n">api</span><span class="o">.</span><span class="n">types</span><span class="o">.</span><span class="n">is_numeric_dtype</span><span class="p">(</span><span class="n">dtype</span><span class="p">):</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>                        <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>                        <span class="n">unknown_row</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Unknown&quot;</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a>            <span class="n">unknown_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">unknown_row</span><span class="p">])</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">unknown_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a>                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>                        <span class="n">unknown_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">unknown_df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>                        <span class="k">pass</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">unknown_df</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.dimension.DimensionPattern.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

<a href="#odibi.patterns.dimension.DimensionPattern.execute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Execute the dimension pattern to build a dimension table with surrogate keys.</p>
<p>Builds a complete dimension table with auto-generated surrogate keys and optional
slowly changing dimension (SCD) support. The execution flow varies by SCD type:
- SCD Type 0: Insert new records only, never update existing
- SCD Type 1: Update existing records in-place, insert new records
- SCD Type 2: Track full history with valid_from/valid_to dates and is_current flag</p>
<p>All modes generate surrogate keys starting from MAX(existing_sk) + 1 for new records.
Optionally adds audit columns and ensures unknown member row (SK=0) exists.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="odibi.context.EngineContext">EngineContext</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine context containing the source DataFrame and execution environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame with surrogate keys assigned and SCD logic applied as configured.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If target loading fails, SCD processing fails, or surrogate key
generation encounters errors.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/dimension.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the dimension pattern to build a dimension table with surrogate keys.</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">    Builds a complete dimension table with auto-generated surrogate keys and optional</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a><span class="sd">    slowly changing dimension (SCD) support. The execution flow varies by SCD type:</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">    - SCD Type 0: Insert new records only, never update existing</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">    - SCD Type 1: Update existing records in-place, insert new records</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="sd">    - SCD Type 2: Track full history with valid_from/valid_to dates and is_current flag</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    All modes generate surrogate keys starting from MAX(existing_sk) + 1 for new records.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    Optionally adds audit columns and ensures unknown member row (SK=0) exists.</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        context: Engine context containing the source DataFrame and execution environment.</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        DataFrame with surrogate keys assigned and SCD logic applied as configured.</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        Exception: If target loading fails, SCD processing fails, or surrogate key</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">            generation encounters errors.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">natural_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;natural_key&quot;</span><span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">surrogate_key</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;surrogate_key&quot;</span><span class="p">)</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="n">scd_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scd_type&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">track_cols</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_cols&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="n">unknown_member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unknown_member&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="n">audit_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audit&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>        <span class="s2">&quot;DimensionPattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="n">natural_key</span><span class="o">=</span><span class="n">natural_key</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">surrogate_key</span><span class="o">=</span><span class="n">surrogate_key</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">scd_type</span><span class="o">=</span><span class="n">scd_type</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">track_cols</span><span class="o">=</span><span class="n">track_cols</span><span class="p">,</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">target</span><span class="o">=</span><span class="n">target</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">unknown_member</span><span class="o">=</span><span class="n">unknown_member</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>    <span class="p">)</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="n">source_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Dimension source loaded&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span> <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">)</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="k">if</span> <span class="n">scd_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scd0</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="k">elif</span> <span class="n">scd_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scd1</span><span class="p">(</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">track_cols</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="p">)</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_execute_scd2</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">track_cols</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_audit_columns</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">audit_config</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">if</span> <span class="n">unknown_member</span><span class="p">:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ensure_unknown_member</span><span class="p">(</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">natural_key</span><span class="p">,</span> <span class="n">surrogate_key</span><span class="p">,</span> <span class="n">audit_config</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="p">)</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>        <span class="n">result_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="s2">&quot;DimensionPattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>            <span class="n">result_rows</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>            <span class="n">scd_type</span><span class="o">=</span><span class="n">scd_type</span><span class="p">,</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="k">return</span> <span class="n">result_df</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="sa">f</span><span class="s2">&quot;DimensionPattern failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="p">)</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.dimension.DimensionPattern.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

<a href="#odibi.patterns.dimension.DimensionPattern.validate" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Validate dimension pattern configuration parameters.</p>
<p>Ensures that all required parameters are present and valid. Checks that:
- natural_key is provided (business key column(s))
- surrogate_key is provided (auto-generated primary key column name)
- scd_type is valid (0, 1, or 2)
- target is provided for SCD Type 2 (required for history comparison)
- track_cols is provided for SCD Type 1 and 2 (columns to monitor for changes)</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If natural_key or surrogate_key is missing, scd_type is invalid,
target is missing for SCD2, or track_cols is missing for SCD1/2.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/dimension.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate dimension pattern configuration parameters.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">    Ensures that all required parameters are present and valid. Checks that:</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">    - natural_key is provided (business key column(s))</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">    - surrogate_key is provided (auto-generated primary key column name)</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">    - scd_type is valid (0, 1, or 2)</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a><span class="sd">    - target is provided for SCD Type 2 (required for history comparison)</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    - track_cols is provided for SCD Type 1 and 2 (columns to monitor for changes)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">        ValueError: If natural_key or surrogate_key is missing, scd_type is invalid,</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            target is missing for SCD2, or track_cols is missing for SCD1/2.</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="s2">&quot;DimensionPattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>        <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>    <span class="p">)</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;natural_key&quot;</span><span class="p">):</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="s2">&quot;DimensionPattern validation failed: &#39;natural_key&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>        <span class="p">)</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;natural_key&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="s2">&quot;The natural_key identifies the business key column(s) that uniquely identify &quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="s2">&quot;each dimension record in the source system. &quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="s2">&quot;Provide natural_key as a string (single column) or list of strings (composite key).&quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;surrogate_key&quot;</span><span class="p">):</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="s2">&quot;DimensionPattern validation failed: &#39;surrogate_key&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>        <span class="p">)</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;surrogate_key&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="s2">&quot;The surrogate_key is the auto-generated primary key column for the dimension table, &quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="s2">&quot;used to join with fact tables instead of the natural key. &quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>            <span class="s2">&quot;Provide surrogate_key as a string specifying the column name (e.g., &#39;customer_sk&#39;).&quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">scd_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scd_type&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>    <span class="k">if</span> <span class="n">scd_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">):</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="sa">f</span><span class="s2">&quot;DimensionPattern validation failed: invalid scd_type </span><span class="si">{</span><span class="n">scd_type</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="p">)</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;scd_type&#39; must be 0, 1, or 2. Got: </span><span class="si">{</span><span class="n">scd_type</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="s2">&quot;SCD Type 0: No changes tracked (static dimension). &quot;</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="s2">&quot;SCD Type 1: Overwrite changes (no history). &quot;</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="s2">&quot;SCD Type 2: Track full history with valid_from/valid_to dates.&quot;</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="p">)</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>    <span class="k">if</span> <span class="n">scd_type</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">):</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="s2">&quot;DimensionPattern validation failed: &#39;target&#39; required for SCD2&quot;</span><span class="p">,</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;target&#39; parameter is required for scd_type=2. &quot;</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="s2">&quot;SCD Type 2 compares incoming data against existing records to detect changes, &quot;</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="s2">&quot;so a target DataFrame containing current dimension data must be provided. &quot;</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="s2">&quot;Pass the existing dimension table as the &#39;target&#39; parameter.&quot;</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="p">)</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>    <span class="k">if</span> <span class="n">scd_type</span> <span class="ow">in</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;track_cols&quot;</span><span class="p">):</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="s2">&quot;DimensionPattern validation failed: &#39;track_cols&#39; required for SCD1/2&quot;</span><span class="p">,</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="p">)</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="sa">f</span><span class="s2">&quot;DimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;track_cols&#39; parameter is required for scd_type 1 or 2. &quot;</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="s2">&quot;The track_cols specifies which columns to monitor for changes. &quot;</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="s2">&quot;When these columns change, SCD1 overwrites values or SCD2 creates new history records. &quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>            <span class="s2">&quot;Provide track_cols as a list of column names (e.g., [&#39;address&#39;, &#39;phone&#39;, &#39;email&#39;]).&quot;</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>        <span class="p">)</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>        <span class="s2">&quot;DimensionPattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="odibi.patterns.date_dimension" class="doc doc-heading">
            <code>odibi.patterns.date_dimension</code>


<a href="#odibi.patterns.date_dimension" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="odibi.patterns.date_dimension.DateDimensionPattern" class="doc doc-heading">
            <code>DateDimensionPattern</code>


<a href="#odibi.patterns.date_dimension.DateDimensionPattern" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="odibi.patterns.base.Pattern">Pattern</span></code></p>



        <p>Date Dimension Pattern: Generates a complete date dimension table.</p>
<p>Creates a date dimension with pre-calculated attributes useful for
BI/reporting including day of week, quarter, fiscal year, etc.</p>
<p>Configuration Options (via params dict):
    - <strong>start_date</strong> (str): Start date in YYYY-MM-DD format
    - <strong>end_date</strong> (str): End date in YYYY-MM-DD format
    - <strong>date_key_format</strong> (str): Format for date_sk (default: "yyyyMMdd" -&gt; 20240115)
    - <strong>fiscal_year_start_month</strong> (int): Month when fiscal year starts (1-12, default: 1)
    - <strong>include_time</strong> (bool): If true, generate time dimension (not implemented yet)
    - <strong>unknown_member</strong> (bool): If true, add unknown date row with date_sk=0</p>


<details class="generated-columns" open>
  <summary>Generated Columns</summary>
  <ul>
<li>date_sk: Integer surrogate key (YYYYMMDD format)</li>
<li>full_date: The actual date</li>
<li>day_of_week: Day name (Monday, Tuesday, etc.)</li>
<li>day_of_week_num: Day number (1=Monday, 7=Sunday)</li>
<li>day_of_month: Day of month (1-31)</li>
<li>day_of_year: Day of year (1-366)</li>
<li>is_weekend: Boolean flag</li>
<li>week_of_year: ISO week number (1-53)</li>
<li>month: Month number (1-12)</li>
<li>month_name: Month name (January, February, etc.)</li>
<li>quarter: Calendar quarter (1-4)</li>
<li>quarter_name: Q1, Q2, Q3, Q4</li>
<li>year: Calendar year</li>
<li>fiscal_year: Fiscal year</li>
<li>fiscal_quarter: Fiscal quarter (1-4)</li>
<li>is_month_start: First day of month</li>
<li>is_month_end: Last day of month</li>
<li>is_year_start: First day of year</li>
<li>is_year_end: Last day of year</li>
</ul>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>odibi/patterns/date_dimension.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="k">class</span><span class="w"> </span><span class="nc">DateDimensionPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Date Dimension Pattern: Generates a complete date dimension table.</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    Creates a date dimension with pre-calculated attributes useful for</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    BI/reporting including day of week, quarter, fiscal year, etc.</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    Configuration Options (via params dict):</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">        - **start_date** (str): Start date in YYYY-MM-DD format</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        - **end_date** (str): End date in YYYY-MM-DD format</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        - **date_key_format** (str): Format for date_sk (default: &quot;yyyyMMdd&quot; -&gt; 20240115)</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        - **fiscal_year_start_month** (int): Month when fiscal year starts (1-12, default: 1)</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        - **include_time** (bool): If true, generate time dimension (not implemented yet)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        - **unknown_member** (bool): If true, add unknown date row with date_sk=0</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">    Generated Columns:</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        - date_sk: Integer surrogate key (YYYYMMDD format)</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        - full_date: The actual date</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">        - day_of_week: Day name (Monday, Tuesday, etc.)</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">        - day_of_week_num: Day number (1=Monday, 7=Sunday)</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        - day_of_month: Day of month (1-31)</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">        - day_of_year: Day of year (1-366)</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        - is_weekend: Boolean flag</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        - week_of_year: ISO week number (1-53)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">        - month: Month number (1-12)</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">        - month_name: Month name (January, February, etc.)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">        - quarter: Calendar quarter (1-4)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">        - quarter_name: Q1, Q2, Q3, Q4</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">        - year: Calendar year</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">        - fiscal_year: Fiscal year</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">        - fiscal_quarter: Fiscal quarter (1-4)</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        - is_month_start: First day of month</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        - is_month_end: Last day of month</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">        - is_year_start: First day of year</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">        - is_year_end: Last day of year</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate date dimension pattern configuration parameters.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        Ensures that all required parameters are present and valid. Checks that:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        - start_date is provided in YYYY-MM-DD format</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">        - end_date is provided in YYYY-MM-DD format</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">        - start_date is before or equal to end_date</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        - fiscal_year_start_month is an integer between 1-12 if provided</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">            ValueError: If required dates are missing, dates are invalid/unparseable,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">                start_date is after end_date, or fiscal_year_start_month is invalid.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="s2">&quot;DateDimensionPattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_date&quot;</span><span class="p">):</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>                <span class="s2">&quot;DateDimensionPattern validation failed: &#39;start_date&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>                <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;start_date&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                <span class="s2">&quot;Expected format: &#39;YYYY-MM-DD&#39; (e.g., &#39;2024-01-01&#39;). &quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="s2">&quot;Provide a valid start_date in params.&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_date&quot;</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>                <span class="s2">&quot;DateDimensionPattern validation failed: &#39;end_date&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>                <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;end_date&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="s2">&quot;Expected format: &#39;YYYY-MM-DD&#39; (e.g., &#39;2024-12-31&#39;). &quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="s2">&quot;Provide a valid end_date in params.&quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">])</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">])</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                    <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): start_date must be before or equal to end_date. &quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                    <span class="sa">f</span><span class="s2">&quot;Provided: start_date=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                    <span class="sa">f</span><span class="s2">&quot;end_date=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                    <span class="sa">f</span><span class="s2">&quot;Fix: Swap the values or adjust the date range.&quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): Invalid date parameters. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="sa">f</span><span class="s2">&quot;Provided: start_date=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_date&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="sa">f</span><span class="s2">&quot;end_date=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end_date&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="sa">f</span><span class="s2">&quot;Expected format: &#39;YYYY-MM-DD&#39;.&quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>            <span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">fiscal_month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fiscal_year_start_month&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fiscal_month</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fiscal_month</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fiscal_month</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="s2">&quot;DateDimensionPattern validation failed: invalid fiscal_year_start_month&quot;</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;fiscal_year_start_month&#39; must be an integer 1-12. &quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="sa">f</span><span class="s2">&quot;Provided: </span><span class="si">{</span><span class="n">fiscal_month</span><span class="si">!r}</span><span class="s2"> (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fiscal_month</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">). &quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>                <span class="sa">f</span><span class="s2">&quot;Use an integer like 1 for January or 7 for July.&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>            <span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="s2">&quot;DateDimensionPattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">date_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">date</span><span class="p">:</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a date string in YYYY-MM-DD format.&quot;&quot;&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">datetime</span><span class="p">)):</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>            <span class="k">return</span> <span class="n">date_str</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="k">else</span> <span class="n">date_str</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">return</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">date_str</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the date dimension pattern to generate a date dimension table.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">        Generates a complete date dimension table with pre-calculated date attributes for</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">        the specified date range. The execution flow:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">        1. Parse start_date and end_date parameters</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">        2. Generate one row per date in the range</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">        3. Calculate all date attributes (day_of_week, quarter, fiscal_year, etc.)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">        4. Add unknown member row (date_sk=0) if configured</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">        Generated columns include date_sk (surrogate key), full_date, day/week/month/quarter/year</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">        attributes, fiscal year/quarter, and boolean flags for period boundaries.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">            context: Engine context for DataFrame creation and execution environment.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">            DataFrame containing one row per date with all calculated date attributes.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">            Exception: If date parsing fails or DataFrame generation encounters errors.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>        <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">])</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>        <span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">])</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>        <span class="n">fiscal_year_start_month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fiscal_year_start_month&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>        <span class="n">unknown_member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unknown_member&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>            <span class="s2">&quot;DateDimensionPattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="n">start_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">),</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>            <span class="n">end_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">),</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>            <span class="n">fiscal_year_start_month</span><span class="o">=</span><span class="n">fiscal_year_start_month</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_spark</span><span class="p">(</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="n">context</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">fiscal_year_start_month</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                <span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pandas</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">fiscal_year_start_month</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>            <span class="k">if</span> <span class="n">unknown_member</span><span class="p">:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_unknown_member</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">row_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>                <span class="s2">&quot;DateDimensionPattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>                <span class="n">rows_generated</span><span class="o">=</span><span class="n">row_count</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>                <span class="n">start_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">),</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>                <span class="n">end_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">),</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>            <span class="k">return</span> <span class="n">result_df</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>            <span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="k">raise</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_row_count</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">engine_type</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]:</span>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="k">if</span> <span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_pandas</span><span class="p">(</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">fiscal_year_start_month</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate date dimension using Pandas.&quot;&quot;&quot;</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">dates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s2">&quot;D&quot;</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;full_date&quot;</span><span class="p">:</span> <span class="n">dates</span><span class="p">})</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;date_sk&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_of_week&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day_name</span><span class="p">()</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_of_week_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofweek</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_of_month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">day</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_of_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_weekend&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_of_week_num&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">])</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;week_of_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">isocalendar</span><span class="p">()</span><span class="o">.</span><span class="n">week</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;month_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">month_name</span><span class="p">()</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;quarter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">quarter</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;quarter_name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;Q&quot;</span> <span class="o">+</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;quarter&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">year</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fiscal_year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_fiscal_year</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">],</span> <span class="n">fiscal_year_start_month</span><span class="p">),</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>        <span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;fiscal_quarter&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="k">lambda</span> <span class="n">row</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_calc_fiscal_quarter</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">],</span> <span class="n">fiscal_year_start_month</span><span class="p">),</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="p">)</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_month_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">is_month_start</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_month_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">is_month_end</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_year_start&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_of_month&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;is_year_end&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;month&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s2">&quot;day_of_month&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">31</span><span class="p">)</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;full_date&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">column_order</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>            <span class="s2">&quot;date_sk&quot;</span><span class="p">,</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>            <span class="s2">&quot;full_date&quot;</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>            <span class="s2">&quot;day_of_week&quot;</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>            <span class="s2">&quot;day_of_week_num&quot;</span><span class="p">,</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>            <span class="s2">&quot;day_of_month&quot;</span><span class="p">,</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>            <span class="s2">&quot;day_of_year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>            <span class="s2">&quot;is_weekend&quot;</span><span class="p">,</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="s2">&quot;week_of_year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="s2">&quot;month&quot;</span><span class="p">,</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>            <span class="s2">&quot;month_name&quot;</span><span class="p">,</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="s2">&quot;quarter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="s2">&quot;quarter_name&quot;</span><span class="p">,</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="s2">&quot;year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="s2">&quot;fiscal_year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>            <span class="s2">&quot;fiscal_quarter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="s2">&quot;is_month_start&quot;</span><span class="p">,</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="s2">&quot;is_month_end&quot;</span><span class="p">,</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="s2">&quot;is_year_start&quot;</span><span class="p">,</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="s2">&quot;is_year_end&quot;</span><span class="p">,</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="p">]</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>        <span class="k">return</span> <span class="n">df</span><span class="p">[</span><span class="n">column_order</span><span class="p">]</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_fiscal_year</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fiscal_start_month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate fiscal year based on fiscal start month.&quot;&quot;&quot;</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">):</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>            <span class="n">month</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="n">year</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>            <span class="n">month</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="n">year</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">year</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>        <span class="k">if</span> <span class="n">fiscal_start_month</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="k">return</span> <span class="n">year</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="k">if</span> <span class="n">month</span> <span class="o">&gt;=</span> <span class="n">fiscal_start_month</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="k">return</span> <span class="n">year</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>        <span class="k">return</span> <span class="n">year</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_calc_fiscal_quarter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">fiscal_start_month</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">int</span><span class="p">:</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Calculate fiscal quarter based on fiscal start month.&quot;&quot;&quot;</span>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dt</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Timestamp</span><span class="p">):</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>            <span class="n">month</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">month</span> <span class="o">=</span> <span class="n">dt</span><span class="o">.</span><span class="n">month</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">adjusted_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">month</span> <span class="o">-</span> <span class="n">fiscal_start_month</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">adjusted_month</span> <span class="o">//</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_spark</span><span class="p">(</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">start_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">:</span> <span class="n">date</span><span class="p">,</span> <span class="n">fiscal_year_start_month</span><span class="p">:</span> <span class="nb">int</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>    <span class="p">):</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate date dimension using Spark.&quot;&quot;&quot;</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql.types</span><span class="w"> </span><span class="kn">import</span> <span class="n">IntegerType</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="n">spark</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spark</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>        <span class="n">num_days</span> <span class="o">=</span> <span class="p">(</span><span class="n">end_date</span> <span class="o">-</span> <span class="n">start_date</span><span class="p">)</span><span class="o">.</span><span class="n">days</span> <span class="o">+</span> <span class="mi">1</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a>        <span class="n">start_date_str</span> <span class="o">=</span> <span class="n">start_date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">range</span><span class="p">(</span><span class="n">num_days</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>            <span class="n">F</span><span class="o">.</span><span class="n">date_add</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">start_date_str</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">()))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="p">)</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;date_sk&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">date_format</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">,</span> <span class="s2">&quot;yyyyMMdd&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">()))</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;day_of_week&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">date_format</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">,</span> <span class="s2">&quot;EEEE&quot;</span><span class="p">))</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;day_of_week_num&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">dayofweek</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">))</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="s2">&quot;day_of_week_num&quot;</span><span class="p">,</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;day_of_week_num&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;day_of_week_num&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;day_of_month&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">dayofmonth</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">))</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;day_of_year&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">dayofyear</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">))</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;is_weekend&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;day_of_week_num&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">isin</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">]))</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;week_of_year&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">weekofyear</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">))</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">month</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">))</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;month_name&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">date_format</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">,</span> <span class="s2">&quot;MMMM&quot;</span><span class="p">))</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;quarter&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">quarter</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">))</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;quarter_name&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="s2">&quot;Q&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quarter&quot;</span><span class="p">)))</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">year</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">))</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>        <span class="k">if</span> <span class="n">fiscal_year_start_month</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;fiscal_year&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">))</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;fiscal_quarter&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;quarter&quot;</span><span class="p">))</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>                <span class="s2">&quot;fiscal_year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>                <span class="n">F</span><span class="o">.</span><span class="n">when</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">fiscal_year_start_month</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">otherwise</span><span class="p">(</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;year&quot;</span><span class="p">)</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>                <span class="p">),</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>            <span class="p">)</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>            <span class="n">adjusted_month</span> <span class="o">=</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span> <span class="o">-</span> <span class="n">fiscal_year_start_month</span> <span class="o">+</span> <span class="mi">12</span><span class="p">)</span> <span class="o">%</span> <span class="mi">12</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;fiscal_quarter&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">adjusted_month</span> <span class="o">/</span> <span class="mi">3</span><span class="p">)</span><span class="o">.</span><span class="n">cast</span><span class="p">(</span><span class="n">IntegerType</span><span class="p">())</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>            <span class="s2">&quot;is_month_start&quot;</span><span class="p">,</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>            <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;day_of_month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="p">)</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="s2">&quot;is_month_end&quot;</span><span class="p">,</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>            <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">F</span><span class="o">.</span><span class="n">last_day</span><span class="p">(</span><span class="s2">&quot;full_date&quot;</span><span class="p">),</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="p">)</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="s2">&quot;is_year_start&quot;</span><span class="p">,</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>            <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;day_of_month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>        <span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>            <span class="s2">&quot;is_year_end&quot;</span><span class="p">,</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>            <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;day_of_month&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="mi">31</span><span class="p">),</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="p">)</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="n">column_order</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="s2">&quot;date_sk&quot;</span><span class="p">,</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>            <span class="s2">&quot;full_date&quot;</span><span class="p">,</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>            <span class="s2">&quot;day_of_week&quot;</span><span class="p">,</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="s2">&quot;day_of_week_num&quot;</span><span class="p">,</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="s2">&quot;day_of_month&quot;</span><span class="p">,</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>            <span class="s2">&quot;day_of_year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="s2">&quot;is_weekend&quot;</span><span class="p">,</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>            <span class="s2">&quot;week_of_year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="s2">&quot;month&quot;</span><span class="p">,</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="s2">&quot;month_name&quot;</span><span class="p">,</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>            <span class="s2">&quot;quarter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>            <span class="s2">&quot;quarter_name&quot;</span><span class="p">,</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="s2">&quot;year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>            <span class="s2">&quot;fiscal_year&quot;</span><span class="p">,</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="s2">&quot;fiscal_quarter&quot;</span><span class="p">,</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>            <span class="s2">&quot;is_month_start&quot;</span><span class="p">,</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="s2">&quot;is_month_end&quot;</span><span class="p">,</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>            <span class="s2">&quot;is_year_start&quot;</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="s2">&quot;is_year_end&quot;</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="p">]</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">column_order</span><span class="p">)</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add_unknown_member</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add unknown member row with date_sk=0.&quot;&quot;&quot;</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">Row</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>            <span class="n">unknown_data</span> <span class="o">=</span> <span class="p">{</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                <span class="s2">&quot;date_sk&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                <span class="s2">&quot;full_date&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="s2">&quot;day_of_week&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                <span class="s2">&quot;day_of_week_num&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="s2">&quot;day_of_month&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                <span class="s2">&quot;day_of_year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>                <span class="s2">&quot;is_weekend&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="s2">&quot;week_of_year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="s2">&quot;month_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="s2">&quot;quarter&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                <span class="s2">&quot;quarter_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                <span class="s2">&quot;fiscal_year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                <span class="s2">&quot;fiscal_quarter&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                <span class="s2">&quot;is_month_start&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                <span class="s2">&quot;is_month_end&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>                <span class="s2">&quot;is_year_start&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>                <span class="s2">&quot;is_year_end&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>            <span class="p">}</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>            <span class="n">unknown_row</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">spark</span><span class="o">.</span><span class="n">createDataFrame</span><span class="p">([</span><span class="n">Row</span><span class="p">(</span><span class="o">**</span><span class="n">unknown_data</span><span class="p">)])</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>            <span class="k">return</span> <span class="n">unknown_row</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>            <span class="n">unknown_row</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="p">[</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                    <span class="p">{</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>                        <span class="s2">&quot;date_sk&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>                        <span class="s2">&quot;full_date&quot;</span><span class="p">:</span> <span class="n">date</span><span class="p">(</span><span class="mi">1900</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>                        <span class="s2">&quot;day_of_week&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>                        <span class="s2">&quot;day_of_week_num&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>                        <span class="s2">&quot;day_of_month&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>                        <span class="s2">&quot;day_of_year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>                        <span class="s2">&quot;is_weekend&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>                        <span class="s2">&quot;week_of_year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>                        <span class="s2">&quot;month&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>                        <span class="s2">&quot;month_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>                        <span class="s2">&quot;quarter&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>                        <span class="s2">&quot;quarter_name&quot;</span><span class="p">:</span> <span class="s2">&quot;Unknown&quot;</span><span class="p">,</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>                        <span class="s2">&quot;year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>                        <span class="s2">&quot;fiscal_year&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                        <span class="s2">&quot;fiscal_quarter&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>                        <span class="s2">&quot;is_month_start&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>                        <span class="s2">&quot;is_month_end&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                        <span class="s2">&quot;is_year_start&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                        <span class="s2">&quot;is_year_end&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>                    <span class="p">}</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                <span class="p">]</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">unknown_row</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.date_dimension.DateDimensionPattern.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

<a href="#odibi.patterns.date_dimension.DateDimensionPattern.execute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Execute the date dimension pattern to generate a date dimension table.</p>
<p>Generates a complete date dimension table with pre-calculated date attributes for
the specified date range. The execution flow:
1. Parse start_date and end_date parameters
2. Generate one row per date in the range
3. Calculate all date attributes (day_of_week, quarter, fiscal_year, etc.)
4. Add unknown member row (date_sk=0) if configured</p>
<p>Generated columns include date_sk (surrogate key), full_date, day/week/month/quarter/year
attributes, fiscal year/quarter, and boolean flags for period boundaries.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="odibi.context.EngineContext">EngineContext</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine context for DataFrame creation and execution environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>DataFrame containing one row per date with all calculated date attributes.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If date parsing fails or DataFrame generation encounters errors.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/date_dimension.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-141" name="__codelineno-0-141"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the date dimension pattern to generate a date dimension table.</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a><span class="sd">    Generates a complete date dimension table with pre-calculated date attributes for</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a><span class="sd">    the specified date range. The execution flow:</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a><span class="sd">    1. Parse start_date and end_date parameters</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a><span class="sd">    2. Generate one row per date in the range</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a><span class="sd">    3. Calculate all date attributes (day_of_week, quarter, fiscal_year, etc.)</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a><span class="sd">    4. Add unknown member row (date_sk=0) if configured</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a><span class="sd">    Generated columns include date_sk (surrogate key), full_date, day/week/month/quarter/year</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a><span class="sd">    attributes, fiscal year/quarter, and boolean flags for period boundaries.</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a><span class="sd">        context: Engine context for DataFrame creation and execution environment.</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="sd">        DataFrame containing one row per date with all calculated date attributes.</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        Exception: If date parsing fails or DataFrame generation encounters errors.</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>    <span class="n">start_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">])</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>    <span class="n">end_date</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">])</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>    <span class="n">fiscal_year_start_month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fiscal_year_start_month&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>    <span class="n">unknown_member</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;unknown_member&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>        <span class="s2">&quot;DateDimensionPattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>        <span class="n">start_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">),</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>        <span class="n">end_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">),</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="n">fiscal_year_start_month</span><span class="o">=</span><span class="n">fiscal_year_start_month</span><span class="p">,</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="p">)</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_spark</span><span class="p">(</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">fiscal_year_start_month</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>            <span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pandas</span><span class="p">(</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="p">,</span> <span class="n">fiscal_year_start_month</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="k">if</span> <span class="n">unknown_member</span><span class="p">:</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_unknown_member</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">)</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">row_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="s2">&quot;DateDimensionPattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>            <span class="n">rows_generated</span><span class="o">=</span><span class="n">row_count</span><span class="p">,</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="n">start_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">start_date</span><span class="p">),</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="n">end_date</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">end_date</span><span class="p">),</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="p">)</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>        <span class="k">return</span> <span class="n">result_df</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>        <span class="p">)</span>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.date_dimension.DateDimensionPattern.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

<a href="#odibi.patterns.date_dimension.DateDimensionPattern.validate" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Validate date dimension pattern configuration parameters.</p>
<p>Ensures that all required parameters are present and valid. Checks that:
- start_date is provided in YYYY-MM-DD format
- end_date is provided in YYYY-MM-DD format
- start_date is before or equal to end_date
- fiscal_year_start_month is an integer between 1-12 if provided</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If required dates are missing, dates are invalid/unparseable,
start_date is after end_date, or fiscal_year_start_month is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/date_dimension.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate date dimension pattern configuration parameters.</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    Ensures that all required parameters are present and valid. Checks that:</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    - start_date is provided in YYYY-MM-DD format</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    - end_date is provided in YYYY-MM-DD format</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">    - start_date is before or equal to end_date</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    - fiscal_year_start_month is an integer between 1-12 if provided</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">        ValueError: If required dates are missing, dates are invalid/unparseable,</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            start_date is after end_date, or fiscal_year_start_month is invalid.</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="s2">&quot;DateDimensionPattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">params</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>    <span class="p">)</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;start_date&quot;</span><span class="p">):</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="s2">&quot;DateDimensionPattern validation failed: &#39;start_date&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>        <span class="p">)</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;start_date&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="s2">&quot;Expected format: &#39;YYYY-MM-DD&#39; (e.g., &#39;2024-01-01&#39;). &quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="s2">&quot;Provide a valid start_date in params.&quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>        <span class="p">)</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;end_date&quot;</span><span class="p">):</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="s2">&quot;DateDimensionPattern validation failed: &#39;end_date&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>        <span class="p">)</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;end_date&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="s2">&quot;Expected format: &#39;YYYY-MM-DD&#39; (e.g., &#39;2024-12-31&#39;). &quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="s2">&quot;Provide a valid end_date in params.&quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>        <span class="p">)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">])</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="n">end</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_parse_date</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">])</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>        <span class="k">if</span> <span class="n">start</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">:</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): start_date must be before or equal to end_date. &quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="sa">f</span><span class="s2">&quot;Provided: start_date=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;start_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="sa">f</span><span class="s2">&quot;end_date=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;end_date&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="sa">f</span><span class="s2">&quot;Fix: Swap the values or adjust the date range.&quot;</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>            <span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern validation failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="p">)</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): Invalid date parameters. </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2"> &quot;</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="sa">f</span><span class="s2">&quot;Provided: start_date=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;start_date&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="sa">f</span><span class="s2">&quot;end_date=&#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;end_date&#39;</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>            <span class="sa">f</span><span class="s2">&quot;Expected format: &#39;YYYY-MM-DD&#39;.&quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>        <span class="p">)</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>    <span class="n">fiscal_month</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;fiscal_year_start_month&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fiscal_month</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="ow">or</span> <span class="n">fiscal_month</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">fiscal_month</span> <span class="o">&gt;</span> <span class="mi">12</span><span class="p">:</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="s2">&quot;DateDimensionPattern validation failed: invalid fiscal_year_start_month&quot;</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>        <span class="p">)</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="sa">f</span><span class="s2">&quot;DateDimensionPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;fiscal_year_start_month&#39; must be an integer 1-12. &quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="sa">f</span><span class="s2">&quot;Provided: </span><span class="si">{</span><span class="n">fiscal_month</span><span class="si">!r}</span><span class="s2"> (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">fiscal_month</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">). &quot;</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>            <span class="sa">f</span><span class="s2">&quot;Use an integer like 1 for January or 7 for July.&quot;</span>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>        <span class="s2">&quot;DateDimensionPattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;DateDimensionPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="odibi.patterns.fact" class="doc doc-heading">
            <code>odibi.patterns.fact</code>


<a href="#odibi.patterns.fact" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="odibi.patterns.fact.FactPattern" class="doc doc-heading">
            <code>FactPattern</code>


<a href="#odibi.patterns.fact.FactPattern" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="odibi.patterns.base.Pattern">Pattern</span></code></p>



        <p>Enhanced Fact Pattern: Builds fact tables with automatic SK lookups.</p>
<p>Features:
- Automatic surrogate key lookups from dimension tables
- Orphan handling (unknown member, reject, or quarantine)
- Grain validation (detect duplicates at PK level)
- Audit columns (load_timestamp, source_system)
- Deduplication support
- Measure calculations and renaming</p>
<p>Basic Params (backward compatible):
    deduplicate (bool): If true, removes duplicates before insert.
    keys (list): Keys for deduplication.</p>


<details class="enhanced-params" open>
  <summary>Enhanced Params</summary>
  <p>grain (list): Columns that define uniqueness (validates no duplicates)
dimensions (list): Dimension lookup configurations
    - source_column: Column in source data
    - dimension_table: Name of dimension in context
    - dimension_key: Natural key column in dimension
    - surrogate_key: Surrogate key to retrieve
    - scd2 (bool): If true, filter is_current=true
orphan_handling (str): "unknown" | "reject" | "quarantine"
quarantine (dict): Quarantine configuration (required if orphan_handling=quarantine)
    - connection: Connection name for quarantine writes
    - path: Path for quarantine data (or use 'table')
    - table: Table name for quarantine (or use 'path')
    - add_columns (dict): Metadata columns to add
        - _rejection_reason (bool): Add rejection reason column
        - _rejected_at (bool): Add rejection timestamp column
        - _source_dimension (bool): Add source dimension name column
measures (list): Measure definitions (passthrough, rename, or calculated)
audit (dict): Audit column configuration
    - load_timestamp (bool)
    - source_system (str)</p>
</details>

<details class="example-config" open>
  <summary>Example Config</summary>
  <p>pattern:
  type: fact
  params:
    grain: [order_id]
    dimensions:
      - source_column: customer_id
        dimension_table: dim_customer
        dimension_key: customer_id
        surrogate_key: customer_sk
        scd2: true
    orphan_handling: unknown
    measures:
      - quantity
      - total_amount: "quantity * price"
    audit:
      load_timestamp: true
      source_system: "pos"</p>
</details>

<details class="example-with-quarantine" open>
  <summary>Example with Quarantine</summary>
  <p>pattern:
  type: fact
  params:
    dimensions:
      - source_column: customer_id
        dimension_table: dim_customer
        dimension_key: customer_id
        surrogate_key: customer_sk
    orphan_handling: quarantine
    quarantine:
      connection: silver
      path: fact_orders_orphans
      add_columns:
        _rejection_reason: true
        _rejected_at: true
        _source_dimension: true</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>odibi/patterns/fact.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span>
<span class="normal"><a href="#__codelineno-0-568">568</a></span>
<span class="normal"><a href="#__codelineno-0-569">569</a></span>
<span class="normal"><a href="#__codelineno-0-570">570</a></span>
<span class="normal"><a href="#__codelineno-0-571">571</a></span>
<span class="normal"><a href="#__codelineno-0-572">572</a></span>
<span class="normal"><a href="#__codelineno-0-573">573</a></span>
<span class="normal"><a href="#__codelineno-0-574">574</a></span>
<span class="normal"><a href="#__codelineno-0-575">575</a></span>
<span class="normal"><a href="#__codelineno-0-576">576</a></span>
<span class="normal"><a href="#__codelineno-0-577">577</a></span>
<span class="normal"><a href="#__codelineno-0-578">578</a></span>
<span class="normal"><a href="#__codelineno-0-579">579</a></span>
<span class="normal"><a href="#__codelineno-0-580">580</a></span>
<span class="normal"><a href="#__codelineno-0-581">581</a></span>
<span class="normal"><a href="#__codelineno-0-582">582</a></span>
<span class="normal"><a href="#__codelineno-0-583">583</a></span>
<span class="normal"><a href="#__codelineno-0-584">584</a></span>
<span class="normal"><a href="#__codelineno-0-585">585</a></span>
<span class="normal"><a href="#__codelineno-0-586">586</a></span>
<span class="normal"><a href="#__codelineno-0-587">587</a></span>
<span class="normal"><a href="#__codelineno-0-588">588</a></span>
<span class="normal"><a href="#__codelineno-0-589">589</a></span>
<span class="normal"><a href="#__codelineno-0-590">590</a></span>
<span class="normal"><a href="#__codelineno-0-591">591</a></span>
<span class="normal"><a href="#__codelineno-0-592">592</a></span>
<span class="normal"><a href="#__codelineno-0-593">593</a></span>
<span class="normal"><a href="#__codelineno-0-594">594</a></span>
<span class="normal"><a href="#__codelineno-0-595">595</a></span>
<span class="normal"><a href="#__codelineno-0-596">596</a></span>
<span class="normal"><a href="#__codelineno-0-597">597</a></span>
<span class="normal"><a href="#__codelineno-0-598">598</a></span>
<span class="normal"><a href="#__codelineno-0-599">599</a></span>
<span class="normal"><a href="#__codelineno-0-600">600</a></span>
<span class="normal"><a href="#__codelineno-0-601">601</a></span>
<span class="normal"><a href="#__codelineno-0-602">602</a></span>
<span class="normal"><a href="#__codelineno-0-603">603</a></span>
<span class="normal"><a href="#__codelineno-0-604">604</a></span>
<span class="normal"><a href="#__codelineno-0-605">605</a></span>
<span class="normal"><a href="#__codelineno-0-606">606</a></span>
<span class="normal"><a href="#__codelineno-0-607">607</a></span>
<span class="normal"><a href="#__codelineno-0-608">608</a></span>
<span class="normal"><a href="#__codelineno-0-609">609</a></span>
<span class="normal"><a href="#__codelineno-0-610">610</a></span>
<span class="normal"><a href="#__codelineno-0-611">611</a></span>
<span class="normal"><a href="#__codelineno-0-612">612</a></span>
<span class="normal"><a href="#__codelineno-0-613">613</a></span>
<span class="normal"><a href="#__codelineno-0-614">614</a></span>
<span class="normal"><a href="#__codelineno-0-615">615</a></span>
<span class="normal"><a href="#__codelineno-0-616">616</a></span>
<span class="normal"><a href="#__codelineno-0-617">617</a></span>
<span class="normal"><a href="#__codelineno-0-618">618</a></span>
<span class="normal"><a href="#__codelineno-0-619">619</a></span>
<span class="normal"><a href="#__codelineno-0-620">620</a></span>
<span class="normal"><a href="#__codelineno-0-621">621</a></span>
<span class="normal"><a href="#__codelineno-0-622">622</a></span>
<span class="normal"><a href="#__codelineno-0-623">623</a></span>
<span class="normal"><a href="#__codelineno-0-624">624</a></span>
<span class="normal"><a href="#__codelineno-0-625">625</a></span>
<span class="normal"><a href="#__codelineno-0-626">626</a></span>
<span class="normal"><a href="#__codelineno-0-627">627</a></span>
<span class="normal"><a href="#__codelineno-0-628">628</a></span>
<span class="normal"><a href="#__codelineno-0-629">629</a></span>
<span class="normal"><a href="#__codelineno-0-630">630</a></span>
<span class="normal"><a href="#__codelineno-0-631">631</a></span>
<span class="normal"><a href="#__codelineno-0-632">632</a></span>
<span class="normal"><a href="#__codelineno-0-633">633</a></span>
<span class="normal"><a href="#__codelineno-0-634">634</a></span>
<span class="normal"><a href="#__codelineno-0-635">635</a></span>
<span class="normal"><a href="#__codelineno-0-636">636</a></span>
<span class="normal"><a href="#__codelineno-0-637">637</a></span>
<span class="normal"><a href="#__codelineno-0-638">638</a></span>
<span class="normal"><a href="#__codelineno-0-639">639</a></span>
<span class="normal"><a href="#__codelineno-0-640">640</a></span>
<span class="normal"><a href="#__codelineno-0-641">641</a></span>
<span class="normal"><a href="#__codelineno-0-642">642</a></span>
<span class="normal"><a href="#__codelineno-0-643">643</a></span>
<span class="normal"><a href="#__codelineno-0-644">644</a></span>
<span class="normal"><a href="#__codelineno-0-645">645</a></span>
<span class="normal"><a href="#__codelineno-0-646">646</a></span>
<span class="normal"><a href="#__codelineno-0-647">647</a></span>
<span class="normal"><a href="#__codelineno-0-648">648</a></span>
<span class="normal"><a href="#__codelineno-0-649">649</a></span>
<span class="normal"><a href="#__codelineno-0-650">650</a></span>
<span class="normal"><a href="#__codelineno-0-651">651</a></span>
<span class="normal"><a href="#__codelineno-0-652">652</a></span>
<span class="normal"><a href="#__codelineno-0-653">653</a></span>
<span class="normal"><a href="#__codelineno-0-654">654</a></span>
<span class="normal"><a href="#__codelineno-0-655">655</a></span>
<span class="normal"><a href="#__codelineno-0-656">656</a></span>
<span class="normal"><a href="#__codelineno-0-657">657</a></span>
<span class="normal"><a href="#__codelineno-0-658">658</a></span>
<span class="normal"><a href="#__codelineno-0-659">659</a></span>
<span class="normal"><a href="#__codelineno-0-660">660</a></span>
<span class="normal"><a href="#__codelineno-0-661">661</a></span>
<span class="normal"><a href="#__codelineno-0-662">662</a></span>
<span class="normal"><a href="#__codelineno-0-663">663</a></span>
<span class="normal"><a href="#__codelineno-0-664">664</a></span>
<span class="normal"><a href="#__codelineno-0-665">665</a></span>
<span class="normal"><a href="#__codelineno-0-666">666</a></span>
<span class="normal"><a href="#__codelineno-0-667">667</a></span>
<span class="normal"><a href="#__codelineno-0-668">668</a></span>
<span class="normal"><a href="#__codelineno-0-669">669</a></span>
<span class="normal"><a href="#__codelineno-0-670">670</a></span>
<span class="normal"><a href="#__codelineno-0-671">671</a></span>
<span class="normal"><a href="#__codelineno-0-672">672</a></span>
<span class="normal"><a href="#__codelineno-0-673">673</a></span>
<span class="normal"><a href="#__codelineno-0-674">674</a></span>
<span class="normal"><a href="#__codelineno-0-675">675</a></span>
<span class="normal"><a href="#__codelineno-0-676">676</a></span>
<span class="normal"><a href="#__codelineno-0-677">677</a></span>
<span class="normal"><a href="#__codelineno-0-678">678</a></span>
<span class="normal"><a href="#__codelineno-0-679">679</a></span>
<span class="normal"><a href="#__codelineno-0-680">680</a></span>
<span class="normal"><a href="#__codelineno-0-681">681</a></span>
<span class="normal"><a href="#__codelineno-0-682">682</a></span>
<span class="normal"><a href="#__codelineno-0-683">683</a></span>
<span class="normal"><a href="#__codelineno-0-684">684</a></span>
<span class="normal"><a href="#__codelineno-0-685">685</a></span>
<span class="normal"><a href="#__codelineno-0-686">686</a></span>
<span class="normal"><a href="#__codelineno-0-687">687</a></span>
<span class="normal"><a href="#__codelineno-0-688">688</a></span>
<span class="normal"><a href="#__codelineno-0-689">689</a></span>
<span class="normal"><a href="#__codelineno-0-690">690</a></span>
<span class="normal"><a href="#__codelineno-0-691">691</a></span>
<span class="normal"><a href="#__codelineno-0-692">692</a></span>
<span class="normal"><a href="#__codelineno-0-693">693</a></span>
<span class="normal"><a href="#__codelineno-0-694">694</a></span>
<span class="normal"><a href="#__codelineno-0-695">695</a></span>
<span class="normal"><a href="#__codelineno-0-696">696</a></span>
<span class="normal"><a href="#__codelineno-0-697">697</a></span>
<span class="normal"><a href="#__codelineno-0-698">698</a></span>
<span class="normal"><a href="#__codelineno-0-699">699</a></span>
<span class="normal"><a href="#__codelineno-0-700">700</a></span>
<span class="normal"><a href="#__codelineno-0-701">701</a></span>
<span class="normal"><a href="#__codelineno-0-702">702</a></span>
<span class="normal"><a href="#__codelineno-0-703">703</a></span>
<span class="normal"><a href="#__codelineno-0-704">704</a></span>
<span class="normal"><a href="#__codelineno-0-705">705</a></span>
<span class="normal"><a href="#__codelineno-0-706">706</a></span>
<span class="normal"><a href="#__codelineno-0-707">707</a></span>
<span class="normal"><a href="#__codelineno-0-708">708</a></span>
<span class="normal"><a href="#__codelineno-0-709">709</a></span>
<span class="normal"><a href="#__codelineno-0-710">710</a></span>
<span class="normal"><a href="#__codelineno-0-711">711</a></span>
<span class="normal"><a href="#__codelineno-0-712">712</a></span>
<span class="normal"><a href="#__codelineno-0-713">713</a></span>
<span class="normal"><a href="#__codelineno-0-714">714</a></span>
<span class="normal"><a href="#__codelineno-0-715">715</a></span>
<span class="normal"><a href="#__codelineno-0-716">716</a></span>
<span class="normal"><a href="#__codelineno-0-717">717</a></span>
<span class="normal"><a href="#__codelineno-0-718">718</a></span>
<span class="normal"><a href="#__codelineno-0-719">719</a></span>
<span class="normal"><a href="#__codelineno-0-720">720</a></span>
<span class="normal"><a href="#__codelineno-0-721">721</a></span>
<span class="normal"><a href="#__codelineno-0-722">722</a></span>
<span class="normal"><a href="#__codelineno-0-723">723</a></span>
<span class="normal"><a href="#__codelineno-0-724">724</a></span>
<span class="normal"><a href="#__codelineno-0-725">725</a></span>
<span class="normal"><a href="#__codelineno-0-726">726</a></span>
<span class="normal"><a href="#__codelineno-0-727">727</a></span>
<span class="normal"><a href="#__codelineno-0-728">728</a></span>
<span class="normal"><a href="#__codelineno-0-729">729</a></span>
<span class="normal"><a href="#__codelineno-0-730">730</a></span>
<span class="normal"><a href="#__codelineno-0-731">731</a></span>
<span class="normal"><a href="#__codelineno-0-732">732</a></span>
<span class="normal"><a href="#__codelineno-0-733">733</a></span>
<span class="normal"><a href="#__codelineno-0-734">734</a></span>
<span class="normal"><a href="#__codelineno-0-735">735</a></span>
<span class="normal"><a href="#__codelineno-0-736">736</a></span>
<span class="normal"><a href="#__codelineno-0-737">737</a></span>
<span class="normal"><a href="#__codelineno-0-738">738</a></span>
<span class="normal"><a href="#__codelineno-0-739">739</a></span>
<span class="normal"><a href="#__codelineno-0-740">740</a></span>
<span class="normal"><a href="#__codelineno-0-741">741</a></span>
<span class="normal"><a href="#__codelineno-0-742">742</a></span>
<span class="normal"><a href="#__codelineno-0-743">743</a></span>
<span class="normal"><a href="#__codelineno-0-744">744</a></span>
<span class="normal"><a href="#__codelineno-0-745">745</a></span>
<span class="normal"><a href="#__codelineno-0-746">746</a></span>
<span class="normal"><a href="#__codelineno-0-747">747</a></span>
<span class="normal"><a href="#__codelineno-0-748">748</a></span>
<span class="normal"><a href="#__codelineno-0-749">749</a></span>
<span class="normal"><a href="#__codelineno-0-750">750</a></span>
<span class="normal"><a href="#__codelineno-0-751">751</a></span>
<span class="normal"><a href="#__codelineno-0-752">752</a></span>
<span class="normal"><a href="#__codelineno-0-753">753</a></span>
<span class="normal"><a href="#__codelineno-0-754">754</a></span>
<span class="normal"><a href="#__codelineno-0-755">755</a></span>
<span class="normal"><a href="#__codelineno-0-756">756</a></span>
<span class="normal"><a href="#__codelineno-0-757">757</a></span>
<span class="normal"><a href="#__codelineno-0-758">758</a></span>
<span class="normal"><a href="#__codelineno-0-759">759</a></span>
<span class="normal"><a href="#__codelineno-0-760">760</a></span>
<span class="normal"><a href="#__codelineno-0-761">761</a></span>
<span class="normal"><a href="#__codelineno-0-762">762</a></span>
<span class="normal"><a href="#__codelineno-0-763">763</a></span>
<span class="normal"><a href="#__codelineno-0-764">764</a></span>
<span class="normal"><a href="#__codelineno-0-765">765</a></span>
<span class="normal"><a href="#__codelineno-0-766">766</a></span>
<span class="normal"><a href="#__codelineno-0-767">767</a></span>
<span class="normal"><a href="#__codelineno-0-768">768</a></span>
<span class="normal"><a href="#__codelineno-0-769">769</a></span>
<span class="normal"><a href="#__codelineno-0-770">770</a></span>
<span class="normal"><a href="#__codelineno-0-771">771</a></span>
<span class="normal"><a href="#__codelineno-0-772">772</a></span>
<span class="normal"><a href="#__codelineno-0-773">773</a></span>
<span class="normal"><a href="#__codelineno-0-774">774</a></span>
<span class="normal"><a href="#__codelineno-0-775">775</a></span>
<span class="normal"><a href="#__codelineno-0-776">776</a></span>
<span class="normal"><a href="#__codelineno-0-777">777</a></span>
<span class="normal"><a href="#__codelineno-0-778">778</a></span>
<span class="normal"><a href="#__codelineno-0-779">779</a></span>
<span class="normal"><a href="#__codelineno-0-780">780</a></span>
<span class="normal"><a href="#__codelineno-0-781">781</a></span>
<span class="normal"><a href="#__codelineno-0-782">782</a></span>
<span class="normal"><a href="#__codelineno-0-783">783</a></span>
<span class="normal"><a href="#__codelineno-0-784">784</a></span>
<span class="normal"><a href="#__codelineno-0-785">785</a></span>
<span class="normal"><a href="#__codelineno-0-786">786</a></span>
<span class="normal"><a href="#__codelineno-0-787">787</a></span>
<span class="normal"><a href="#__codelineno-0-788">788</a></span>
<span class="normal"><a href="#__codelineno-0-789">789</a></span>
<span class="normal"><a href="#__codelineno-0-790">790</a></span>
<span class="normal"><a href="#__codelineno-0-791">791</a></span>
<span class="normal"><a href="#__codelineno-0-792">792</a></span>
<span class="normal"><a href="#__codelineno-0-793">793</a></span>
<span class="normal"><a href="#__codelineno-0-794">794</a></span>
<span class="normal"><a href="#__codelineno-0-795">795</a></span>
<span class="normal"><a href="#__codelineno-0-796">796</a></span>
<span class="normal"><a href="#__codelineno-0-797">797</a></span>
<span class="normal"><a href="#__codelineno-0-798">798</a></span>
<span class="normal"><a href="#__codelineno-0-799">799</a></span>
<span class="normal"><a href="#__codelineno-0-800">800</a></span>
<span class="normal"><a href="#__codelineno-0-801">801</a></span>
<span class="normal"><a href="#__codelineno-0-802">802</a></span>
<span class="normal"><a href="#__codelineno-0-803">803</a></span>
<span class="normal"><a href="#__codelineno-0-804">804</a></span>
<span class="normal"><a href="#__codelineno-0-805">805</a></span>
<span class="normal"><a href="#__codelineno-0-806">806</a></span>
<span class="normal"><a href="#__codelineno-0-807">807</a></span>
<span class="normal"><a href="#__codelineno-0-808">808</a></span>
<span class="normal"><a href="#__codelineno-0-809">809</a></span>
<span class="normal"><a href="#__codelineno-0-810">810</a></span>
<span class="normal"><a href="#__codelineno-0-811">811</a></span>
<span class="normal"><a href="#__codelineno-0-812">812</a></span>
<span class="normal"><a href="#__codelineno-0-813">813</a></span>
<span class="normal"><a href="#__codelineno-0-814">814</a></span>
<span class="normal"><a href="#__codelineno-0-815">815</a></span>
<span class="normal"><a href="#__codelineno-0-816">816</a></span>
<span class="normal"><a href="#__codelineno-0-817">817</a></span>
<span class="normal"><a href="#__codelineno-0-818">818</a></span>
<span class="normal"><a href="#__codelineno-0-819">819</a></span>
<span class="normal"><a href="#__codelineno-0-820">820</a></span>
<span class="normal"><a href="#__codelineno-0-821">821</a></span>
<span class="normal"><a href="#__codelineno-0-822">822</a></span>
<span class="normal"><a href="#__codelineno-0-823">823</a></span>
<span class="normal"><a href="#__codelineno-0-824">824</a></span>
<span class="normal"><a href="#__codelineno-0-825">825</a></span>
<span class="normal"><a href="#__codelineno-0-826">826</a></span>
<span class="normal"><a href="#__codelineno-0-827">827</a></span>
<span class="normal"><a href="#__codelineno-0-828">828</a></span>
<span class="normal"><a href="#__codelineno-0-829">829</a></span>
<span class="normal"><a href="#__codelineno-0-830">830</a></span>
<span class="normal"><a href="#__codelineno-0-831">831</a></span>
<span class="normal"><a href="#__codelineno-0-832">832</a></span>
<span class="normal"><a href="#__codelineno-0-833">833</a></span>
<span class="normal"><a href="#__codelineno-0-834">834</a></span>
<span class="normal"><a href="#__codelineno-0-835">835</a></span>
<span class="normal"><a href="#__codelineno-0-836">836</a></span>
<span class="normal"><a href="#__codelineno-0-837">837</a></span>
<span class="normal"><a href="#__codelineno-0-838">838</a></span>
<span class="normal"><a href="#__codelineno-0-839">839</a></span>
<span class="normal"><a href="#__codelineno-0-840">840</a></span>
<span class="normal"><a href="#__codelineno-0-841">841</a></span>
<span class="normal"><a href="#__codelineno-0-842">842</a></span>
<span class="normal"><a href="#__codelineno-0-843">843</a></span>
<span class="normal"><a href="#__codelineno-0-844">844</a></span>
<span class="normal"><a href="#__codelineno-0-845">845</a></span>
<span class="normal"><a href="#__codelineno-0-846">846</a></span>
<span class="normal"><a href="#__codelineno-0-847">847</a></span>
<span class="normal"><a href="#__codelineno-0-848">848</a></span>
<span class="normal"><a href="#__codelineno-0-849">849</a></span>
<span class="normal"><a href="#__codelineno-0-850">850</a></span>
<span class="normal"><a href="#__codelineno-0-851">851</a></span>
<span class="normal"><a href="#__codelineno-0-852">852</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="k">class</span><span class="w"> </span><span class="nc">FactPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a><span class="sd">    Enhanced Fact Pattern: Builds fact tables with automatic SK lookups.</span>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    Features:</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    - Automatic surrogate key lookups from dimension tables</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    - Orphan handling (unknown member, reject, or quarantine)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    - Grain validation (detect duplicates at PK level)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    - Audit columns (load_timestamp, source_system)</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a><span class="sd">    - Deduplication support</span>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    - Measure calculations and renaming</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">    Basic Params (backward compatible):</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">        deduplicate (bool): If true, removes duplicates before insert.</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">        keys (list): Keys for deduplication.</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">    Enhanced Params:</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">        grain (list): Columns that define uniqueness (validates no duplicates)</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        dimensions (list): Dimension lookup configurations</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">            - source_column: Column in source data</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a><span class="sd">            - dimension_table: Name of dimension in context</span>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">            - dimension_key: Natural key column in dimension</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">            - surrogate_key: Surrogate key to retrieve</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">            - scd2 (bool): If true, filter is_current=true</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">        orphan_handling (str): &quot;unknown&quot; | &quot;reject&quot; | &quot;quarantine&quot;</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">        quarantine (dict): Quarantine configuration (required if orphan_handling=quarantine)</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            - connection: Connection name for quarantine writes</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">            - path: Path for quarantine data (or use &#39;table&#39;)</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">            - table: Table name for quarantine (or use &#39;path&#39;)</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">            - add_columns (dict): Metadata columns to add</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">                - _rejection_reason (bool): Add rejection reason column</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">                - _rejected_at (bool): Add rejection timestamp column</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">                - _source_dimension (bool): Add source dimension name column</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">        measures (list): Measure definitions (passthrough, rename, or calculated)</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">        audit (dict): Audit column configuration</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">            - load_timestamp (bool)</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">            - source_system (str)</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="sd">    Example Config:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="sd">        pattern:</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a><span class="sd">          type: fact</span>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">          params:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">            grain: [order_id]</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">            dimensions:</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">              - source_column: customer_id</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a><span class="sd">                dimension_table: dim_customer</span>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">                dimension_key: customer_id</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">                surrogate_key: customer_sk</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">                scd2: true</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a><span class="sd">            orphan_handling: unknown</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a><span class="sd">            measures:</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a><span class="sd">              - quantity</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a><span class="sd">              - total_amount: &quot;quantity * price&quot;</span>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a><span class="sd">            audit:</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a><span class="sd">              load_timestamp: true</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a><span class="sd">              source_system: &quot;pos&quot;</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a><span class="sd">    Example with Quarantine:</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a><span class="sd">        pattern:</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a><span class="sd">          type: fact</span>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a><span class="sd">          params:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a><span class="sd">            dimensions:</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a><span class="sd">              - source_column: customer_id</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a><span class="sd">                dimension_table: dim_customer</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a><span class="sd">                dimension_key: customer_id</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a><span class="sd">                surrogate_key: customer_sk</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a><span class="sd">            orphan_handling: quarantine</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a><span class="sd">            quarantine:</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a><span class="sd">              connection: silver</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a><span class="sd">              path: fact_orders_orphans</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a><span class="sd">              add_columns:</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a><span class="sd">                _rejection_reason: true</span>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a><span class="sd">                _rejected_at: true</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a><span class="sd">                _source_dimension: true</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate fact pattern configuration parameters.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">        Ensures that all required parameters are present and valid. Checks that:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">        - keys are provided when deduplicate is True</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">        - orphan_handling is valid (&#39;unknown&#39;, &#39;reject&#39;, or &#39;quarantine&#39;)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">        - quarantine config is complete when orphan_handling=&#39;quarantine&#39;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">        - all dimension lookups have required fields (source_column, dimension_table, etc.)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">            ValueError: If keys are missing for deduplication, orphan_handling is invalid,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">                quarantine config is incomplete, or dimension configs are missing required fields.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>        <span class="n">deduplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deduplicate&quot;</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>        <span class="n">grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>        <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>        <span class="n">orphan_handling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orphan_handling&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="s2">&quot;FactPattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>            <span class="n">deduplicate</span><span class="o">=</span><span class="n">deduplicate</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="n">dimensions_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">),</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>        <span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>        <span class="k">if</span> <span class="n">deduplicate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="s2">&quot;FactPattern validation failed: &#39;keys&#39; required when &#39;deduplicate&#39; is True&quot;</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>            <span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;keys&#39; required when &#39;deduplicate&#39; is True. &quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="s2">&quot;Keys define which columns uniquely identify a fact row for deduplication. &quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="s2">&quot;Provide keys=[&#39;col1&#39;, &#39;col2&#39;] to specify the deduplication columns.&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="k">if</span> <span class="n">orphan_handling</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;reject&quot;</span><span class="p">,</span> <span class="s2">&quot;quarantine&quot;</span><span class="p">):</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern validation failed: invalid orphan_handling &#39;</span><span class="si">{</span><span class="n">orphan_handling</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>            <span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;orphan_handling&#39; must be &#39;unknown&#39;, &#39;reject&#39;, or &#39;quarantine&#39;. &quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">orphan_handling</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>            <span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>        <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;quarantine&quot;</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="n">quarantine_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quarantine&quot;</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">quarantine_config</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                    <span class="s2">&quot;FactPattern validation failed: &#39;quarantine&#39; config required &quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                    <span class="s2">&quot;when orphan_handling=&#39;quarantine&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;quarantine&#39; configuration is required when &quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                    <span class="s2">&quot;orphan_handling=&#39;quarantine&#39;.&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">):</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                    <span class="s2">&quot;FactPattern validation failed: quarantine.connection is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>                <span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                    <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;quarantine.connection&#39; is required. &quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                    <span class="s2">&quot;The connection specifies where to write quarantined orphan records &quot;</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                    <span class="s2">&quot;(e.g., a Spark session or database connection). &quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                    <span class="s2">&quot;Add &#39;connection&#39; to your quarantine config.&quot;</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>                <span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">):</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                    <span class="s2">&quot;FactPattern validation failed: quarantine requires &#39;path&#39; or &#39;table&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>                <span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                    <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;quarantine&#39; requires either &#39;path&#39; or &#39;table&#39;. &quot;</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                    <span class="sa">f</span><span class="s2">&quot;Got config: </span><span class="si">{</span><span class="n">quarantine_config</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                    <span class="s2">&quot;Add &#39;path&#39; for file storage or &#39;table&#39; for database storage.&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>                <span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dimensions</span><span class="p">):</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>            <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source_column&quot;</span><span class="p">,</span> <span class="s2">&quot;dimension_table&quot;</span><span class="p">,</span> <span class="s2">&quot;dimension_key&quot;</span><span class="p">,</span> <span class="s2">&quot;surrogate_key&quot;</span><span class="p">]</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dim</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                    <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                        <span class="sa">f</span><span class="s2">&quot;FactPattern validation failed: dimension[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                        <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                    <span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                        <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): dimension[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing required key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                        <span class="sa">f</span><span class="s2">&quot;Required keys: </span><span class="si">{</span><span class="n">required_keys</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                        <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                        <span class="sa">f</span><span class="s2">&quot;Ensure all required keys are provided in the dimension config.&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                    <span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>            <span class="s2">&quot;FactPattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="p">)</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the fact pattern to build a fact table with surrogate key lookups.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">        Builds a fact table with automatic surrogate key lookups from dimension tables.</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">        The execution flow:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">        1. Deduplicate source data if configured</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">        2. Perform dimension lookups to replace natural keys with surrogate keys</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">        3. Handle orphan records (unknown SK=0, reject with error, or quarantine)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">        4. Apply measure calculations and transformations if configured</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">        5. Validate grain (check for duplicates) if grain is specified</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">        6. Add audit columns (load_timestamp, source_system) if configured</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">            context: Engine context containing the source DataFrame, dimension tables,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">                and execution environment.</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">            Fact DataFrame with surrogate keys from dimension lookups and all transformations applied.</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">            ValueError: If orphan records are found and orphan_handling=&#39;reject&#39;, if grain</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">                validation fails (duplicates found), or if dimension lookup fails.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">            Exception: If quarantine write fails or measure calculations fail.</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>        <span class="n">deduplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deduplicate&quot;</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>        <span class="n">grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">orphan_handling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orphan_handling&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">quarantine_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quarantine&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>        <span class="n">measures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;measures&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>        <span class="n">audit_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audit&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="s2">&quot;FactPattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="n">deduplicate</span><span class="o">=</span><span class="n">deduplicate</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>            <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>            <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>            <span class="n">dimensions_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">),</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>            <span class="n">orphan_handling</span><span class="o">=</span><span class="n">orphan_handling</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">source_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fact source loaded&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span> <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>            <span class="k">if</span> <span class="n">deduplicate</span> <span class="ow">and</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deduplicate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                    <span class="s2">&quot;Fact deduplication complete&quot;</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                    <span class="n">rows_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">),</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>                <span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>            <span class="k">if</span> <span class="n">dimensions</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>                <span class="n">df</span><span class="p">,</span> <span class="n">orphan_count</span><span class="p">,</span> <span class="n">quarantined_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_dimensions</span><span class="p">(</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                    <span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">orphan_handling</span><span class="p">,</span> <span class="n">quarantine_config</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>                <span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                    <span class="s2">&quot;Fact dimension lookups complete&quot;</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                    <span class="n">orphan_count</span><span class="o">=</span><span class="n">orphan_count</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>                <span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>                <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;quarantine&quot;</span> <span class="ow">and</span> <span class="n">quarantined_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                    <span class="bp">self</span><span class="o">.</span><span class="n">_write_quarantine</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">quarantined_df</span><span class="p">,</span> <span class="n">quarantine_config</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                    <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                        <span class="sa">f</span><span class="s2">&quot;Quarantined </span><span class="si">{</span><span class="n">orphan_count</span><span class="si">}</span><span class="s2"> orphan records&quot;</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                        <span class="n">quarantine_path</span><span class="o">=</span><span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                        <span class="ow">or</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">),</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                    <span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>            <span class="k">if</span> <span class="n">measures</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>                <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_measures</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">measures</span><span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="k">if</span> <span class="n">grain</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_validate_grain</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">grain</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_audit_columns</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">audit_config</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>            <span class="n">result_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>                <span class="s2">&quot;FactPattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>                <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>                <span class="n">result_rows</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>            <span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>            <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>            <span class="k">raise</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_deduplicate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">keys</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Remove duplicates based on keys.&quot;&quot;&quot;</span>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">dropDuplicates</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_lookup_dimensions</span><span class="p">(</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="n">dimensions</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="n">orphan_handling</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">quarantine_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>    <span class="p">):</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a><span class="sd">        Perform surrogate key lookups from dimension tables.</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a><span class="sd">            Tuple of (result_df, orphan_count, quarantined_df)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">total_orphans</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="n">all_quarantined</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>        <span class="k">for</span> <span class="n">dim_config</span> <span class="ow">in</span> <span class="n">dimensions</span><span class="p">:</span>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>            <span class="n">source_col</span> <span class="o">=</span> <span class="n">dim_config</span><span class="p">[</span><span class="s2">&quot;source_column&quot;</span><span class="p">]</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="n">dim_table</span> <span class="o">=</span> <span class="n">dim_config</span><span class="p">[</span><span class="s2">&quot;dimension_table&quot;</span><span class="p">]</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>            <span class="n">dim_key</span> <span class="o">=</span> <span class="n">dim_config</span><span class="p">[</span><span class="s2">&quot;dimension_key&quot;</span><span class="p">]</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="n">sk_col</span> <span class="o">=</span> <span class="n">dim_config</span><span class="p">[</span><span class="s2">&quot;surrogate_key&quot;</span><span class="p">]</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>            <span class="n">is_scd2</span> <span class="o">=</span> <span class="n">dim_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;scd2&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>            <span class="n">dim_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_dimension_df</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">dim_table</span><span class="p">,</span> <span class="n">is_scd2</span><span class="p">)</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="k">if</span> <span class="n">dim_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>                    <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): Dimension table &#39;</span><span class="si">{</span><span class="n">dim_table</span><span class="si">}</span><span class="s2">&#39; not found in context. &quot;</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a>                    <span class="sa">f</span><span class="s2">&quot;Expected dimension: &#39;</span><span class="si">{</span><span class="n">dim_table</span><span class="si">}</span><span class="s2">&#39;. Available context: </span><span class="si">{</span><span class="nb">list</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">dataframes</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;dataframes&#39;</span><span class="p">)</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="s1">&#39;N/A&#39;</span><span class="si">}</span><span class="s2">.&quot;</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a>                <span class="p">)</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>            <span class="n">df</span><span class="p">,</span> <span class="n">orphan_count</span><span class="p">,</span> <span class="n">quarantined</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_dimension</span><span class="p">(</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>                <span class="n">context</span><span class="p">,</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>                <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>                <span class="n">dim_df</span><span class="p">,</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>                <span class="n">source_col</span><span class="p">,</span>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>                <span class="n">dim_key</span><span class="p">,</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>                <span class="n">sk_col</span><span class="p">,</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>                <span class="n">orphan_handling</span><span class="p">,</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>                <span class="n">dim_table</span><span class="p">,</span>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>                <span class="n">quarantine_config</span><span class="p">,</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>            <span class="p">)</span>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="n">total_orphans</span> <span class="o">+=</span> <span class="n">orphan_count</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="k">if</span> <span class="n">quarantined</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>                <span class="n">all_quarantined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">quarantined</span><span class="p">)</span>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>        <span class="n">quarantined_df</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>        <span class="k">if</span> <span class="n">all_quarantined</span><span class="p">:</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>            <span class="n">quarantined_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_union_dataframes</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">all_quarantined</span><span class="p">)</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="k">return</span> <span class="n">df</span><span class="p">,</span> <span class="n">total_orphans</span><span class="p">,</span> <span class="n">quarantined_df</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_union_dataframes</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">dfs</span><span class="p">:</span> <span class="n">List</span><span class="p">):</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Union multiple DataFrames together.&quot;&quot;&quot;</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">dfs</span><span class="p">:</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>            <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">dfs</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>                <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">allowMissingColumns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">dfs</span><span class="p">,</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_get_dimension_df</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">dim_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">is_scd2</span><span class="p">:</span> <span class="nb">bool</span><span class="p">):</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Get dimension DataFrame from context, optionally filtering for current records.&quot;&quot;&quot;</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="n">dim_df</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">dim_table</span><span class="p">)</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>            <span class="k">return</span> <span class="kc">None</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>        <span class="k">if</span> <span class="n">is_scd2</span><span class="p">:</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>            <span class="n">is_current_col</span> <span class="o">=</span> <span class="s2">&quot;is_current&quot;</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>            <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>                <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                <span class="k">if</span> <span class="n">is_current_col</span> <span class="ow">in</span> <span class="n">dim_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>                    <span class="n">dim_df</span> <span class="o">=</span> <span class="n">dim_df</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">is_current_col</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span>  <span class="c1"># noqa: E712</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="k">if</span> <span class="n">is_current_col</span> <span class="ow">in</span> <span class="n">dim_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>                    <span class="n">dim_df</span> <span class="o">=</span> <span class="n">dim_df</span><span class="p">[</span><span class="n">dim_df</span><span class="p">[</span><span class="n">is_current_col</span><span class="p">]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># noqa: E712</span>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="k">return</span> <span class="n">dim_df</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_join_dimension</span><span class="p">(</span>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>        <span class="n">fact_df</span><span class="p">,</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>        <span class="n">dim_df</span><span class="p">,</span>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>        <span class="n">source_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>        <span class="n">dim_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>        <span class="n">sk_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>        <span class="n">orphan_handling</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>        <span class="n">dim_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>        <span class="n">quarantine_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>    <span class="p">):</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a><span class="sd">        Join fact to dimension and retrieve surrogate key.</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a><span class="sd">            Tuple of (result_df, orphan_count, quarantined_df)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_dimension_spark</span><span class="p">(</span>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>                <span class="n">context</span><span class="p">,</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="n">fact_df</span><span class="p">,</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>                <span class="n">dim_df</span><span class="p">,</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>                <span class="n">source_col</span><span class="p">,</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                <span class="n">dim_key</span><span class="p">,</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                <span class="n">sk_col</span><span class="p">,</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                <span class="n">orphan_handling</span><span class="p">,</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                <span class="n">dim_table</span><span class="p">,</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                <span class="n">quarantine_config</span><span class="p">,</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>            <span class="p">)</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_join_dimension_pandas</span><span class="p">(</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>                <span class="n">fact_df</span><span class="p">,</span>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>                <span class="n">dim_df</span><span class="p">,</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>                <span class="n">source_col</span><span class="p">,</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>                <span class="n">dim_key</span><span class="p">,</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>                <span class="n">sk_col</span><span class="p">,</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>                <span class="n">orphan_handling</span><span class="p">,</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>                <span class="n">dim_table</span><span class="p">,</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>                <span class="n">quarantine_config</span><span class="p">,</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>            <span class="p">)</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_join_dimension_spark</span><span class="p">(</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>        <span class="n">fact_df</span><span class="p">,</span>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="n">dim_df</span><span class="p">,</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>        <span class="n">source_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>        <span class="n">dim_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>        <span class="n">sk_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>        <span class="n">orphan_handling</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>        <span class="n">dim_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>        <span class="n">quarantine_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>    <span class="p">):</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>        <span class="c1"># Use a unique alias for the SK column to avoid ambiguity if sk_col</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>        <span class="c1"># already exists in fact_df (e.g., from a previous dimension lookup)</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>        <span class="n">sk_alias</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">sk_col</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>        <span class="n">dim_subset</span> <span class="o">=</span> <span class="n">dim_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>            <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">dim_key</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>            <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">sk_col</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">sk_alias</span><span class="p">),</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>        <span class="p">)</span>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>        <span class="n">joined</span> <span class="o">=</span> <span class="n">fact_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="n">dim_subset</span><span class="p">,</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="n">fact_df</span><span class="p">[</span><span class="n">source_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">dim_subset</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">],</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>            <span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>        <span class="p">)</span>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>        <span class="c1"># If sk_col already existed in fact_df, drop the old one and rename the new one</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>        <span class="k">if</span> <span class="n">sk_col</span> <span class="ow">in</span> <span class="n">fact_df</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>            <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">fact_df</span><span class="p">[</span><span class="n">sk_col</span><span class="p">])</span>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>        <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="n">sk_alias</span><span class="p">,</span> <span class="n">sk_col</span><span class="p">)</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>        <span class="n">orphan_mask</span> <span class="o">=</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">sk_col</span><span class="p">)</span><span class="o">.</span><span class="n">isNull</span><span class="p">()</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>        <span class="n">orphan_count</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">orphan_mask</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>        <span class="n">quarantined_df</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>        <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;reject&quot;</span> <span class="ow">and</span> <span class="n">orphan_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern: </span><span class="si">{</span><span class="n">orphan_count</span><span class="si">}</span><span class="s2"> orphan records found for dimension &quot;</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                <span class="sa">f</span><span class="s2">&quot;lookup on &#39;</span><span class="si">{</span><span class="n">source_col</span><span class="si">}</span><span class="s2">&#39;. Orphan handling is set to &#39;reject&#39;.&quot;</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>            <span class="p">)</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>        <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>            <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">sk_col</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">sk_col</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">)))</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>        <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;quarantine&quot;</span> <span class="ow">and</span> <span class="n">orphan_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>            <span class="n">orphan_rows</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">orphan_mask</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>            <span class="n">orphan_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_quarantine_metadata_spark</span><span class="p">(</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>                <span class="n">orphan_rows</span><span class="p">,</span> <span class="n">dim_table</span><span class="p">,</span> <span class="n">source_col</span><span class="p">,</span> <span class="n">quarantine_config</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>            <span class="p">)</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>            <span class="n">quarantined_df</span> <span class="o">=</span> <span class="n">orphan_rows</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>            <span class="n">joined</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">orphan_mask</span><span class="p">)</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">joined</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="n">orphan_count</span><span class="p">,</span> <span class="n">quarantined_df</span>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_join_dimension_pandas</span><span class="p">(</span>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="n">fact_df</span><span class="p">,</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="n">dim_df</span><span class="p">,</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="n">source_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="n">dim_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="n">sk_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="n">orphan_handling</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>        <span class="n">dim_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a>        <span class="n">quarantine_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a>    <span class="p">):</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>        <span class="n">dim_subset</span> <span class="o">=</span> <span class="n">dim_df</span><span class="p">[[</span><span class="n">dim_key</span><span class="p">,</span> <span class="n">sk_col</span><span class="p">]]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="n">dim_subset</span> <span class="o">=</span> <span class="n">dim_subset</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">dim_key</span><span class="p">:</span> <span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">})</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>        <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="n">fact_df</span><span class="p">,</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>            <span class="n">dim_subset</span><span class="p">,</span>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="n">left_on</span><span class="o">=</span><span class="n">source_col</span><span class="p">,</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>            <span class="n">right_on</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>        <span class="p">)</span>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>        <span class="n">orphan_mask</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">sk_col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>        <span class="n">orphan_count</span> <span class="o">=</span> <span class="n">orphan_mask</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>        <span class="n">quarantined_df</span> <span class="o">=</span> <span class="kc">None</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>        <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;reject&quot;</span> <span class="ow">and</span> <span class="n">orphan_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): </span><span class="si">{</span><span class="n">orphan_count</span><span class="si">}</span><span class="s2"> orphan records found for dimension &quot;</span>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>                <span class="sa">f</span><span class="s2">&quot;lookup on &#39;</span><span class="si">{</span><span class="n">source_col</span><span class="si">}</span><span class="s2">&#39; -&gt; &#39;</span><span class="si">{</span><span class="n">dim_table</span><span class="si">}</span><span class="s2">&#39;. Orphan handling is set to &#39;reject&#39;. &quot;</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>                <span class="sa">f</span><span class="s2">&quot;Fix: Either update orphan_handling to &#39;unknown&#39; or &#39;quarantine&#39;, or ensure all &#39;</span><span class="si">{</span><span class="n">source_col</span><span class="si">}</span><span class="s2">&#39; values exist in &#39;</span><span class="si">{</span><span class="n">dim_table</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>            <span class="p">)</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>        <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;unknown&quot;</span><span class="p">:</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>            <span class="n">merged</span><span class="p">[</span><span class="n">sk_col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">sk_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>        <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;quarantine&quot;</span> <span class="ow">and</span> <span class="n">orphan_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>            <span class="n">orphan_rows</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">orphan_mask</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>            <span class="n">orphan_rows</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_quarantine_metadata_pandas</span><span class="p">(</span>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>                <span class="n">orphan_rows</span><span class="p">,</span> <span class="n">dim_table</span><span class="p">,</span> <span class="n">source_col</span><span class="p">,</span> <span class="n">quarantine_config</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>            <span class="p">)</span>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>            <span class="n">quarantined_df</span> <span class="o">=</span> <span class="n">orphan_rows</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>            <span class="n">merged</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="o">~</span><span class="n">orphan_mask</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">merged</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;_dim_</span><span class="si">{</span><span class="n">dim_key</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">])</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>        <span class="k">return</span> <span class="n">result</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">orphan_count</span><span class="p">),</span> <span class="n">quarantined_df</span>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_measures</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">measures</span><span class="p">:</span> <span class="n">List</span><span class="p">):</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a><span class="sd">        Apply measure transformations.</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a><span class="sd">        Measures can be:</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a><span class="sd">        - String: passthrough column name</span>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a><span class="sd">        - Dict with single key-value: rename or calculate</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a><span class="sd">          - {&quot;new_name&quot;: &quot;old_name&quot;} -&gt; rename</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a><span class="sd">          - {&quot;new_name&quot;: &quot;expr&quot;} -&gt; calculate (if expr contains operators)</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>        <span class="k">for</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>                <span class="k">continue</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>                <span class="k">for</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">measure</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_expression</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>                        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_calculated_measure</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">new_name</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>                    <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-568" name="__codelineno-0-568"></a>                        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rename_column</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
<a id="__codelineno-0-569" name="__codelineno-0-569"></a>
<a id="__codelineno-0-570" name="__codelineno-0-570"></a>        <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-571" name="__codelineno-0-571"></a>
<a id="__codelineno-0-572" name="__codelineno-0-572"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_is_expression</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<a id="__codelineno-0-573" name="__codelineno-0-573"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Check if string is a calculation expression vs a column name.</span>
<a id="__codelineno-0-574" name="__codelineno-0-574"></a>
<a id="__codelineno-0-575" name="__codelineno-0-575"></a><span class="sd">        Operators like + - * / must be surrounded by spaces to count as</span>
<a id="__codelineno-0-576" name="__codelineno-0-576"></a><span class="sd">        expression operators. Parentheses always indicate an expression.</span>
<a id="__codelineno-0-577" name="__codelineno-0-577"></a><span class="sd">        This avoids treating column names with hyphens (e.g. &#39;total-cost&#39;)</span>
<a id="__codelineno-0-578" name="__codelineno-0-578"></a><span class="sd">        as expressions.</span>
<a id="__codelineno-0-579" name="__codelineno-0-579"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-580" name="__codelineno-0-580"></a>        <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">expr</span> <span class="ow">or</span> <span class="s2">&quot;)&quot;</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
<a id="__codelineno-0-581" name="__codelineno-0-581"></a>            <span class="k">return</span> <span class="kc">True</span>
<a id="__codelineno-0-582" name="__codelineno-0-582"></a>        <span class="n">spaced_operators</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; + &quot;</span><span class="p">,</span> <span class="s2">&quot; - &quot;</span><span class="p">,</span> <span class="s2">&quot; * &quot;</span><span class="p">,</span> <span class="s2">&quot; / &quot;</span><span class="p">]</span>
<a id="__codelineno-0-583" name="__codelineno-0-583"></a>        <span class="k">return</span> <span class="nb">any</span><span class="p">(</span><span class="n">op</span> <span class="ow">in</span> <span class="n">expr</span> <span class="k">for</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">spaced_operators</span><span class="p">)</span>
<a id="__codelineno-0-584" name="__codelineno-0-584"></a>
<a id="__codelineno-0-585" name="__codelineno-0-585"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add_calculated_measure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-586" name="__codelineno-0-586"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a calculated measure column using an expression.</span>
<a id="__codelineno-0-587" name="__codelineno-0-587"></a>
<a id="__codelineno-0-588" name="__codelineno-0-588"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-589" name="__codelineno-0-589"></a><span class="sd">            context: Engine context containing engine type and configuration.</span>
<a id="__codelineno-0-590" name="__codelineno-0-590"></a><span class="sd">            df: The DataFrame to add the calculated measure to.</span>
<a id="__codelineno-0-591" name="__codelineno-0-591"></a><span class="sd">            name: The name of the new calculated measure column.</span>
<a id="__codelineno-0-592" name="__codelineno-0-592"></a><span class="sd">            expr: The expression to evaluate for the calculated measure.</span>
<a id="__codelineno-0-593" name="__codelineno-0-593"></a>
<a id="__codelineno-0-594" name="__codelineno-0-594"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-595" name="__codelineno-0-595"></a><span class="sd">            DataFrame with the new calculated measure column added.</span>
<a id="__codelineno-0-596" name="__codelineno-0-596"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-597" name="__codelineno-0-597"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-598" name="__codelineno-0-598"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-599" name="__codelineno-0-599"></a>
<a id="__codelineno-0-600" name="__codelineno-0-600"></a>            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">expr</span><span class="p">))</span>
<a id="__codelineno-0-601" name="__codelineno-0-601"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-602" name="__codelineno-0-602"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-603" name="__codelineno-0-603"></a>            <span class="n">df</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">eval</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
<a id="__codelineno-0-604" name="__codelineno-0-604"></a>            <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-605" name="__codelineno-0-605"></a>
<a id="__codelineno-0-606" name="__codelineno-0-606"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_rename_column</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">old_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">new_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">):</span>
<a id="__codelineno-0-607" name="__codelineno-0-607"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Rename a column in the DataFrame.</span>
<a id="__codelineno-0-608" name="__codelineno-0-608"></a>
<a id="__codelineno-0-609" name="__codelineno-0-609"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-610" name="__codelineno-0-610"></a><span class="sd">            context: Engine context containing engine type and configuration.</span>
<a id="__codelineno-0-611" name="__codelineno-0-611"></a><span class="sd">            df: The DataFrame containing the column to rename.</span>
<a id="__codelineno-0-612" name="__codelineno-0-612"></a><span class="sd">            old_name: The current name of the column.</span>
<a id="__codelineno-0-613" name="__codelineno-0-613"></a><span class="sd">            new_name: The new name for the column.</span>
<a id="__codelineno-0-614" name="__codelineno-0-614"></a>
<a id="__codelineno-0-615" name="__codelineno-0-615"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-616" name="__codelineno-0-616"></a><span class="sd">            DataFrame with the column renamed.</span>
<a id="__codelineno-0-617" name="__codelineno-0-617"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-618" name="__codelineno-0-618"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-619" name="__codelineno-0-619"></a>            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span><span class="p">)</span>
<a id="__codelineno-0-620" name="__codelineno-0-620"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-621" name="__codelineno-0-621"></a>            <span class="k">return</span> <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">old_name</span><span class="p">:</span> <span class="n">new_name</span><span class="p">})</span>
<a id="__codelineno-0-622" name="__codelineno-0-622"></a>
<a id="__codelineno-0-623" name="__codelineno-0-623"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_validate_grain</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-624" name="__codelineno-0-624"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-625" name="__codelineno-0-625"></a><span class="sd">        Validate that no duplicate rows exist at the grain level.</span>
<a id="__codelineno-0-626" name="__codelineno-0-626"></a>
<a id="__codelineno-0-627" name="__codelineno-0-627"></a><span class="sd">        Raises ValueError if duplicates are found.</span>
<a id="__codelineno-0-628" name="__codelineno-0-628"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-629" name="__codelineno-0-629"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-630" name="__codelineno-0-630"></a>
<a id="__codelineno-0-631" name="__codelineno-0-631"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-632" name="__codelineno-0-632"></a>            <span class="n">total_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-633" name="__codelineno-0-633"></a>            <span class="n">distinct_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">grain</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<a id="__codelineno-0-634" name="__codelineno-0-634"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-635" name="__codelineno-0-635"></a>            <span class="n">total_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-636" name="__codelineno-0-636"></a>            <span class="n">distinct_count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">(</span><span class="n">subset</span><span class="o">=</span><span class="n">grain</span><span class="p">))</span>
<a id="__codelineno-0-637" name="__codelineno-0-637"></a>
<a id="__codelineno-0-638" name="__codelineno-0-638"></a>        <span class="k">if</span> <span class="n">total_count</span> <span class="o">!=</span> <span class="n">distinct_count</span><span class="p">:</span>
<a id="__codelineno-0-639" name="__codelineno-0-639"></a>            <span class="n">duplicate_count</span> <span class="o">=</span> <span class="n">total_count</span> <span class="o">-</span> <span class="n">distinct_count</span>
<a id="__codelineno-0-640" name="__codelineno-0-640"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-641" name="__codelineno-0-641"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern grain validation failed: </span><span class="si">{</span><span class="n">duplicate_count</span><span class="si">}</span><span class="s2"> duplicate rows&quot;</span><span class="p">,</span>
<a id="__codelineno-0-642" name="__codelineno-0-642"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-643" name="__codelineno-0-643"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-644" name="__codelineno-0-644"></a>                <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-645" name="__codelineno-0-645"></a>                <span class="n">total_rows</span><span class="o">=</span><span class="n">total_count</span><span class="p">,</span>
<a id="__codelineno-0-646" name="__codelineno-0-646"></a>                <span class="n">distinct_rows</span><span class="o">=</span><span class="n">distinct_count</span><span class="p">,</span>
<a id="__codelineno-0-647" name="__codelineno-0-647"></a>            <span class="p">)</span>
<a id="__codelineno-0-648" name="__codelineno-0-648"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-649" name="__codelineno-0-649"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): Grain validation failed. Found </span><span class="si">{</span><span class="n">duplicate_count</span><span class="si">}</span><span class="s2"> duplicate &quot;</span>
<a id="__codelineno-0-650" name="__codelineno-0-650"></a>                <span class="sa">f</span><span class="s2">&quot;rows at grain level </span><span class="si">{</span><span class="n">grain</span><span class="si">}</span><span class="s2">. Total rows: </span><span class="si">{</span><span class="n">total_count</span><span class="si">}</span><span class="s2">, &quot;</span>
<a id="__codelineno-0-651" name="__codelineno-0-651"></a>                <span class="sa">f</span><span class="s2">&quot;Distinct rows: </span><span class="si">{</span><span class="n">distinct_count</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-652" name="__codelineno-0-652"></a>                <span class="sa">f</span><span class="s2">&quot;Fix: Check for duplicate data in source or add deduplication before grain validation.&quot;</span>
<a id="__codelineno-0-653" name="__codelineno-0-653"></a>            <span class="p">)</span>
<a id="__codelineno-0-654" name="__codelineno-0-654"></a>
<a id="__codelineno-0-655" name="__codelineno-0-655"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-656" name="__codelineno-0-656"></a>            <span class="s2">&quot;FactPattern grain validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-657" name="__codelineno-0-657"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-658" name="__codelineno-0-658"></a>            <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-659" name="__codelineno-0-659"></a>            <span class="n">total_rows</span><span class="o">=</span><span class="n">total_count</span><span class="p">,</span>
<a id="__codelineno-0-660" name="__codelineno-0-660"></a>        <span class="p">)</span>
<a id="__codelineno-0-661" name="__codelineno-0-661"></a>
<a id="__codelineno-0-662" name="__codelineno-0-662"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add_quarantine_metadata_spark</span><span class="p">(</span>
<a id="__codelineno-0-663" name="__codelineno-0-663"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-664" name="__codelineno-0-664"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-665" name="__codelineno-0-665"></a>        <span class="n">dim_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-666" name="__codelineno-0-666"></a>        <span class="n">source_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-667" name="__codelineno-0-667"></a>        <span class="n">quarantine_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-0-668" name="__codelineno-0-668"></a>    <span class="p">):</span>
<a id="__codelineno-0-669" name="__codelineno-0-669"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add metadata columns to quarantined Spark DataFrame.</span>
<a id="__codelineno-0-670" name="__codelineno-0-670"></a>
<a id="__codelineno-0-671" name="__codelineno-0-671"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-672" name="__codelineno-0-672"></a><span class="sd">            df: The Spark DataFrame containing quarantined records.</span>
<a id="__codelineno-0-673" name="__codelineno-0-673"></a><span class="sd">            dim_table: Name of the dimension table that caused the orphan rejection.</span>
<a id="__codelineno-0-674" name="__codelineno-0-674"></a><span class="sd">            source_col: Name of the source column that failed the dimension lookup.</span>
<a id="__codelineno-0-675" name="__codelineno-0-675"></a><span class="sd">            quarantine_config: Configuration dictionary with &#39;add_columns&#39; specifying</span>
<a id="__codelineno-0-676" name="__codelineno-0-676"></a><span class="sd">                which metadata columns to add (_rejection_reason, _rejected_at, _source_dimension).</span>
<a id="__codelineno-0-677" name="__codelineno-0-677"></a>
<a id="__codelineno-0-678" name="__codelineno-0-678"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-679" name="__codelineno-0-679"></a><span class="sd">            Spark DataFrame with quarantine metadata columns added.</span>
<a id="__codelineno-0-680" name="__codelineno-0-680"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-681" name="__codelineno-0-681"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-682" name="__codelineno-0-682"></a>
<a id="__codelineno-0-683" name="__codelineno-0-683"></a>        <span class="n">add_columns</span> <span class="o">=</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_columns&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-684" name="__codelineno-0-684"></a>
<a id="__codelineno-0-685" name="__codelineno-0-685"></a>        <span class="k">if</span> <span class="n">add_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_rejection_reason&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-686" name="__codelineno-0-686"></a>            <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Orphan record: no match in dimension &#39;</span><span class="si">{</span><span class="n">dim_table</span><span class="si">}</span><span class="s2">&#39; on column &#39;</span><span class="si">{</span><span class="n">source_col</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-0-687" name="__codelineno-0-687"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;_rejection_reason&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">reason</span><span class="p">))</span>
<a id="__codelineno-0-688" name="__codelineno-0-688"></a>
<a id="__codelineno-0-689" name="__codelineno-0-689"></a>        <span class="k">if</span> <span class="n">add_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_rejected_at&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-690" name="__codelineno-0-690"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;_rejected_at&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">current_timestamp</span><span class="p">())</span>
<a id="__codelineno-0-691" name="__codelineno-0-691"></a>
<a id="__codelineno-0-692" name="__codelineno-0-692"></a>        <span class="k">if</span> <span class="n">add_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_source_dimension&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-693" name="__codelineno-0-693"></a>            <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">withColumn</span><span class="p">(</span><span class="s2">&quot;_source_dimension&quot;</span><span class="p">,</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="n">dim_table</span><span class="p">))</span>
<a id="__codelineno-0-694" name="__codelineno-0-694"></a>
<a id="__codelineno-0-695" name="__codelineno-0-695"></a>        <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-696" name="__codelineno-0-696"></a>
<a id="__codelineno-0-697" name="__codelineno-0-697"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_add_quarantine_metadata_pandas</span><span class="p">(</span>
<a id="__codelineno-0-698" name="__codelineno-0-698"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-699" name="__codelineno-0-699"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-700" name="__codelineno-0-700"></a>        <span class="n">dim_table</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-701" name="__codelineno-0-701"></a>        <span class="n">source_col</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-702" name="__codelineno-0-702"></a>        <span class="n">quarantine_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-0-703" name="__codelineno-0-703"></a>    <span class="p">):</span>
<a id="__codelineno-0-704" name="__codelineno-0-704"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Add metadata columns to quarantined Pandas DataFrame.</span>
<a id="__codelineno-0-705" name="__codelineno-0-705"></a>
<a id="__codelineno-0-706" name="__codelineno-0-706"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-707" name="__codelineno-0-707"></a><span class="sd">            df: The Pandas DataFrame containing quarantined records.</span>
<a id="__codelineno-0-708" name="__codelineno-0-708"></a><span class="sd">            dim_table: Name of the dimension table that caused the orphan rejection.</span>
<a id="__codelineno-0-709" name="__codelineno-0-709"></a><span class="sd">            source_col: Name of the source column that failed the dimension lookup.</span>
<a id="__codelineno-0-710" name="__codelineno-0-710"></a><span class="sd">            quarantine_config: Configuration dictionary with &#39;add_columns&#39; specifying</span>
<a id="__codelineno-0-711" name="__codelineno-0-711"></a><span class="sd">                which metadata columns to add (_rejection_reason, _rejected_at, _source_dimension).</span>
<a id="__codelineno-0-712" name="__codelineno-0-712"></a>
<a id="__codelineno-0-713" name="__codelineno-0-713"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-714" name="__codelineno-0-714"></a><span class="sd">            Pandas DataFrame with quarantine metadata columns added.</span>
<a id="__codelineno-0-715" name="__codelineno-0-715"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-716" name="__codelineno-0-716"></a>        <span class="n">add_columns</span> <span class="o">=</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;add_columns&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-717" name="__codelineno-0-717"></a>
<a id="__codelineno-0-718" name="__codelineno-0-718"></a>        <span class="k">if</span> <span class="n">add_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_rejection_reason&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-719" name="__codelineno-0-719"></a>            <span class="n">reason</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Orphan record: no match in dimension &#39;</span><span class="si">{</span><span class="n">dim_table</span><span class="si">}</span><span class="s2">&#39; on column &#39;</span><span class="si">{</span><span class="n">source_col</span><span class="si">}</span><span class="s2">&#39;&quot;</span>
<a id="__codelineno-0-720" name="__codelineno-0-720"></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_rejection_reason&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">reason</span>
<a id="__codelineno-0-721" name="__codelineno-0-721"></a>
<a id="__codelineno-0-722" name="__codelineno-0-722"></a>        <span class="k">if</span> <span class="n">add_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_rejected_at&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-723" name="__codelineno-0-723"></a>            <span class="c1"># Use timezone-aware timestamp for Delta Lake compatibility</span>
<a id="__codelineno-0-724" name="__codelineno-0-724"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">datetime</span><span class="w"> </span><span class="kn">import</span> <span class="n">timezone</span>
<a id="__codelineno-0-725" name="__codelineno-0-725"></a>
<a id="__codelineno-0-726" name="__codelineno-0-726"></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_rejected_at&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">(</span><span class="n">timezone</span><span class="o">.</span><span class="n">utc</span><span class="p">)</span>
<a id="__codelineno-0-727" name="__codelineno-0-727"></a>
<a id="__codelineno-0-728" name="__codelineno-0-728"></a>        <span class="k">if</span> <span class="n">add_columns</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_source_dimension&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
<a id="__codelineno-0-729" name="__codelineno-0-729"></a>            <span class="n">df</span><span class="p">[</span><span class="s2">&quot;_source_dimension&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">dim_table</span>
<a id="__codelineno-0-730" name="__codelineno-0-730"></a>
<a id="__codelineno-0-731" name="__codelineno-0-731"></a>        <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-732" name="__codelineno-0-732"></a>
<a id="__codelineno-0-733" name="__codelineno-0-733"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_write_quarantine</span><span class="p">(</span>
<a id="__codelineno-0-734" name="__codelineno-0-734"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-735" name="__codelineno-0-735"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-736" name="__codelineno-0-736"></a>        <span class="n">quarantined_df</span><span class="p">,</span>
<a id="__codelineno-0-737" name="__codelineno-0-737"></a>        <span class="n">quarantine_config</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-0-738" name="__codelineno-0-738"></a>    <span class="p">):</span>
<a id="__codelineno-0-739" name="__codelineno-0-739"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Write quarantined records to the configured destination.</span>
<a id="__codelineno-0-740" name="__codelineno-0-740"></a>
<a id="__codelineno-0-741" name="__codelineno-0-741"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-742" name="__codelineno-0-742"></a><span class="sd">            context: Engine context containing engine type and configuration.</span>
<a id="__codelineno-0-743" name="__codelineno-0-743"></a><span class="sd">            quarantined_df: DataFrame containing the quarantined orphan records.</span>
<a id="__codelineno-0-744" name="__codelineno-0-744"></a><span class="sd">            quarantine_config: Configuration dictionary specifying destination with keys:</span>
<a id="__codelineno-0-745" name="__codelineno-0-745"></a><span class="sd">                &#39;connection&#39;, &#39;path&#39;, and/or &#39;table&#39;.</span>
<a id="__codelineno-0-746" name="__codelineno-0-746"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-747" name="__codelineno-0-747"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-748" name="__codelineno-0-748"></a>        <span class="n">connection</span> <span class="o">=</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">)</span>
<a id="__codelineno-0-749" name="__codelineno-0-749"></a>        <span class="n">path</span> <span class="o">=</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-750" name="__codelineno-0-750"></a>        <span class="n">table</span> <span class="o">=</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">)</span>
<a id="__codelineno-0-751" name="__codelineno-0-751"></a>
<a id="__codelineno-0-752" name="__codelineno-0-752"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-753" name="__codelineno-0-753"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_write_quarantine_spark</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">quarantined_df</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
<a id="__codelineno-0-754" name="__codelineno-0-754"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-755" name="__codelineno-0-755"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_write_quarantine_pandas</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">quarantined_df</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
<a id="__codelineno-0-756" name="__codelineno-0-756"></a>
<a id="__codelineno-0-757" name="__codelineno-0-757"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-758" name="__codelineno-0-758"></a>            <span class="s2">&quot;Quarantine data written&quot;</span><span class="p">,</span>
<a id="__codelineno-0-759" name="__codelineno-0-759"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-760" name="__codelineno-0-760"></a>            <span class="n">connection</span><span class="o">=</span><span class="n">connection</span><span class="p">,</span>
<a id="__codelineno-0-761" name="__codelineno-0-761"></a>            <span class="n">destination</span><span class="o">=</span><span class="n">path</span> <span class="ow">or</span> <span class="n">table</span><span class="p">,</span>
<a id="__codelineno-0-762" name="__codelineno-0-762"></a>        <span class="p">)</span>
<a id="__codelineno-0-763" name="__codelineno-0-763"></a>
<a id="__codelineno-0-764" name="__codelineno-0-764"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_write_quarantine_spark</span><span class="p">(</span>
<a id="__codelineno-0-765" name="__codelineno-0-765"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-766" name="__codelineno-0-766"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-767" name="__codelineno-0-767"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-768" name="__codelineno-0-768"></a>        <span class="n">connection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-769" name="__codelineno-0-769"></a>        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-770" name="__codelineno-0-770"></a>        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-771" name="__codelineno-0-771"></a>    <span class="p">):</span>
<a id="__codelineno-0-772" name="__codelineno-0-772"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Write quarantine data using Spark to Delta Lake format.</span>
<a id="__codelineno-0-773" name="__codelineno-0-773"></a>
<a id="__codelineno-0-774" name="__codelineno-0-774"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-775" name="__codelineno-0-775"></a><span class="sd">            context: Engine context with engine instance for connection resolution.</span>
<a id="__codelineno-0-776" name="__codelineno-0-776"></a><span class="sd">            df: Spark DataFrame containing quarantined records.</span>
<a id="__codelineno-0-777" name="__codelineno-0-777"></a><span class="sd">            connection: Connection name for resolving paths.</span>
<a id="__codelineno-0-778" name="__codelineno-0-778"></a><span class="sd">            path: Optional file path for quarantine storage.</span>
<a id="__codelineno-0-779" name="__codelineno-0-779"></a><span class="sd">            table: Optional table name for quarantine storage.</span>
<a id="__codelineno-0-780" name="__codelineno-0-780"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-781" name="__codelineno-0-781"></a>        <span class="k">if</span> <span class="n">table</span><span class="p">:</span>
<a id="__codelineno-0-782" name="__codelineno-0-782"></a>            <span class="n">full_table</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">connection</span><span class="si">}</span><span class="s2">.</span><span class="si">{</span><span class="n">table</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">connection</span> <span class="k">else</span> <span class="n">table</span>
<a id="__codelineno-0-783" name="__codelineno-0-783"></a>            <span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">saveAsTable</span><span class="p">(</span><span class="n">full_table</span><span class="p">)</span>
<a id="__codelineno-0-784" name="__codelineno-0-784"></a>        <span class="k">elif</span> <span class="n">path</span><span class="p">:</span>
<a id="__codelineno-0-785" name="__codelineno-0-785"></a>            <span class="n">full_path</span> <span class="o">=</span> <span class="n">path</span>
<a id="__codelineno-0-786" name="__codelineno-0-786"></a>            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;engine&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">engine</span><span class="p">:</span>
<a id="__codelineno-0-787" name="__codelineno-0-787"></a>                <span class="k">if</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;connections&quot;</span><span class="p">,</span> <span class="p">{}):</span>
<a id="__codelineno-0-788" name="__codelineno-0-788"></a>                    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-789" name="__codelineno-0-789"></a>                        <span class="n">full_path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
<a id="__codelineno-0-790" name="__codelineno-0-790"></a>                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-791" name="__codelineno-0-791"></a>                        <span class="k">pass</span>
<a id="__codelineno-0-792" name="__codelineno-0-792"></a>            <span class="n">df</span><span class="o">.</span><span class="n">write</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="s2">&quot;delta&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mode</span><span class="p">(</span><span class="s2">&quot;append&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
<a id="__codelineno-0-793" name="__codelineno-0-793"></a>
<a id="__codelineno-0-794" name="__codelineno-0-794"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_write_quarantine_pandas</span><span class="p">(</span>
<a id="__codelineno-0-795" name="__codelineno-0-795"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-796" name="__codelineno-0-796"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-797" name="__codelineno-0-797"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-798" name="__codelineno-0-798"></a>        <span class="n">connection</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-799" name="__codelineno-0-799"></a>        <span class="n">path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-800" name="__codelineno-0-800"></a>        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-801" name="__codelineno-0-801"></a>    <span class="p">):</span>
<a id="__codelineno-0-802" name="__codelineno-0-802"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Write quarantine data using Pandas to Delta Lake or SQL Server.</span>
<a id="__codelineno-0-803" name="__codelineno-0-803"></a>
<a id="__codelineno-0-804" name="__codelineno-0-804"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-805" name="__codelineno-0-805"></a><span class="sd">            context: Engine context with engine instance for connection resolution.</span>
<a id="__codelineno-0-806" name="__codelineno-0-806"></a><span class="sd">            df: Pandas DataFrame containing quarantined records.</span>
<a id="__codelineno-0-807" name="__codelineno-0-807"></a><span class="sd">            connection: Connection name for resolving paths or database connections.</span>
<a id="__codelineno-0-808" name="__codelineno-0-808"></a><span class="sd">            path: Optional file path for quarantine storage (Delta Lake).</span>
<a id="__codelineno-0-809" name="__codelineno-0-809"></a><span class="sd">            table: Optional table name for quarantine storage (SQL Server).</span>
<a id="__codelineno-0-810" name="__codelineno-0-810"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-811" name="__codelineno-0-811"></a>        <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
<a id="__codelineno-0-812" name="__codelineno-0-812"></a>
<a id="__codelineno-0-813" name="__codelineno-0-813"></a>        <span class="n">destination</span> <span class="o">=</span> <span class="n">path</span> <span class="ow">or</span> <span class="n">table</span>
<a id="__codelineno-0-814" name="__codelineno-0-814"></a>        <span class="n">full_path</span> <span class="o">=</span> <span class="n">destination</span>
<a id="__codelineno-0-815" name="__codelineno-0-815"></a>
<a id="__codelineno-0-816" name="__codelineno-0-816"></a>        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="s2">&quot;engine&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">context</span><span class="o">.</span><span class="n">engine</span><span class="p">:</span>
<a id="__codelineno-0-817" name="__codelineno-0-817"></a>            <span class="k">if</span> <span class="n">connection</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">engine</span><span class="p">,</span> <span class="s2">&quot;connections&quot;</span><span class="p">,</span> <span class="p">{}):</span>
<a id="__codelineno-0-818" name="__codelineno-0-818"></a>                <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-819" name="__codelineno-0-819"></a>                    <span class="n">full_path</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">connections</span><span class="p">[</span><span class="n">connection</span><span class="p">]</span><span class="o">.</span><span class="n">get_path</span><span class="p">(</span><span class="n">destination</span><span class="p">)</span>
<a id="__codelineno-0-820" name="__codelineno-0-820"></a>                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
<a id="__codelineno-0-821" name="__codelineno-0-821"></a>                    <span class="k">pass</span>
<a id="__codelineno-0-822" name="__codelineno-0-822"></a>
<a id="__codelineno-0-823" name="__codelineno-0-823"></a>        <span class="n">path_lower</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
<a id="__codelineno-0-824" name="__codelineno-0-824"></a>
<a id="__codelineno-0-825" name="__codelineno-0-825"></a>        <span class="c1"># Create parent directories if needed</span>
<a id="__codelineno-0-826" name="__codelineno-0-826"></a>        <span class="n">dir_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
<a id="__codelineno-0-827" name="__codelineno-0-827"></a>        <span class="k">if</span> <span class="n">dir_name</span><span class="p">:</span>
<a id="__codelineno-0-828" name="__codelineno-0-828"></a>            <span class="n">os</span><span class="o">.</span><span class="n">makedirs</span><span class="p">(</span><span class="n">dir_name</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-829" name="__codelineno-0-829"></a>
<a id="__codelineno-0-830" name="__codelineno-0-830"></a>        <span class="k">if</span> <span class="n">path_lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
<a id="__codelineno-0-831" name="__codelineno-0-831"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
<a id="__codelineno-0-832" name="__codelineno-0-832"></a>                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-833" name="__codelineno-0-833"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-834" name="__codelineno-0-834"></a>                <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-835" name="__codelineno-0-835"></a>        <span class="k">elif</span> <span class="n">path_lower</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
<a id="__codelineno-0-836" name="__codelineno-0-836"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
<a id="__codelineno-0-837" name="__codelineno-0-837"></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-838" name="__codelineno-0-838"></a>
<a id="__codelineno-0-839" name="__codelineno-0-839"></a>                <span class="n">existing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
<a id="__codelineno-0-840" name="__codelineno-0-840"></a>                <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">existing</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-841" name="__codelineno-0-841"></a>                <span class="n">combined</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
<a id="__codelineno-0-842" name="__codelineno-0-842"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-843" name="__codelineno-0-843"></a>                <span class="n">df</span><span class="o">.</span><span class="n">to_json</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
<a id="__codelineno-0-844" name="__codelineno-0-844"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-845" name="__codelineno-0-845"></a>            <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">full_path</span><span class="p">):</span>
<a id="__codelineno-0-846" name="__codelineno-0-846"></a>                <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-847" name="__codelineno-0-847"></a>
<a id="__codelineno-0-848" name="__codelineno-0-848"></a>                <span class="n">existing</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">full_path</span><span class="p">)</span>
<a id="__codelineno-0-849" name="__codelineno-0-849"></a>                <span class="n">combined</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">existing</span><span class="p">,</span> <span class="n">df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-850" name="__codelineno-0-850"></a>                <span class="n">combined</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-851" name="__codelineno-0-851"></a>            <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-852" name="__codelineno-0-852"></a>                <span class="n">df</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">full_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.fact.FactPattern.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

<a href="#odibi.patterns.fact.FactPattern.execute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Execute the fact pattern to build a fact table with surrogate key lookups.</p>
<p>Builds a fact table with automatic surrogate key lookups from dimension tables.
The execution flow:
1. Deduplicate source data if configured
2. Perform dimension lookups to replace natural keys with surrogate keys
3. Handle orphan records (unknown SK=0, reject with error, or quarantine)
4. Apply measure calculations and transformations if configured
5. Validate grain (check for duplicates) if grain is specified
6. Add audit columns (load_timestamp, source_system) if configured</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="odibi.context.EngineContext">EngineContext</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine context containing the source DataFrame, dimension tables,
and execution environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Fact DataFrame with surrogate keys from dimension lookups and all transformations applied.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If orphan records are found and orphan_handling='reject', if grain
validation fails (duplicates found), or if dimension lookup fails.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If quarantine write fails or measure calculations fail.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/fact.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-197" name="__codelineno-0-197"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the fact pattern to build a fact table with surrogate key lookups.</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a><span class="sd">    Builds a fact table with automatic surrogate key lookups from dimension tables.</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a><span class="sd">    The execution flow:</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a><span class="sd">    1. Deduplicate source data if configured</span>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a><span class="sd">    2. Perform dimension lookups to replace natural keys with surrogate keys</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a><span class="sd">    3. Handle orphan records (unknown SK=0, reject with error, or quarantine)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a><span class="sd">    4. Apply measure calculations and transformations if configured</span>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a><span class="sd">    5. Validate grain (check for duplicates) if grain is specified</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a><span class="sd">    6. Add audit columns (load_timestamp, source_system) if configured</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a><span class="sd">        context: Engine context containing the source DataFrame, dimension tables,</span>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a><span class="sd">            and execution environment.</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a><span class="sd">        Fact DataFrame with surrogate keys from dimension lookups and all transformations applied.</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a><span class="sd">        ValueError: If orphan records are found and orphan_handling=&#39;reject&#39;, if grain</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a><span class="sd">            validation fails (duplicates found), or if dimension lookup fails.</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a><span class="sd">        Exception: If quarantine write fails or measure calculations fail.</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>    <span class="n">deduplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deduplicate&quot;</span><span class="p">)</span>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>    <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>    <span class="n">grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>    <span class="n">orphan_handling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orphan_handling&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>    <span class="n">quarantine_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quarantine&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>    <span class="n">measures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;measures&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>    <span class="n">audit_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audit&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>        <span class="s2">&quot;FactPattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="n">deduplicate</span><span class="o">=</span><span class="n">deduplicate</span><span class="p">,</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>        <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="n">dimensions_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">),</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">orphan_handling</span><span class="o">=</span><span class="n">orphan_handling</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>    <span class="p">)</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>    <span class="n">source_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Fact source loaded&quot;</span><span class="p">,</span> <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span> <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">)</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a>        <span class="k">if</span> <span class="n">deduplicate</span> <span class="ow">and</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a>            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_deduplicate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">keys</span><span class="p">)</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a>                <span class="s2">&quot;Fact deduplication complete&quot;</span><span class="p">,</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a>                <span class="n">rows_after</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">),</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>            <span class="p">)</span>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a>        <span class="k">if</span> <span class="n">dimensions</span><span class="p">:</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a>            <span class="n">df</span><span class="p">,</span> <span class="n">orphan_count</span><span class="p">,</span> <span class="n">quarantined_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lookup_dimensions</span><span class="p">(</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">dimensions</span><span class="p">,</span> <span class="n">orphan_handling</span><span class="p">,</span> <span class="n">quarantine_config</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>                <span class="s2">&quot;Fact dimension lookups complete&quot;</span><span class="p">,</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>                <span class="n">orphan_count</span><span class="o">=</span><span class="n">orphan_count</span><span class="p">,</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>            <span class="p">)</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>            <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;quarantine&quot;</span> <span class="ow">and</span> <span class="n">quarantined_df</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">_write_quarantine</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">quarantined_df</span><span class="p">,</span> <span class="n">quarantine_config</span><span class="p">)</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>                    <span class="sa">f</span><span class="s2">&quot;Quarantined </span><span class="si">{</span><span class="n">orphan_count</span><span class="si">}</span><span class="s2"> orphan records&quot;</span><span class="p">,</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a>                    <span class="n">quarantine_path</span><span class="o">=</span><span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>                    <span class="ow">or</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">),</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>                <span class="p">)</span>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>        <span class="k">if</span> <span class="n">measures</span><span class="p">:</span>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>            <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_measures</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">measures</span><span class="p">)</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>        <span class="k">if</span> <span class="n">grain</span><span class="p">:</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">_validate_grain</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">grain</span><span class="p">)</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>        <span class="n">df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_audit_columns</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">audit_config</span><span class="p">)</span>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>        <span class="n">result_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>            <span class="s2">&quot;FactPattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>            <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>            <span class="n">result_rows</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="p">)</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="k">return</span> <span class="n">df</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>            <span class="sa">f</span><span class="s2">&quot;FactPattern failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>        <span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.fact.FactPattern.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

<a href="#odibi.patterns.fact.FactPattern.validate" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Validate fact pattern configuration parameters.</p>
<p>Ensures that all required parameters are present and valid. Checks that:
- keys are provided when deduplicate is True
- orphan_handling is valid ('unknown', 'reject', or 'quarantine')
- quarantine config is complete when orphan_handling='quarantine'
- all dimension lookups have required fields (source_column, dimension_table, etc.)</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If keys are missing for deduplication, orphan_handling is invalid,
quarantine config is incomplete, or dimension configs are missing required fields.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/fact.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-87" name="__codelineno-0-87"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate fact pattern configuration parameters.</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a><span class="sd">    Ensures that all required parameters are present and valid. Checks that:</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a><span class="sd">    - keys are provided when deduplicate is True</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a><span class="sd">    - orphan_handling is valid (&#39;unknown&#39;, &#39;reject&#39;, or &#39;quarantine&#39;)</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a><span class="sd">    - quarantine config is complete when orphan_handling=&#39;quarantine&#39;</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a><span class="sd">    - all dimension lookups have required fields (source_column, dimension_table, etc.)</span>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a><span class="sd">        ValueError: If keys are missing for deduplication, orphan_handling is invalid,</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a><span class="sd">            quarantine config is incomplete, or dimension configs are missing required fields.</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>    <span class="n">deduplicate</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;deduplicate&quot;</span><span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>    <span class="n">keys</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;keys&quot;</span><span class="p">)</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>    <span class="n">grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>    <span class="n">dimensions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;dimensions&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>    <span class="n">orphan_handling</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;orphan_handling&quot;</span><span class="p">,</span> <span class="s2">&quot;unknown&quot;</span><span class="p">)</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>        <span class="s2">&quot;FactPattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>        <span class="n">deduplicate</span><span class="o">=</span><span class="n">deduplicate</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>        <span class="n">keys</span><span class="o">=</span><span class="n">keys</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>        <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>        <span class="n">dimensions_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">dimensions</span><span class="p">),</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>    <span class="p">)</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>    <span class="k">if</span> <span class="n">deduplicate</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">keys</span><span class="p">:</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="s2">&quot;FactPattern validation failed: &#39;keys&#39; required when &#39;deduplicate&#39; is True&quot;</span><span class="p">,</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>        <span class="p">)</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;keys&#39; required when &#39;deduplicate&#39; is True. &quot;</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>            <span class="s2">&quot;Keys define which columns uniquely identify a fact row for deduplication. &quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>            <span class="s2">&quot;Provide keys=[&#39;col1&#39;, &#39;col2&#39;] to specify the deduplication columns.&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>        <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="k">if</span> <span class="n">orphan_handling</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;unknown&quot;</span><span class="p">,</span> <span class="s2">&quot;reject&quot;</span><span class="p">,</span> <span class="s2">&quot;quarantine&quot;</span><span class="p">):</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="sa">f</span><span class="s2">&quot;FactPattern validation failed: invalid orphan_handling &#39;</span><span class="si">{</span><span class="n">orphan_handling</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>        <span class="p">)</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;orphan_handling&#39; must be &#39;unknown&#39;, &#39;reject&#39;, or &#39;quarantine&#39;. &quot;</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">orphan_handling</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>        <span class="p">)</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>    <span class="k">if</span> <span class="n">orphan_handling</span> <span class="o">==</span> <span class="s2">&quot;quarantine&quot;</span><span class="p">:</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>        <span class="n">quarantine_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;quarantine&quot;</span><span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">quarantine_config</span><span class="p">:</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="s2">&quot;FactPattern validation failed: &#39;quarantine&#39; config required &quot;</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="s2">&quot;when orphan_handling=&#39;quarantine&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;quarantine&#39; configuration is required when &quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="s2">&quot;orphan_handling=&#39;quarantine&#39;.&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;connection&quot;</span><span class="p">):</span>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>                <span class="s2">&quot;FactPattern validation failed: quarantine.connection is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>            <span class="p">)</span>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;quarantine.connection&#39; is required. &quot;</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>                <span class="s2">&quot;The connection specifies where to write quarantined orphan records &quot;</span>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a>                <span class="s2">&quot;(e.g., a Spark session or database connection). &quot;</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a>                <span class="s2">&quot;Add &#39;connection&#39; to your quarantine config.&quot;</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a>            <span class="p">)</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">quarantine_config</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;table&quot;</span><span class="p">):</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a>                <span class="s2">&quot;FactPattern validation failed: quarantine requires &#39;path&#39; or &#39;table&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a>            <span class="p">)</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a>                <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;quarantine&#39; requires either &#39;path&#39; or &#39;table&#39;. &quot;</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a>                <span class="sa">f</span><span class="s2">&quot;Got config: </span><span class="si">{</span><span class="n">quarantine_config</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>                <span class="s2">&quot;Add &#39;path&#39; for file storage or &#39;table&#39; for database storage.&quot;</span>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a>            <span class="p">)</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dim</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">dimensions</span><span class="p">):</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">required_keys</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;source_column&quot;</span><span class="p">,</span> <span class="s2">&quot;dimension_table&quot;</span><span class="p">,</span> <span class="s2">&quot;dimension_key&quot;</span><span class="p">,</span> <span class="s2">&quot;surrogate_key&quot;</span><span class="p">]</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">required_keys</span><span class="p">:</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dim</span><span class="p">:</span>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>                    <span class="sa">f</span><span class="s2">&quot;FactPattern validation failed: dimension[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>                <span class="p">)</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>                    <span class="sa">f</span><span class="s2">&quot;FactPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): dimension[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing required key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;. &quot;</span>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>                    <span class="sa">f</span><span class="s2">&quot;Required keys: </span><span class="si">{</span><span class="n">required_keys</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>                    <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">dim</span><span class="si">}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>                    <span class="sa">f</span><span class="s2">&quot;Ensure all required keys are provided in the dimension config.&quot;</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>                <span class="p">)</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="s2">&quot;FactPattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;FactPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="odibi.patterns.aggregation" class="doc doc-heading">
            <code>odibi.patterns.aggregation</code>


<a href="#odibi.patterns.aggregation" class="headerlink" title="Permanent link">&para;</a></h2>

    <div class="doc doc-contents first">










<div class="doc doc-children">









<div class="doc doc-object doc-class">



<h3 id="odibi.patterns.aggregation.AggregationPattern" class="doc doc-heading">
            <code>AggregationPattern</code>


<a href="#odibi.patterns.aggregation.AggregationPattern" class="headerlink" title="Permanent link">&para;</a></h3>


    <div class="doc doc-contents ">
            <p class="doc doc-class-bases">
              Bases: <code><span title="odibi.patterns.base.Pattern">Pattern</span></code></p>



        <p>Aggregation Pattern: Declarative aggregation with time-grain rollups.</p>
<p>Features:
- Declare grain (GROUP BY columns)
- Declare measures with aggregation functions
- Incremental aggregation (merge new data with existing)
- Time rollups (generate multiple grain levels)
- Audit columns</p>
<p>Configuration Options (via params dict):
    - <strong>grain</strong> (list): Columns to GROUP BY (defines uniqueness)
    - <strong>measures</strong> (list): Measure definitions with name and aggregation expr
        - name: Output column name
        - expr: SQL aggregation expression (e.g., "SUM(amount)")
    - <strong>incremental</strong> (dict): Incremental merge configuration (optional)
        - timestamp_column: Column to identify new data
        - merge_strategy: "replace", "sum", "min", or "max"
    - <strong>having</strong> (str): Optional HAVING clause for filtering aggregates
    - <strong>audit</strong> (dict): Audit column configuration</p>


<details class="example-config" open>
  <summary>Example Config</summary>
  <p>pattern:
  type: aggregation
  params:
    grain: [date_sk, product_sk]
    measures:
      - name: total_revenue
        expr: "SUM(total_amount)"
      - name: order_count
        expr: "COUNT(<em>)"
      - name: avg_order_value
        expr: "AVG(total_amount)"
    having: "COUNT(</em>) &gt; 0"
    audit:
      load_timestamp: true</p>
</details>







              <details class="mkdocstrings-source">
                <summary>Source code in <code>odibi/patterns/aggregation.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-10"> 10</a></span>
<span class="normal"><a href="#__codelineno-0-11"> 11</a></span>
<span class="normal"><a href="#__codelineno-0-12"> 12</a></span>
<span class="normal"><a href="#__codelineno-0-13"> 13</a></span>
<span class="normal"><a href="#__codelineno-0-14"> 14</a></span>
<span class="normal"><a href="#__codelineno-0-15"> 15</a></span>
<span class="normal"><a href="#__codelineno-0-16"> 16</a></span>
<span class="normal"><a href="#__codelineno-0-17"> 17</a></span>
<span class="normal"><a href="#__codelineno-0-18"> 18</a></span>
<span class="normal"><a href="#__codelineno-0-19"> 19</a></span>
<span class="normal"><a href="#__codelineno-0-20"> 20</a></span>
<span class="normal"><a href="#__codelineno-0-21"> 21</a></span>
<span class="normal"><a href="#__codelineno-0-22"> 22</a></span>
<span class="normal"><a href="#__codelineno-0-23"> 23</a></span>
<span class="normal"><a href="#__codelineno-0-24"> 24</a></span>
<span class="normal"><a href="#__codelineno-0-25"> 25</a></span>
<span class="normal"><a href="#__codelineno-0-26"> 26</a></span>
<span class="normal"><a href="#__codelineno-0-27"> 27</a></span>
<span class="normal"><a href="#__codelineno-0-28"> 28</a></span>
<span class="normal"><a href="#__codelineno-0-29"> 29</a></span>
<span class="normal"><a href="#__codelineno-0-30"> 30</a></span>
<span class="normal"><a href="#__codelineno-0-31"> 31</a></span>
<span class="normal"><a href="#__codelineno-0-32"> 32</a></span>
<span class="normal"><a href="#__codelineno-0-33"> 33</a></span>
<span class="normal"><a href="#__codelineno-0-34"> 34</a></span>
<span class="normal"><a href="#__codelineno-0-35"> 35</a></span>
<span class="normal"><a href="#__codelineno-0-36"> 36</a></span>
<span class="normal"><a href="#__codelineno-0-37"> 37</a></span>
<span class="normal"><a href="#__codelineno-0-38"> 38</a></span>
<span class="normal"><a href="#__codelineno-0-39"> 39</a></span>
<span class="normal"><a href="#__codelineno-0-40"> 40</a></span>
<span class="normal"><a href="#__codelineno-0-41"> 41</a></span>
<span class="normal"><a href="#__codelineno-0-42"> 42</a></span>
<span class="normal"><a href="#__codelineno-0-43"> 43</a></span>
<span class="normal"><a href="#__codelineno-0-44"> 44</a></span>
<span class="normal"><a href="#__codelineno-0-45"> 45</a></span>
<span class="normal"><a href="#__codelineno-0-46"> 46</a></span>
<span class="normal"><a href="#__codelineno-0-47"> 47</a></span>
<span class="normal"><a href="#__codelineno-0-48"> 48</a></span>
<span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span>
<span class="normal"><a href="#__codelineno-0-157">157</a></span>
<span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span>
<span class="normal"><a href="#__codelineno-0-237">237</a></span>
<span class="normal"><a href="#__codelineno-0-238">238</a></span>
<span class="normal"><a href="#__codelineno-0-239">239</a></span>
<span class="normal"><a href="#__codelineno-0-240">240</a></span>
<span class="normal"><a href="#__codelineno-0-241">241</a></span>
<span class="normal"><a href="#__codelineno-0-242">242</a></span>
<span class="normal"><a href="#__codelineno-0-243">243</a></span>
<span class="normal"><a href="#__codelineno-0-244">244</a></span>
<span class="normal"><a href="#__codelineno-0-245">245</a></span>
<span class="normal"><a href="#__codelineno-0-246">246</a></span>
<span class="normal"><a href="#__codelineno-0-247">247</a></span>
<span class="normal"><a href="#__codelineno-0-248">248</a></span>
<span class="normal"><a href="#__codelineno-0-249">249</a></span>
<span class="normal"><a href="#__codelineno-0-250">250</a></span>
<span class="normal"><a href="#__codelineno-0-251">251</a></span>
<span class="normal"><a href="#__codelineno-0-252">252</a></span>
<span class="normal"><a href="#__codelineno-0-253">253</a></span>
<span class="normal"><a href="#__codelineno-0-254">254</a></span>
<span class="normal"><a href="#__codelineno-0-255">255</a></span>
<span class="normal"><a href="#__codelineno-0-256">256</a></span>
<span class="normal"><a href="#__codelineno-0-257">257</a></span>
<span class="normal"><a href="#__codelineno-0-258">258</a></span>
<span class="normal"><a href="#__codelineno-0-259">259</a></span>
<span class="normal"><a href="#__codelineno-0-260">260</a></span>
<span class="normal"><a href="#__codelineno-0-261">261</a></span>
<span class="normal"><a href="#__codelineno-0-262">262</a></span>
<span class="normal"><a href="#__codelineno-0-263">263</a></span>
<span class="normal"><a href="#__codelineno-0-264">264</a></span>
<span class="normal"><a href="#__codelineno-0-265">265</a></span>
<span class="normal"><a href="#__codelineno-0-266">266</a></span>
<span class="normal"><a href="#__codelineno-0-267">267</a></span>
<span class="normal"><a href="#__codelineno-0-268">268</a></span>
<span class="normal"><a href="#__codelineno-0-269">269</a></span>
<span class="normal"><a href="#__codelineno-0-270">270</a></span>
<span class="normal"><a href="#__codelineno-0-271">271</a></span>
<span class="normal"><a href="#__codelineno-0-272">272</a></span>
<span class="normal"><a href="#__codelineno-0-273">273</a></span>
<span class="normal"><a href="#__codelineno-0-274">274</a></span>
<span class="normal"><a href="#__codelineno-0-275">275</a></span>
<span class="normal"><a href="#__codelineno-0-276">276</a></span>
<span class="normal"><a href="#__codelineno-0-277">277</a></span>
<span class="normal"><a href="#__codelineno-0-278">278</a></span>
<span class="normal"><a href="#__codelineno-0-279">279</a></span>
<span class="normal"><a href="#__codelineno-0-280">280</a></span>
<span class="normal"><a href="#__codelineno-0-281">281</a></span>
<span class="normal"><a href="#__codelineno-0-282">282</a></span>
<span class="normal"><a href="#__codelineno-0-283">283</a></span>
<span class="normal"><a href="#__codelineno-0-284">284</a></span>
<span class="normal"><a href="#__codelineno-0-285">285</a></span>
<span class="normal"><a href="#__codelineno-0-286">286</a></span>
<span class="normal"><a href="#__codelineno-0-287">287</a></span>
<span class="normal"><a href="#__codelineno-0-288">288</a></span>
<span class="normal"><a href="#__codelineno-0-289">289</a></span>
<span class="normal"><a href="#__codelineno-0-290">290</a></span>
<span class="normal"><a href="#__codelineno-0-291">291</a></span>
<span class="normal"><a href="#__codelineno-0-292">292</a></span>
<span class="normal"><a href="#__codelineno-0-293">293</a></span>
<span class="normal"><a href="#__codelineno-0-294">294</a></span>
<span class="normal"><a href="#__codelineno-0-295">295</a></span>
<span class="normal"><a href="#__codelineno-0-296">296</a></span>
<span class="normal"><a href="#__codelineno-0-297">297</a></span>
<span class="normal"><a href="#__codelineno-0-298">298</a></span>
<span class="normal"><a href="#__codelineno-0-299">299</a></span>
<span class="normal"><a href="#__codelineno-0-300">300</a></span>
<span class="normal"><a href="#__codelineno-0-301">301</a></span>
<span class="normal"><a href="#__codelineno-0-302">302</a></span>
<span class="normal"><a href="#__codelineno-0-303">303</a></span>
<span class="normal"><a href="#__codelineno-0-304">304</a></span>
<span class="normal"><a href="#__codelineno-0-305">305</a></span>
<span class="normal"><a href="#__codelineno-0-306">306</a></span>
<span class="normal"><a href="#__codelineno-0-307">307</a></span>
<span class="normal"><a href="#__codelineno-0-308">308</a></span>
<span class="normal"><a href="#__codelineno-0-309">309</a></span>
<span class="normal"><a href="#__codelineno-0-310">310</a></span>
<span class="normal"><a href="#__codelineno-0-311">311</a></span>
<span class="normal"><a href="#__codelineno-0-312">312</a></span>
<span class="normal"><a href="#__codelineno-0-313">313</a></span>
<span class="normal"><a href="#__codelineno-0-314">314</a></span>
<span class="normal"><a href="#__codelineno-0-315">315</a></span>
<span class="normal"><a href="#__codelineno-0-316">316</a></span>
<span class="normal"><a href="#__codelineno-0-317">317</a></span>
<span class="normal"><a href="#__codelineno-0-318">318</a></span>
<span class="normal"><a href="#__codelineno-0-319">319</a></span>
<span class="normal"><a href="#__codelineno-0-320">320</a></span>
<span class="normal"><a href="#__codelineno-0-321">321</a></span>
<span class="normal"><a href="#__codelineno-0-322">322</a></span>
<span class="normal"><a href="#__codelineno-0-323">323</a></span>
<span class="normal"><a href="#__codelineno-0-324">324</a></span>
<span class="normal"><a href="#__codelineno-0-325">325</a></span>
<span class="normal"><a href="#__codelineno-0-326">326</a></span>
<span class="normal"><a href="#__codelineno-0-327">327</a></span>
<span class="normal"><a href="#__codelineno-0-328">328</a></span>
<span class="normal"><a href="#__codelineno-0-329">329</a></span>
<span class="normal"><a href="#__codelineno-0-330">330</a></span>
<span class="normal"><a href="#__codelineno-0-331">331</a></span>
<span class="normal"><a href="#__codelineno-0-332">332</a></span>
<span class="normal"><a href="#__codelineno-0-333">333</a></span>
<span class="normal"><a href="#__codelineno-0-334">334</a></span>
<span class="normal"><a href="#__codelineno-0-335">335</a></span>
<span class="normal"><a href="#__codelineno-0-336">336</a></span>
<span class="normal"><a href="#__codelineno-0-337">337</a></span>
<span class="normal"><a href="#__codelineno-0-338">338</a></span>
<span class="normal"><a href="#__codelineno-0-339">339</a></span>
<span class="normal"><a href="#__codelineno-0-340">340</a></span>
<span class="normal"><a href="#__codelineno-0-341">341</a></span>
<span class="normal"><a href="#__codelineno-0-342">342</a></span>
<span class="normal"><a href="#__codelineno-0-343">343</a></span>
<span class="normal"><a href="#__codelineno-0-344">344</a></span>
<span class="normal"><a href="#__codelineno-0-345">345</a></span>
<span class="normal"><a href="#__codelineno-0-346">346</a></span>
<span class="normal"><a href="#__codelineno-0-347">347</a></span>
<span class="normal"><a href="#__codelineno-0-348">348</a></span>
<span class="normal"><a href="#__codelineno-0-349">349</a></span>
<span class="normal"><a href="#__codelineno-0-350">350</a></span>
<span class="normal"><a href="#__codelineno-0-351">351</a></span>
<span class="normal"><a href="#__codelineno-0-352">352</a></span>
<span class="normal"><a href="#__codelineno-0-353">353</a></span>
<span class="normal"><a href="#__codelineno-0-354">354</a></span>
<span class="normal"><a href="#__codelineno-0-355">355</a></span>
<span class="normal"><a href="#__codelineno-0-356">356</a></span>
<span class="normal"><a href="#__codelineno-0-357">357</a></span>
<span class="normal"><a href="#__codelineno-0-358">358</a></span>
<span class="normal"><a href="#__codelineno-0-359">359</a></span>
<span class="normal"><a href="#__codelineno-0-360">360</a></span>
<span class="normal"><a href="#__codelineno-0-361">361</a></span>
<span class="normal"><a href="#__codelineno-0-362">362</a></span>
<span class="normal"><a href="#__codelineno-0-363">363</a></span>
<span class="normal"><a href="#__codelineno-0-364">364</a></span>
<span class="normal"><a href="#__codelineno-0-365">365</a></span>
<span class="normal"><a href="#__codelineno-0-366">366</a></span>
<span class="normal"><a href="#__codelineno-0-367">367</a></span>
<span class="normal"><a href="#__codelineno-0-368">368</a></span>
<span class="normal"><a href="#__codelineno-0-369">369</a></span>
<span class="normal"><a href="#__codelineno-0-370">370</a></span>
<span class="normal"><a href="#__codelineno-0-371">371</a></span>
<span class="normal"><a href="#__codelineno-0-372">372</a></span>
<span class="normal"><a href="#__codelineno-0-373">373</a></span>
<span class="normal"><a href="#__codelineno-0-374">374</a></span>
<span class="normal"><a href="#__codelineno-0-375">375</a></span>
<span class="normal"><a href="#__codelineno-0-376">376</a></span>
<span class="normal"><a href="#__codelineno-0-377">377</a></span>
<span class="normal"><a href="#__codelineno-0-378">378</a></span>
<span class="normal"><a href="#__codelineno-0-379">379</a></span>
<span class="normal"><a href="#__codelineno-0-380">380</a></span>
<span class="normal"><a href="#__codelineno-0-381">381</a></span>
<span class="normal"><a href="#__codelineno-0-382">382</a></span>
<span class="normal"><a href="#__codelineno-0-383">383</a></span>
<span class="normal"><a href="#__codelineno-0-384">384</a></span>
<span class="normal"><a href="#__codelineno-0-385">385</a></span>
<span class="normal"><a href="#__codelineno-0-386">386</a></span>
<span class="normal"><a href="#__codelineno-0-387">387</a></span>
<span class="normal"><a href="#__codelineno-0-388">388</a></span>
<span class="normal"><a href="#__codelineno-0-389">389</a></span>
<span class="normal"><a href="#__codelineno-0-390">390</a></span>
<span class="normal"><a href="#__codelineno-0-391">391</a></span>
<span class="normal"><a href="#__codelineno-0-392">392</a></span>
<span class="normal"><a href="#__codelineno-0-393">393</a></span>
<span class="normal"><a href="#__codelineno-0-394">394</a></span>
<span class="normal"><a href="#__codelineno-0-395">395</a></span>
<span class="normal"><a href="#__codelineno-0-396">396</a></span>
<span class="normal"><a href="#__codelineno-0-397">397</a></span>
<span class="normal"><a href="#__codelineno-0-398">398</a></span>
<span class="normal"><a href="#__codelineno-0-399">399</a></span>
<span class="normal"><a href="#__codelineno-0-400">400</a></span>
<span class="normal"><a href="#__codelineno-0-401">401</a></span>
<span class="normal"><a href="#__codelineno-0-402">402</a></span>
<span class="normal"><a href="#__codelineno-0-403">403</a></span>
<span class="normal"><a href="#__codelineno-0-404">404</a></span>
<span class="normal"><a href="#__codelineno-0-405">405</a></span>
<span class="normal"><a href="#__codelineno-0-406">406</a></span>
<span class="normal"><a href="#__codelineno-0-407">407</a></span>
<span class="normal"><a href="#__codelineno-0-408">408</a></span>
<span class="normal"><a href="#__codelineno-0-409">409</a></span>
<span class="normal"><a href="#__codelineno-0-410">410</a></span>
<span class="normal"><a href="#__codelineno-0-411">411</a></span>
<span class="normal"><a href="#__codelineno-0-412">412</a></span>
<span class="normal"><a href="#__codelineno-0-413">413</a></span>
<span class="normal"><a href="#__codelineno-0-414">414</a></span>
<span class="normal"><a href="#__codelineno-0-415">415</a></span>
<span class="normal"><a href="#__codelineno-0-416">416</a></span>
<span class="normal"><a href="#__codelineno-0-417">417</a></span>
<span class="normal"><a href="#__codelineno-0-418">418</a></span>
<span class="normal"><a href="#__codelineno-0-419">419</a></span>
<span class="normal"><a href="#__codelineno-0-420">420</a></span>
<span class="normal"><a href="#__codelineno-0-421">421</a></span>
<span class="normal"><a href="#__codelineno-0-422">422</a></span>
<span class="normal"><a href="#__codelineno-0-423">423</a></span>
<span class="normal"><a href="#__codelineno-0-424">424</a></span>
<span class="normal"><a href="#__codelineno-0-425">425</a></span>
<span class="normal"><a href="#__codelineno-0-426">426</a></span>
<span class="normal"><a href="#__codelineno-0-427">427</a></span>
<span class="normal"><a href="#__codelineno-0-428">428</a></span>
<span class="normal"><a href="#__codelineno-0-429">429</a></span>
<span class="normal"><a href="#__codelineno-0-430">430</a></span>
<span class="normal"><a href="#__codelineno-0-431">431</a></span>
<span class="normal"><a href="#__codelineno-0-432">432</a></span>
<span class="normal"><a href="#__codelineno-0-433">433</a></span>
<span class="normal"><a href="#__codelineno-0-434">434</a></span>
<span class="normal"><a href="#__codelineno-0-435">435</a></span>
<span class="normal"><a href="#__codelineno-0-436">436</a></span>
<span class="normal"><a href="#__codelineno-0-437">437</a></span>
<span class="normal"><a href="#__codelineno-0-438">438</a></span>
<span class="normal"><a href="#__codelineno-0-439">439</a></span>
<span class="normal"><a href="#__codelineno-0-440">440</a></span>
<span class="normal"><a href="#__codelineno-0-441">441</a></span>
<span class="normal"><a href="#__codelineno-0-442">442</a></span>
<span class="normal"><a href="#__codelineno-0-443">443</a></span>
<span class="normal"><a href="#__codelineno-0-444">444</a></span>
<span class="normal"><a href="#__codelineno-0-445">445</a></span>
<span class="normal"><a href="#__codelineno-0-446">446</a></span>
<span class="normal"><a href="#__codelineno-0-447">447</a></span>
<span class="normal"><a href="#__codelineno-0-448">448</a></span>
<span class="normal"><a href="#__codelineno-0-449">449</a></span>
<span class="normal"><a href="#__codelineno-0-450">450</a></span>
<span class="normal"><a href="#__codelineno-0-451">451</a></span>
<span class="normal"><a href="#__codelineno-0-452">452</a></span>
<span class="normal"><a href="#__codelineno-0-453">453</a></span>
<span class="normal"><a href="#__codelineno-0-454">454</a></span>
<span class="normal"><a href="#__codelineno-0-455">455</a></span>
<span class="normal"><a href="#__codelineno-0-456">456</a></span>
<span class="normal"><a href="#__codelineno-0-457">457</a></span>
<span class="normal"><a href="#__codelineno-0-458">458</a></span>
<span class="normal"><a href="#__codelineno-0-459">459</a></span>
<span class="normal"><a href="#__codelineno-0-460">460</a></span>
<span class="normal"><a href="#__codelineno-0-461">461</a></span>
<span class="normal"><a href="#__codelineno-0-462">462</a></span>
<span class="normal"><a href="#__codelineno-0-463">463</a></span>
<span class="normal"><a href="#__codelineno-0-464">464</a></span>
<span class="normal"><a href="#__codelineno-0-465">465</a></span>
<span class="normal"><a href="#__codelineno-0-466">466</a></span>
<span class="normal"><a href="#__codelineno-0-467">467</a></span>
<span class="normal"><a href="#__codelineno-0-468">468</a></span>
<span class="normal"><a href="#__codelineno-0-469">469</a></span>
<span class="normal"><a href="#__codelineno-0-470">470</a></span>
<span class="normal"><a href="#__codelineno-0-471">471</a></span>
<span class="normal"><a href="#__codelineno-0-472">472</a></span>
<span class="normal"><a href="#__codelineno-0-473">473</a></span>
<span class="normal"><a href="#__codelineno-0-474">474</a></span>
<span class="normal"><a href="#__codelineno-0-475">475</a></span>
<span class="normal"><a href="#__codelineno-0-476">476</a></span>
<span class="normal"><a href="#__codelineno-0-477">477</a></span>
<span class="normal"><a href="#__codelineno-0-478">478</a></span>
<span class="normal"><a href="#__codelineno-0-479">479</a></span>
<span class="normal"><a href="#__codelineno-0-480">480</a></span>
<span class="normal"><a href="#__codelineno-0-481">481</a></span>
<span class="normal"><a href="#__codelineno-0-482">482</a></span>
<span class="normal"><a href="#__codelineno-0-483">483</a></span>
<span class="normal"><a href="#__codelineno-0-484">484</a></span>
<span class="normal"><a href="#__codelineno-0-485">485</a></span>
<span class="normal"><a href="#__codelineno-0-486">486</a></span>
<span class="normal"><a href="#__codelineno-0-487">487</a></span>
<span class="normal"><a href="#__codelineno-0-488">488</a></span>
<span class="normal"><a href="#__codelineno-0-489">489</a></span>
<span class="normal"><a href="#__codelineno-0-490">490</a></span>
<span class="normal"><a href="#__codelineno-0-491">491</a></span>
<span class="normal"><a href="#__codelineno-0-492">492</a></span>
<span class="normal"><a href="#__codelineno-0-493">493</a></span>
<span class="normal"><a href="#__codelineno-0-494">494</a></span>
<span class="normal"><a href="#__codelineno-0-495">495</a></span>
<span class="normal"><a href="#__codelineno-0-496">496</a></span>
<span class="normal"><a href="#__codelineno-0-497">497</a></span>
<span class="normal"><a href="#__codelineno-0-498">498</a></span>
<span class="normal"><a href="#__codelineno-0-499">499</a></span>
<span class="normal"><a href="#__codelineno-0-500">500</a></span>
<span class="normal"><a href="#__codelineno-0-501">501</a></span>
<span class="normal"><a href="#__codelineno-0-502">502</a></span>
<span class="normal"><a href="#__codelineno-0-503">503</a></span>
<span class="normal"><a href="#__codelineno-0-504">504</a></span>
<span class="normal"><a href="#__codelineno-0-505">505</a></span>
<span class="normal"><a href="#__codelineno-0-506">506</a></span>
<span class="normal"><a href="#__codelineno-0-507">507</a></span>
<span class="normal"><a href="#__codelineno-0-508">508</a></span>
<span class="normal"><a href="#__codelineno-0-509">509</a></span>
<span class="normal"><a href="#__codelineno-0-510">510</a></span>
<span class="normal"><a href="#__codelineno-0-511">511</a></span>
<span class="normal"><a href="#__codelineno-0-512">512</a></span>
<span class="normal"><a href="#__codelineno-0-513">513</a></span>
<span class="normal"><a href="#__codelineno-0-514">514</a></span>
<span class="normal"><a href="#__codelineno-0-515">515</a></span>
<span class="normal"><a href="#__codelineno-0-516">516</a></span>
<span class="normal"><a href="#__codelineno-0-517">517</a></span>
<span class="normal"><a href="#__codelineno-0-518">518</a></span>
<span class="normal"><a href="#__codelineno-0-519">519</a></span>
<span class="normal"><a href="#__codelineno-0-520">520</a></span>
<span class="normal"><a href="#__codelineno-0-521">521</a></span>
<span class="normal"><a href="#__codelineno-0-522">522</a></span>
<span class="normal"><a href="#__codelineno-0-523">523</a></span>
<span class="normal"><a href="#__codelineno-0-524">524</a></span>
<span class="normal"><a href="#__codelineno-0-525">525</a></span>
<span class="normal"><a href="#__codelineno-0-526">526</a></span>
<span class="normal"><a href="#__codelineno-0-527">527</a></span>
<span class="normal"><a href="#__codelineno-0-528">528</a></span>
<span class="normal"><a href="#__codelineno-0-529">529</a></span>
<span class="normal"><a href="#__codelineno-0-530">530</a></span>
<span class="normal"><a href="#__codelineno-0-531">531</a></span>
<span class="normal"><a href="#__codelineno-0-532">532</a></span>
<span class="normal"><a href="#__codelineno-0-533">533</a></span>
<span class="normal"><a href="#__codelineno-0-534">534</a></span>
<span class="normal"><a href="#__codelineno-0-535">535</a></span>
<span class="normal"><a href="#__codelineno-0-536">536</a></span>
<span class="normal"><a href="#__codelineno-0-537">537</a></span>
<span class="normal"><a href="#__codelineno-0-538">538</a></span>
<span class="normal"><a href="#__codelineno-0-539">539</a></span>
<span class="normal"><a href="#__codelineno-0-540">540</a></span>
<span class="normal"><a href="#__codelineno-0-541">541</a></span>
<span class="normal"><a href="#__codelineno-0-542">542</a></span>
<span class="normal"><a href="#__codelineno-0-543">543</a></span>
<span class="normal"><a href="#__codelineno-0-544">544</a></span>
<span class="normal"><a href="#__codelineno-0-545">545</a></span>
<span class="normal"><a href="#__codelineno-0-546">546</a></span>
<span class="normal"><a href="#__codelineno-0-547">547</a></span>
<span class="normal"><a href="#__codelineno-0-548">548</a></span>
<span class="normal"><a href="#__codelineno-0-549">549</a></span>
<span class="normal"><a href="#__codelineno-0-550">550</a></span>
<span class="normal"><a href="#__codelineno-0-551">551</a></span>
<span class="normal"><a href="#__codelineno-0-552">552</a></span>
<span class="normal"><a href="#__codelineno-0-553">553</a></span>
<span class="normal"><a href="#__codelineno-0-554">554</a></span>
<span class="normal"><a href="#__codelineno-0-555">555</a></span>
<span class="normal"><a href="#__codelineno-0-556">556</a></span>
<span class="normal"><a href="#__codelineno-0-557">557</a></span>
<span class="normal"><a href="#__codelineno-0-558">558</a></span>
<span class="normal"><a href="#__codelineno-0-559">559</a></span>
<span class="normal"><a href="#__codelineno-0-560">560</a></span>
<span class="normal"><a href="#__codelineno-0-561">561</a></span>
<span class="normal"><a href="#__codelineno-0-562">562</a></span>
<span class="normal"><a href="#__codelineno-0-563">563</a></span>
<span class="normal"><a href="#__codelineno-0-564">564</a></span>
<span class="normal"><a href="#__codelineno-0-565">565</a></span>
<span class="normal"><a href="#__codelineno-0-566">566</a></span>
<span class="normal"><a href="#__codelineno-0-567">567</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-10" name="__codelineno-0-10"></a><span class="k">class</span><span class="w"> </span><span class="nc">AggregationPattern</span><span class="p">(</span><span class="n">Pattern</span><span class="p">):</span>
<a id="__codelineno-0-11" name="__codelineno-0-11"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-12" name="__codelineno-0-12"></a><span class="sd">    Aggregation Pattern: Declarative aggregation with time-grain rollups.</span>
<a id="__codelineno-0-13" name="__codelineno-0-13"></a>
<a id="__codelineno-0-14" name="__codelineno-0-14"></a><span class="sd">    Features:</span>
<a id="__codelineno-0-15" name="__codelineno-0-15"></a><span class="sd">    - Declare grain (GROUP BY columns)</span>
<a id="__codelineno-0-16" name="__codelineno-0-16"></a><span class="sd">    - Declare measures with aggregation functions</span>
<a id="__codelineno-0-17" name="__codelineno-0-17"></a><span class="sd">    - Incremental aggregation (merge new data with existing)</span>
<a id="__codelineno-0-18" name="__codelineno-0-18"></a><span class="sd">    - Time rollups (generate multiple grain levels)</span>
<a id="__codelineno-0-19" name="__codelineno-0-19"></a><span class="sd">    - Audit columns</span>
<a id="__codelineno-0-20" name="__codelineno-0-20"></a>
<a id="__codelineno-0-21" name="__codelineno-0-21"></a><span class="sd">    Configuration Options (via params dict):</span>
<a id="__codelineno-0-22" name="__codelineno-0-22"></a><span class="sd">        - **grain** (list): Columns to GROUP BY (defines uniqueness)</span>
<a id="__codelineno-0-23" name="__codelineno-0-23"></a><span class="sd">        - **measures** (list): Measure definitions with name and aggregation expr</span>
<a id="__codelineno-0-24" name="__codelineno-0-24"></a><span class="sd">            - name: Output column name</span>
<a id="__codelineno-0-25" name="__codelineno-0-25"></a><span class="sd">            - expr: SQL aggregation expression (e.g., &quot;SUM(amount)&quot;)</span>
<a id="__codelineno-0-26" name="__codelineno-0-26"></a><span class="sd">        - **incremental** (dict): Incremental merge configuration (optional)</span>
<a id="__codelineno-0-27" name="__codelineno-0-27"></a><span class="sd">            - timestamp_column: Column to identify new data</span>
<a id="__codelineno-0-28" name="__codelineno-0-28"></a><span class="sd">            - merge_strategy: &quot;replace&quot;, &quot;sum&quot;, &quot;min&quot;, or &quot;max&quot;</span>
<a id="__codelineno-0-29" name="__codelineno-0-29"></a><span class="sd">        - **having** (str): Optional HAVING clause for filtering aggregates</span>
<a id="__codelineno-0-30" name="__codelineno-0-30"></a><span class="sd">        - **audit** (dict): Audit column configuration</span>
<a id="__codelineno-0-31" name="__codelineno-0-31"></a>
<a id="__codelineno-0-32" name="__codelineno-0-32"></a><span class="sd">    Example Config:</span>
<a id="__codelineno-0-33" name="__codelineno-0-33"></a><span class="sd">        pattern:</span>
<a id="__codelineno-0-34" name="__codelineno-0-34"></a><span class="sd">          type: aggregation</span>
<a id="__codelineno-0-35" name="__codelineno-0-35"></a><span class="sd">          params:</span>
<a id="__codelineno-0-36" name="__codelineno-0-36"></a><span class="sd">            grain: [date_sk, product_sk]</span>
<a id="__codelineno-0-37" name="__codelineno-0-37"></a><span class="sd">            measures:</span>
<a id="__codelineno-0-38" name="__codelineno-0-38"></a><span class="sd">              - name: total_revenue</span>
<a id="__codelineno-0-39" name="__codelineno-0-39"></a><span class="sd">                expr: &quot;SUM(total_amount)&quot;</span>
<a id="__codelineno-0-40" name="__codelineno-0-40"></a><span class="sd">              - name: order_count</span>
<a id="__codelineno-0-41" name="__codelineno-0-41"></a><span class="sd">                expr: &quot;COUNT(*)&quot;</span>
<a id="__codelineno-0-42" name="__codelineno-0-42"></a><span class="sd">              - name: avg_order_value</span>
<a id="__codelineno-0-43" name="__codelineno-0-43"></a><span class="sd">                expr: &quot;AVG(total_amount)&quot;</span>
<a id="__codelineno-0-44" name="__codelineno-0-44"></a><span class="sd">            having: &quot;COUNT(*) &gt; 0&quot;</span>
<a id="__codelineno-0-45" name="__codelineno-0-45"></a><span class="sd">            audit:</span>
<a id="__codelineno-0-46" name="__codelineno-0-46"></a><span class="sd">              load_timestamp: true</span>
<a id="__codelineno-0-47" name="__codelineno-0-47"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-48" name="__codelineno-0-48"></a>
<a id="__codelineno-0-49" name="__codelineno-0-49"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Validate aggregation pattern configuration parameters.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">        Ensures that all required parameters are present and valid. Checks that:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">        - grain is specified (list of GROUP BY columns)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">        - measures are provided with correct structure (list of dicts with &#39;name&#39; and &#39;expr&#39;)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">        - incremental config is valid if provided (requires &#39;timestamp_column&#39; and valid merge_strategy)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">            ValueError: If grain is missing, measures are missing/invalid, or incremental config is invalid.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>        <span class="n">grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>        <span class="n">measures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;measures&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>            <span class="s2">&quot;AggregationPattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>            <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>            <span class="n">measures_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">),</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>        <span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">grain</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>                <span class="s2">&quot;AggregationPattern validation failed: &#39;grain&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>            <span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;grain&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>                <span class="s2">&quot;Grain defines the grouping columns for aggregation (e.g., [&#39;date&#39;, &#39;region&#39;]). &quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>                <span class="s2">&quot;Provide a list of column names to group by.&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>            <span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="n">measures</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>                <span class="s2">&quot;AggregationPattern validation failed: &#39;measures&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>            <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;measures&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>                <span class="s2">&quot;Measures define the aggregations to compute (e.g., [{&#39;name&#39;: &#39;total_sales&#39;, &#39;expr&#39;: &#39;sum(amount)&#39;}]). &quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>                <span class="s2">&quot;Provide a list of dicts, each with &#39;name&#39; and &#39;expr&#39; keys.&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>            <span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">measure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measures</span><span class="p">):</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern validation failed: measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] must be a dict&quot;</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>                <span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] must be a dict with &#39;name&#39; and &#39;expr&#39;. &quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                    <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">measure</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">measure</span><span class="si">!r}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                    <span class="s2">&quot;Example: {&#39;name&#39;: &#39;total_sales&#39;, &#39;expr&#39;: &#39;sum(amount)&#39;}&quot;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>                <span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>            <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern validation failed: measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;name&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>                <span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;name&#39;. &quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                    <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">measure</span><span class="si">!r}</span><span class="s2">. Add a &#39;name&#39; key for the output column name.&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>                <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>            <span class="k">if</span> <span class="s2">&quot;expr&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern validation failed: measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;expr&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>                <span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;expr&#39;. &quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                    <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">measure</span><span class="si">!r}</span><span class="s2">. Add an &#39;expr&#39; key with the aggregation expression (e.g., &#39;sum(amount)&#39;).&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>                <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>        <span class="n">incremental</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;incremental&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>        <span class="k">if</span> <span class="n">incremental</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>            <span class="k">if</span> <span class="s2">&quot;timestamp_column&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">incremental</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                    <span class="s2">&quot;AggregationPattern validation failed: incremental missing &#39;timestamp_column&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>                <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): incremental config requires &#39;timestamp_column&#39;. &quot;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                    <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">incremental</span><span class="si">!r}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                    <span class="s2">&quot;Add &#39;timestamp_column&#39; to specify which column tracks record timestamps.&quot;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>                <span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>            <span class="n">merge_strategy</span> <span class="o">=</span> <span class="n">incremental</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;merge_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>            <span class="k">if</span> <span class="n">merge_strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>                <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern validation failed: invalid merge_strategy &#39;</span><span class="si">{</span><span class="n">merge_strategy</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                    <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                    <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>                <span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                    <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;merge_strategy&#39; must be &#39;replace&#39;, &#39;sum&#39;, &#39;min&#39;, or &#39;max&#39;. &quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                    <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">merge_strategy</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>                <span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>            <span class="s2">&quot;AggregationPattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>        <span class="p">)</span>
<a id="__codelineno-0-157" name="__codelineno-0-157"></a>
<a id="__codelineno-0-158" name="__codelineno-0-158"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the aggregation pattern on the input data.</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">        Performs aggregation operations on the source DataFrame, optionally applying incremental</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">        merge with existing target data. The execution flow:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">        1. Aggregate source data by grain columns with specified measures</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">        2. Apply HAVING clause filtering if configured</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">        3. Merge with existing target data if incremental mode is enabled</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">        4. Add audit columns (load_timestamp, source_system) if configured</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">            context: Engine context containing the source DataFrame and execution environment.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">            Aggregated DataFrame with measures computed at the specified grain level.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">        Raises:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">            Exception: If aggregation fails, incremental merge fails, or target loading fails.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>        <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>        <span class="n">grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>        <span class="n">measures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;measures&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>        <span class="n">having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;having&quot;</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>        <span class="n">incremental</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;incremental&quot;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>        <span class="n">audit_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audit&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>        <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>            <span class="s2">&quot;AggregationPattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>            <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>            <span class="n">measures_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">),</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>            <span class="n">incremental</span><span class="o">=</span><span class="n">incremental</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>        <span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>        <span class="n">source_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>            <span class="s2">&quot;Aggregation source loaded&quot;</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>            <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>        <span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>        <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">having</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>            <span class="k">if</span> <span class="n">incremental</span> <span class="ow">and</span> <span class="n">target</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>                <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_incremental</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                    <span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">incremental</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>                <span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_audit_columns</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">audit_config</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>            <span class="n">result_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>                <span class="s2">&quot;AggregationPattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>                <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>                <span class="n">result_rows</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>                <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>            <span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>            <span class="k">return</span> <span class="n">result_df</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>            <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>                <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>                <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>            <span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>            <span class="k">raise</span>
<a id="__codelineno-0-237" name="__codelineno-0-237"></a>
<a id="__codelineno-0-238" name="__codelineno-0-238"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate</span><span class="p">(</span>
<a id="__codelineno-0-239" name="__codelineno-0-239"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-240" name="__codelineno-0-240"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-241" name="__codelineno-0-241"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-242" name="__codelineno-0-242"></a>        <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-243" name="__codelineno-0-243"></a>        <span class="n">measures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-0-244" name="__codelineno-0-244"></a>        <span class="n">having</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-245" name="__codelineno-0-245"></a>    <span class="p">):</span>
<a id="__codelineno-0-246" name="__codelineno-0-246"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Perform the aggregation using SQL.</span>
<a id="__codelineno-0-247" name="__codelineno-0-247"></a>
<a id="__codelineno-0-248" name="__codelineno-0-248"></a><span class="sd">        Args:</span>
<a id="__codelineno-0-249" name="__codelineno-0-249"></a><span class="sd">            context: Engine context containing engine type and configuration.</span>
<a id="__codelineno-0-250" name="__codelineno-0-250"></a><span class="sd">            df: The source DataFrame to aggregate.</span>
<a id="__codelineno-0-251" name="__codelineno-0-251"></a><span class="sd">            grain: List of column names to group by.</span>
<a id="__codelineno-0-252" name="__codelineno-0-252"></a><span class="sd">            measures: List of measure definitions with aggregation functions.</span>
<a id="__codelineno-0-253" name="__codelineno-0-253"></a><span class="sd">            having: Optional SQL HAVING clause filter for post-aggregation filtering.</span>
<a id="__codelineno-0-254" name="__codelineno-0-254"></a>
<a id="__codelineno-0-255" name="__codelineno-0-255"></a><span class="sd">        Returns:</span>
<a id="__codelineno-0-256" name="__codelineno-0-256"></a><span class="sd">            Aggregated DataFrame with grain columns and calculated measures.</span>
<a id="__codelineno-0-257" name="__codelineno-0-257"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-258" name="__codelineno-0-258"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-259" name="__codelineno-0-259"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_spark</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">having</span><span class="p">)</span>
<a id="__codelineno-0-260" name="__codelineno-0-260"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-261" name="__codelineno-0-261"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate_pandas</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">having</span><span class="p">)</span>
<a id="__codelineno-0-262" name="__codelineno-0-262"></a>
<a id="__codelineno-0-263" name="__codelineno-0-263"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_spark</span><span class="p">(</span>
<a id="__codelineno-0-264" name="__codelineno-0-264"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-265" name="__codelineno-0-265"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-266" name="__codelineno-0-266"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-267" name="__codelineno-0-267"></a>        <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-268" name="__codelineno-0-268"></a>        <span class="n">measures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-0-269" name="__codelineno-0-269"></a>        <span class="n">having</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-270" name="__codelineno-0-270"></a>    <span class="p">):</span>
<a id="__codelineno-0-271" name="__codelineno-0-271"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate using Spark SQL.&quot;&quot;&quot;</span>
<a id="__codelineno-0-272" name="__codelineno-0-272"></a>        <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-273" name="__codelineno-0-273"></a>
<a id="__codelineno-0-274" name="__codelineno-0-274"></a>        <span class="n">grain_cols</span> <span class="o">=</span> <span class="p">[</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">grain</span><span class="p">]</span>
<a id="__codelineno-0-275" name="__codelineno-0-275"></a>
<a id="__codelineno-0-276" name="__codelineno-0-276"></a>        <span class="n">agg_exprs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-277" name="__codelineno-0-277"></a>        <span class="k">for</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
<a id="__codelineno-0-278" name="__codelineno-0-278"></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">measure</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-279" name="__codelineno-0-279"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">measure</span><span class="p">[</span><span class="s2">&quot;expr&quot;</span><span class="p">]</span>
<a id="__codelineno-0-280" name="__codelineno-0-280"></a>            <span class="n">agg_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">name</span><span class="p">))</span>
<a id="__codelineno-0-281" name="__codelineno-0-281"></a>
<a id="__codelineno-0-282" name="__codelineno-0-282"></a>        <span class="n">result</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="o">*</span><span class="n">grain_cols</span><span class="p">)</span><span class="o">.</span><span class="n">agg</span><span class="p">(</span><span class="o">*</span><span class="n">agg_exprs</span><span class="p">)</span>
<a id="__codelineno-0-283" name="__codelineno-0-283"></a>
<a id="__codelineno-0-284" name="__codelineno-0-284"></a>        <span class="k">if</span> <span class="n">having</span><span class="p">:</span>
<a id="__codelineno-0-285" name="__codelineno-0-285"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">result</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">expr</span><span class="p">(</span><span class="n">having</span><span class="p">))</span>
<a id="__codelineno-0-286" name="__codelineno-0-286"></a>
<a id="__codelineno-0-287" name="__codelineno-0-287"></a>        <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-288" name="__codelineno-0-288"></a>
<a id="__codelineno-0-289" name="__codelineno-0-289"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_aggregate_pandas</span><span class="p">(</span>
<a id="__codelineno-0-290" name="__codelineno-0-290"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-291" name="__codelineno-0-291"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-292" name="__codelineno-0-292"></a>        <span class="n">df</span><span class="p">,</span>
<a id="__codelineno-0-293" name="__codelineno-0-293"></a>        <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-294" name="__codelineno-0-294"></a>        <span class="n">measures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-0-295" name="__codelineno-0-295"></a>        <span class="n">having</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-296" name="__codelineno-0-296"></a>    <span class="p">):</span>
<a id="__codelineno-0-297" name="__codelineno-0-297"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Aggregate using DuckDB SQL via context.sql().&quot;&quot;&quot;</span>
<a id="__codelineno-0-298" name="__codelineno-0-298"></a>        <span class="n">grain_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">grain</span><span class="p">)</span>
<a id="__codelineno-0-299" name="__codelineno-0-299"></a>
<a id="__codelineno-0-300" name="__codelineno-0-300"></a>        <span class="n">measure_exprs</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-301" name="__codelineno-0-301"></a>        <span class="k">for</span> <span class="n">measure</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">:</span>
<a id="__codelineno-0-302" name="__codelineno-0-302"></a>            <span class="n">name</span> <span class="o">=</span> <span class="n">measure</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
<a id="__codelineno-0-303" name="__codelineno-0-303"></a>            <span class="n">expr</span> <span class="o">=</span> <span class="n">measure</span><span class="p">[</span><span class="s2">&quot;expr&quot;</span><span class="p">]</span>
<a id="__codelineno-0-304" name="__codelineno-0-304"></a>            <span class="n">measure_exprs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">expr</span><span class="si">}</span><span class="s2"> AS </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<a id="__codelineno-0-305" name="__codelineno-0-305"></a>        <span class="n">measures_str</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">measure_exprs</span><span class="p">)</span>
<a id="__codelineno-0-306" name="__codelineno-0-306"></a>
<a id="__codelineno-0-307" name="__codelineno-0-307"></a>        <span class="n">sql</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;SELECT </span><span class="si">{</span><span class="n">grain_str</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">measures_str</span><span class="si">}</span><span class="s2"> FROM df GROUP BY </span><span class="si">{</span><span class="n">grain_str</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-308" name="__codelineno-0-308"></a>
<a id="__codelineno-0-309" name="__codelineno-0-309"></a>        <span class="k">if</span> <span class="n">having</span><span class="p">:</span>
<a id="__codelineno-0-310" name="__codelineno-0-310"></a>            <span class="n">sql</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; HAVING </span><span class="si">{</span><span class="n">having</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-311" name="__codelineno-0-311"></a>
<a id="__codelineno-0-312" name="__codelineno-0-312"></a>        <span class="n">temp_context</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">with_df</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<a id="__codelineno-0-313" name="__codelineno-0-313"></a>        <span class="n">result_context</span> <span class="o">=</span> <span class="n">temp_context</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="n">sql</span><span class="p">)</span>
<a id="__codelineno-0-314" name="__codelineno-0-314"></a>        <span class="k">return</span> <span class="n">result_context</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-315" name="__codelineno-0-315"></a>
<a id="__codelineno-0-316" name="__codelineno-0-316"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_apply_incremental</span><span class="p">(</span>
<a id="__codelineno-0-317" name="__codelineno-0-317"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-318" name="__codelineno-0-318"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-319" name="__codelineno-0-319"></a>        <span class="n">new_agg_df</span><span class="p">,</span>
<a id="__codelineno-0-320" name="__codelineno-0-320"></a>        <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-321" name="__codelineno-0-321"></a>        <span class="n">measures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-0-322" name="__codelineno-0-322"></a>        <span class="n">incremental</span><span class="p">:</span> <span class="n">Dict</span><span class="p">,</span>
<a id="__codelineno-0-323" name="__codelineno-0-323"></a>        <span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
<a id="__codelineno-0-324" name="__codelineno-0-324"></a>    <span class="p">):</span>
<a id="__codelineno-0-325" name="__codelineno-0-325"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Apply incremental merge with existing aggregations.&quot;&quot;&quot;</span>
<a id="__codelineno-0-326" name="__codelineno-0-326"></a>        <span class="n">merge_strategy</span> <span class="o">=</span> <span class="n">incremental</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;merge_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
<a id="__codelineno-0-327" name="__codelineno-0-327"></a>
<a id="__codelineno-0-328" name="__codelineno-0-328"></a>        <span class="n">existing_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_existing_target</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
<a id="__codelineno-0-329" name="__codelineno-0-329"></a>        <span class="k">if</span> <span class="n">existing_df</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-330" name="__codelineno-0-330"></a>            <span class="k">return</span> <span class="n">new_agg_df</span>
<a id="__codelineno-0-331" name="__codelineno-0-331"></a>
<a id="__codelineno-0-332" name="__codelineno-0-332"></a>        <span class="k">if</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;replace&quot;</span><span class="p">:</span>
<a id="__codelineno-0-333" name="__codelineno-0-333"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_replace</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">existing_df</span><span class="p">,</span> <span class="n">new_agg_df</span><span class="p">,</span> <span class="n">grain</span><span class="p">)</span>
<a id="__codelineno-0-334" name="__codelineno-0-334"></a>        <span class="k">elif</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
<a id="__codelineno-0-335" name="__codelineno-0-335"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_sum</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">existing_df</span><span class="p">,</span> <span class="n">new_agg_df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">)</span>
<a id="__codelineno-0-336" name="__codelineno-0-336"></a>        <span class="k">elif</span> <span class="n">merge_strategy</span> <span class="o">==</span> <span class="s2">&quot;min&quot;</span><span class="p">:</span>
<a id="__codelineno-0-337" name="__codelineno-0-337"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_min</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">existing_df</span><span class="p">,</span> <span class="n">new_agg_df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">)</span>
<a id="__codelineno-0-338" name="__codelineno-0-338"></a>        <span class="k">else</span><span class="p">:</span>  <span class="c1"># max</span>
<a id="__codelineno-0-339" name="__codelineno-0-339"></a>            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_merge_max</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">existing_df</span><span class="p">,</span> <span class="n">new_agg_df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">)</span>
<a id="__codelineno-0-340" name="__codelineno-0-340"></a>
<a id="__codelineno-0-341" name="__codelineno-0-341"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_replace</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span> <span class="n">existing_df</span><span class="p">,</span> <span class="n">new_df</span><span class="p">,</span> <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]):</span>
<a id="__codelineno-0-342" name="__codelineno-0-342"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-343" name="__codelineno-0-343"></a><span class="sd">        Replace strategy: New aggregates overwrite existing for matching grain keys.</span>
<a id="__codelineno-0-344" name="__codelineno-0-344"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-345" name="__codelineno-0-345"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-346" name="__codelineno-0-346"></a>            <span class="n">new_keys</span> <span class="o">=</span> <span class="n">new_df</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">grain</span><span class="p">)</span><span class="o">.</span><span class="n">distinct</span><span class="p">()</span>
<a id="__codelineno-0-347" name="__codelineno-0-347"></a>
<a id="__codelineno-0-348" name="__codelineno-0-348"></a>            <span class="n">unchanged</span> <span class="o">=</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_keys</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left_anti&quot;</span><span class="p">)</span>
<a id="__codelineno-0-349" name="__codelineno-0-349"></a>
<a id="__codelineno-0-350" name="__codelineno-0-350"></a>            <span class="k">return</span> <span class="n">unchanged</span><span class="o">.</span><span class="n">unionByName</span><span class="p">(</span><span class="n">new_df</span><span class="p">,</span> <span class="n">allowMissingColumns</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-351" name="__codelineno-0-351"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-352" name="__codelineno-0-352"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-353" name="__codelineno-0-353"></a>
<a id="__codelineno-0-354" name="__codelineno-0-354"></a>            <span class="n">new_keys</span> <span class="o">=</span> <span class="n">new_df</span><span class="p">[</span><span class="n">grain</span><span class="p">]</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>
<a id="__codelineno-0-355" name="__codelineno-0-355"></a>
<a id="__codelineno-0-356" name="__codelineno-0-356"></a>            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">new_keys</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;left&quot;</span><span class="p">,</span> <span class="n">indicator</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-357" name="__codelineno-0-357"></a>            <span class="n">unchanged</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">merged</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;left_only&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;_merge&quot;</span><span class="p">])</span>
<a id="__codelineno-0-358" name="__codelineno-0-358"></a>
<a id="__codelineno-0-359" name="__codelineno-0-359"></a>            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">unchanged</span><span class="p">,</span> <span class="n">new_df</span><span class="p">],</span> <span class="n">ignore_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a id="__codelineno-0-360" name="__codelineno-0-360"></a>
<a id="__codelineno-0-361" name="__codelineno-0-361"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_sum</span><span class="p">(</span>
<a id="__codelineno-0-362" name="__codelineno-0-362"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-363" name="__codelineno-0-363"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-364" name="__codelineno-0-364"></a>        <span class="n">existing_df</span><span class="p">,</span>
<a id="__codelineno-0-365" name="__codelineno-0-365"></a>        <span class="n">new_df</span><span class="p">,</span>
<a id="__codelineno-0-366" name="__codelineno-0-366"></a>        <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-367" name="__codelineno-0-367"></a>        <span class="n">measures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-0-368" name="__codelineno-0-368"></a>    <span class="p">):</span>
<a id="__codelineno-0-369" name="__codelineno-0-369"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-370" name="__codelineno-0-370"></a><span class="sd">        Sum strategy: Add new measure values to existing for matching grain keys.</span>
<a id="__codelineno-0-371" name="__codelineno-0-371"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-372" name="__codelineno-0-372"></a>        <span class="n">measure_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">]</span>
<a id="__codelineno-0-373" name="__codelineno-0-373"></a>
<a id="__codelineno-0-374" name="__codelineno-0-374"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-375" name="__codelineno-0-375"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-376" name="__codelineno-0-376"></a>
<a id="__codelineno-0-377" name="__codelineno-0-377"></a>            <span class="n">joined</span> <span class="o">=</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;full_outer&quot;</span><span class="p">)</span>
<a id="__codelineno-0-378" name="__codelineno-0-378"></a>
<a id="__codelineno-0-379" name="__codelineno-0-379"></a>            <span class="n">select_cols</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-380" name="__codelineno-0-380"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">grain</span><span class="p">:</span>
<a id="__codelineno-0-381" name="__codelineno-0-381"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
<a id="__codelineno-0-382" name="__codelineno-0-382"></a>
<a id="__codelineno-0-383" name="__codelineno-0-383"></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">measure_names</span><span class="p">:</span>
<a id="__codelineno-0-384" name="__codelineno-0-384"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-385" name="__codelineno-0-385"></a>                    <span class="p">(</span>
<a id="__codelineno-0-386" name="__codelineno-0-386"></a>                        <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-387" name="__codelineno-0-387"></a>                        <span class="o">+</span> <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">lit</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
<a id="__codelineno-0-388" name="__codelineno-0-388"></a>                    <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-389" name="__codelineno-0-389"></a>                <span class="p">)</span>
<a id="__codelineno-0-390" name="__codelineno-0-390"></a>
<a id="__codelineno-0-391" name="__codelineno-0-391"></a>            <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-392" name="__codelineno-0-392"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grain</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure_names</span>
<a id="__codelineno-0-393" name="__codelineno-0-393"></a>            <span class="p">]</span>
<a id="__codelineno-0-394" name="__codelineno-0-394"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
<a id="__codelineno-0-395" name="__codelineno-0-395"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
<a id="__codelineno-0-396" name="__codelineno-0-396"></a>
<a id="__codelineno-0-397" name="__codelineno-0-397"></a>            <span class="k">return</span> <span class="n">joined</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select_cols</span><span class="p">)</span>
<a id="__codelineno-0-398" name="__codelineno-0-398"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-399" name="__codelineno-0-399"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-400" name="__codelineno-0-400"></a>
<a id="__codelineno-0-401" name="__codelineno-0-401"></a>            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">new_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_e&quot;</span><span class="p">,</span> <span class="s2">&quot;_n&quot;</span><span class="p">))</span>
<a id="__codelineno-0-402" name="__codelineno-0-402"></a>
<a id="__codelineno-0-403" name="__codelineno-0-403"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">grain</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-404" name="__codelineno-0-404"></a>
<a id="__codelineno-0-405" name="__codelineno-0-405"></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">measure_names</span><span class="p">:</span>
<a id="__codelineno-0-406" name="__codelineno-0-406"></a>                <span class="n">e_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">name</span>
<a id="__codelineno-0-407" name="__codelineno-0-407"></a>                <span class="n">n_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">name</span>
<a id="__codelineno-0-408" name="__codelineno-0-408"></a>
<a id="__codelineno-0-409" name="__codelineno-0-409"></a>                <span class="k">if</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-410" name="__codelineno-0-410"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">e_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> <span class="n">merged</span><span class="p">[</span>
<a id="__codelineno-0-411" name="__codelineno-0-411"></a>                        <span class="n">n_col</span>
<a id="__codelineno-0-412" name="__codelineno-0-412"></a>                    <span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-413" name="__codelineno-0-413"></a>                <span class="k">elif</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-414" name="__codelineno-0-414"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">e_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-415" name="__codelineno-0-415"></a>                <span class="k">elif</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-416" name="__codelineno-0-416"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">infer_objects</span><span class="p">(</span><span class="n">copy</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<a id="__codelineno-0-417" name="__codelineno-0-417"></a>                <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-418" name="__codelineno-0-418"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
<a id="__codelineno-0-419" name="__codelineno-0-419"></a>
<a id="__codelineno-0-420" name="__codelineno-0-420"></a>            <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-421" name="__codelineno-0-421"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grain</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure_names</span>
<a id="__codelineno-0-422" name="__codelineno-0-422"></a>            <span class="p">]</span>
<a id="__codelineno-0-423" name="__codelineno-0-423"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
<a id="__codelineno-0-424" name="__codelineno-0-424"></a>                <span class="n">e_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">col</span>
<a id="__codelineno-0-425" name="__codelineno-0-425"></a>                <span class="n">n_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">col</span>
<a id="__codelineno-0-426" name="__codelineno-0-426"></a>                <span class="k">if</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-427" name="__codelineno-0-427"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">e_col</span><span class="p">]</span>
<a id="__codelineno-0-428" name="__codelineno-0-428"></a>                <span class="k">elif</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-429" name="__codelineno-0-429"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span>
<a id="__codelineno-0-430" name="__codelineno-0-430"></a>
<a id="__codelineno-0-431" name="__codelineno-0-431"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-432" name="__codelineno-0-432"></a>
<a id="__codelineno-0-433" name="__codelineno-0-433"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_min</span><span class="p">(</span>
<a id="__codelineno-0-434" name="__codelineno-0-434"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-435" name="__codelineno-0-435"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-436" name="__codelineno-0-436"></a>        <span class="n">existing_df</span><span class="p">,</span>
<a id="__codelineno-0-437" name="__codelineno-0-437"></a>        <span class="n">new_df</span><span class="p">,</span>
<a id="__codelineno-0-438" name="__codelineno-0-438"></a>        <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-439" name="__codelineno-0-439"></a>        <span class="n">measures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-0-440" name="__codelineno-0-440"></a>    <span class="p">):</span>
<a id="__codelineno-0-441" name="__codelineno-0-441"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-442" name="__codelineno-0-442"></a><span class="sd">        Min strategy: Keep the minimum value for each measure across existing and new.</span>
<a id="__codelineno-0-443" name="__codelineno-0-443"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-444" name="__codelineno-0-444"></a>        <span class="n">measure_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">]</span>
<a id="__codelineno-0-445" name="__codelineno-0-445"></a>
<a id="__codelineno-0-446" name="__codelineno-0-446"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-447" name="__codelineno-0-447"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-448" name="__codelineno-0-448"></a>
<a id="__codelineno-0-449" name="__codelineno-0-449"></a>            <span class="n">joined</span> <span class="o">=</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;full_outer&quot;</span><span class="p">)</span>
<a id="__codelineno-0-450" name="__codelineno-0-450"></a>
<a id="__codelineno-0-451" name="__codelineno-0-451"></a>            <span class="n">select_cols</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-452" name="__codelineno-0-452"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">grain</span><span class="p">:</span>
<a id="__codelineno-0-453" name="__codelineno-0-453"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
<a id="__codelineno-0-454" name="__codelineno-0-454"></a>
<a id="__codelineno-0-455" name="__codelineno-0-455"></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">measure_names</span><span class="p">:</span>
<a id="__codelineno-0-456" name="__codelineno-0-456"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-457" name="__codelineno-0-457"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">least</span><span class="p">(</span>
<a id="__codelineno-0-458" name="__codelineno-0-458"></a>                        <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)),</span>
<a id="__codelineno-0-459" name="__codelineno-0-459"></a>                        <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)),</span>
<a id="__codelineno-0-460" name="__codelineno-0-460"></a>                    <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-461" name="__codelineno-0-461"></a>                <span class="p">)</span>
<a id="__codelineno-0-462" name="__codelineno-0-462"></a>
<a id="__codelineno-0-463" name="__codelineno-0-463"></a>            <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-464" name="__codelineno-0-464"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grain</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure_names</span>
<a id="__codelineno-0-465" name="__codelineno-0-465"></a>            <span class="p">]</span>
<a id="__codelineno-0-466" name="__codelineno-0-466"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
<a id="__codelineno-0-467" name="__codelineno-0-467"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
<a id="__codelineno-0-468" name="__codelineno-0-468"></a>
<a id="__codelineno-0-469" name="__codelineno-0-469"></a>            <span class="k">return</span> <span class="n">joined</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select_cols</span><span class="p">)</span>
<a id="__codelineno-0-470" name="__codelineno-0-470"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-471" name="__codelineno-0-471"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-472" name="__codelineno-0-472"></a>
<a id="__codelineno-0-473" name="__codelineno-0-473"></a>            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">new_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_e&quot;</span><span class="p">,</span> <span class="s2">&quot;_n&quot;</span><span class="p">))</span>
<a id="__codelineno-0-474" name="__codelineno-0-474"></a>
<a id="__codelineno-0-475" name="__codelineno-0-475"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">grain</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-476" name="__codelineno-0-476"></a>
<a id="__codelineno-0-477" name="__codelineno-0-477"></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">measure_names</span><span class="p">:</span>
<a id="__codelineno-0-478" name="__codelineno-0-478"></a>                <span class="n">e_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">name</span>
<a id="__codelineno-0-479" name="__codelineno-0-479"></a>                <span class="n">n_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">name</span>
<a id="__codelineno-0-480" name="__codelineno-0-480"></a>
<a id="__codelineno-0-481" name="__codelineno-0-481"></a>                <span class="k">if</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-482" name="__codelineno-0-482"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[[</span><span class="n">e_col</span><span class="p">,</span> <span class="n">n_col</span><span class="p">]]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-483" name="__codelineno-0-483"></a>                <span class="k">elif</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-484" name="__codelineno-0-484"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">e_col</span><span class="p">]</span>
<a id="__codelineno-0-485" name="__codelineno-0-485"></a>                <span class="k">elif</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-486" name="__codelineno-0-486"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span>
<a id="__codelineno-0-487" name="__codelineno-0-487"></a>
<a id="__codelineno-0-488" name="__codelineno-0-488"></a>            <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-489" name="__codelineno-0-489"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grain</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure_names</span>
<a id="__codelineno-0-490" name="__codelineno-0-490"></a>            <span class="p">]</span>
<a id="__codelineno-0-491" name="__codelineno-0-491"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
<a id="__codelineno-0-492" name="__codelineno-0-492"></a>                <span class="n">e_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">col</span>
<a id="__codelineno-0-493" name="__codelineno-0-493"></a>                <span class="n">n_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">col</span>
<a id="__codelineno-0-494" name="__codelineno-0-494"></a>                <span class="k">if</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-495" name="__codelineno-0-495"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">e_col</span><span class="p">]</span>
<a id="__codelineno-0-496" name="__codelineno-0-496"></a>                <span class="k">elif</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-497" name="__codelineno-0-497"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span>
<a id="__codelineno-0-498" name="__codelineno-0-498"></a>
<a id="__codelineno-0-499" name="__codelineno-0-499"></a>            <span class="k">return</span> <span class="n">result</span>
<a id="__codelineno-0-500" name="__codelineno-0-500"></a>
<a id="__codelineno-0-501" name="__codelineno-0-501"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">_merge_max</span><span class="p">(</span>
<a id="__codelineno-0-502" name="__codelineno-0-502"></a>        <span class="bp">self</span><span class="p">,</span>
<a id="__codelineno-0-503" name="__codelineno-0-503"></a>        <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">,</span>
<a id="__codelineno-0-504" name="__codelineno-0-504"></a>        <span class="n">existing_df</span><span class="p">,</span>
<a id="__codelineno-0-505" name="__codelineno-0-505"></a>        <span class="n">new_df</span><span class="p">,</span>
<a id="__codelineno-0-506" name="__codelineno-0-506"></a>        <span class="n">grain</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span>
<a id="__codelineno-0-507" name="__codelineno-0-507"></a>        <span class="n">measures</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">],</span>
<a id="__codelineno-0-508" name="__codelineno-0-508"></a>    <span class="p">):</span>
<a id="__codelineno-0-509" name="__codelineno-0-509"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<a id="__codelineno-0-510" name="__codelineno-0-510"></a><span class="sd">        Max strategy: Keep the maximum value for each measure across existing and new.</span>
<a id="__codelineno-0-511" name="__codelineno-0-511"></a><span class="sd">        &quot;&quot;&quot;</span>
<a id="__codelineno-0-512" name="__codelineno-0-512"></a>        <span class="n">measure_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">m</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">measures</span><span class="p">]</span>
<a id="__codelineno-0-513" name="__codelineno-0-513"></a>
<a id="__codelineno-0-514" name="__codelineno-0-514"></a>        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span> <span class="o">==</span> <span class="n">EngineType</span><span class="o">.</span><span class="n">SPARK</span><span class="p">:</span>
<a id="__codelineno-0-515" name="__codelineno-0-515"></a>            <span class="kn">from</span><span class="w"> </span><span class="nn">pyspark.sql</span><span class="w"> </span><span class="kn">import</span> <span class="n">functions</span> <span class="k">as</span> <span class="n">F</span>
<a id="__codelineno-0-516" name="__codelineno-0-516"></a>
<a id="__codelineno-0-517" name="__codelineno-0-517"></a>            <span class="n">joined</span> <span class="o">=</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;e&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_df</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="s2">&quot;n&quot;</span><span class="p">),</span> <span class="n">on</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;full_outer&quot;</span><span class="p">)</span>
<a id="__codelineno-0-518" name="__codelineno-0-518"></a>
<a id="__codelineno-0-519" name="__codelineno-0-519"></a>            <span class="n">select_cols</span> <span class="o">=</span> <span class="p">[]</span>
<a id="__codelineno-0-520" name="__codelineno-0-520"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">grain</span><span class="p">:</span>
<a id="__codelineno-0-521" name="__codelineno-0-521"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
<a id="__codelineno-0-522" name="__codelineno-0-522"></a>
<a id="__codelineno-0-523" name="__codelineno-0-523"></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">measure_names</span><span class="p">:</span>
<a id="__codelineno-0-524" name="__codelineno-0-524"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
<a id="__codelineno-0-525" name="__codelineno-0-525"></a>                    <span class="n">F</span><span class="o">.</span><span class="n">greatest</span><span class="p">(</span>
<a id="__codelineno-0-526" name="__codelineno-0-526"></a>                        <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)),</span>
<a id="__codelineno-0-527" name="__codelineno-0-527"></a>                        <span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)),</span>
<a id="__codelineno-0-528" name="__codelineno-0-528"></a>                    <span class="p">)</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<a id="__codelineno-0-529" name="__codelineno-0-529"></a>                <span class="p">)</span>
<a id="__codelineno-0-530" name="__codelineno-0-530"></a>
<a id="__codelineno-0-531" name="__codelineno-0-531"></a>            <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-532" name="__codelineno-0-532"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grain</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure_names</span>
<a id="__codelineno-0-533" name="__codelineno-0-533"></a>            <span class="p">]</span>
<a id="__codelineno-0-534" name="__codelineno-0-534"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
<a id="__codelineno-0-535" name="__codelineno-0-535"></a>                <span class="n">select_cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">coalesce</span><span class="p">(</span><span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;e.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">F</span><span class="o">.</span><span class="n">col</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;n.</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">alias</span><span class="p">(</span><span class="n">col</span><span class="p">))</span>
<a id="__codelineno-0-536" name="__codelineno-0-536"></a>
<a id="__codelineno-0-537" name="__codelineno-0-537"></a>            <span class="k">return</span> <span class="n">joined</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">select_cols</span><span class="p">)</span>
<a id="__codelineno-0-538" name="__codelineno-0-538"></a>        <span class="k">else</span><span class="p">:</span>
<a id="__codelineno-0-539" name="__codelineno-0-539"></a>            <span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
<a id="__codelineno-0-540" name="__codelineno-0-540"></a>
<a id="__codelineno-0-541" name="__codelineno-0-541"></a>            <span class="n">merged</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">existing_df</span><span class="p">,</span> <span class="n">new_df</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;outer&quot;</span><span class="p">,</span> <span class="n">suffixes</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;_e&quot;</span><span class="p">,</span> <span class="s2">&quot;_n&quot;</span><span class="p">))</span>
<a id="__codelineno-0-542" name="__codelineno-0-542"></a>
<a id="__codelineno-0-543" name="__codelineno-0-543"></a>            <span class="n">result</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">grain</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
<a id="__codelineno-0-544" name="__codelineno-0-544"></a>
<a id="__codelineno-0-545" name="__codelineno-0-545"></a>            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">measure_names</span><span class="p">:</span>
<a id="__codelineno-0-546" name="__codelineno-0-546"></a>                <span class="n">e_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">name</span>
<a id="__codelineno-0-547" name="__codelineno-0-547"></a>                <span class="n">n_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">name</span>
<a id="__codelineno-0-548" name="__codelineno-0-548"></a>
<a id="__codelineno-0-549" name="__codelineno-0-549"></a>                <span class="k">if</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="ow">and</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-550" name="__codelineno-0-550"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[[</span><span class="n">e_col</span><span class="p">,</span> <span class="n">n_col</span><span class="p">]]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<a id="__codelineno-0-551" name="__codelineno-0-551"></a>                <span class="k">elif</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-552" name="__codelineno-0-552"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">e_col</span><span class="p">]</span>
<a id="__codelineno-0-553" name="__codelineno-0-553"></a>                <span class="k">elif</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-554" name="__codelineno-0-554"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span>
<a id="__codelineno-0-555" name="__codelineno-0-555"></a>
<a id="__codelineno-0-556" name="__codelineno-0-556"></a>            <span class="n">other_cols</span> <span class="o">=</span> <span class="p">[</span>
<a id="__codelineno-0-557" name="__codelineno-0-557"></a>                <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">existing_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">grain</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure_names</span>
<a id="__codelineno-0-558" name="__codelineno-0-558"></a>            <span class="p">]</span>
<a id="__codelineno-0-559" name="__codelineno-0-559"></a>            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">other_cols</span><span class="p">:</span>
<a id="__codelineno-0-560" name="__codelineno-0-560"></a>                <span class="n">e_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_e&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">col</span>
<a id="__codelineno-0-561" name="__codelineno-0-561"></a>                <span class="n">n_col</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="k">if</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">_n&quot;</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span> <span class="k">else</span> <span class="n">col</span>
<a id="__codelineno-0-562" name="__codelineno-0-562"></a>                <span class="k">if</span> <span class="n">e_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-563" name="__codelineno-0-563"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">e_col</span><span class="p">]</span>
<a id="__codelineno-0-564" name="__codelineno-0-564"></a>                <span class="k">elif</span> <span class="n">n_col</span> <span class="ow">in</span> <span class="n">merged</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
<a id="__codelineno-0-565" name="__codelineno-0-565"></a>                    <span class="n">result</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged</span><span class="p">[</span><span class="n">n_col</span><span class="p">]</span>
<a id="__codelineno-0-566" name="__codelineno-0-566"></a>
<a id="__codelineno-0-567" name="__codelineno-0-567"></a>            <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
              </details>



<div class="doc doc-children">










<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.aggregation.AggregationPattern.execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">execute</span><span class="p">(</span><span class="n">context</span><span class="p">)</span></code>

<a href="#odibi.patterns.aggregation.AggregationPattern.execute" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Execute the aggregation pattern on the input data.</p>
<p>Performs aggregation operations on the source DataFrame, optionally applying incremental
merge with existing target data. The execution flow:
1. Aggregate source data by grain columns with specified measures
2. Apply HAVING clause filtering if configured
3. Merge with existing target data if incremental mode is enabled
4. Add audit columns (load_timestamp, source_system) if configured</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>context</code>
            </td>
            <td>
                  <code><span title="odibi.context.EngineContext">EngineContext</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Engine context containing the source DataFrame and execution environment.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Any">Any</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Aggregated DataFrame with measures computed at the specified grain level.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="Exception">Exception</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If aggregation fails, incremental merge fails, or target loading fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-158">158</a></span>
<span class="normal"><a href="#__codelineno-0-159">159</a></span>
<span class="normal"><a href="#__codelineno-0-160">160</a></span>
<span class="normal"><a href="#__codelineno-0-161">161</a></span>
<span class="normal"><a href="#__codelineno-0-162">162</a></span>
<span class="normal"><a href="#__codelineno-0-163">163</a></span>
<span class="normal"><a href="#__codelineno-0-164">164</a></span>
<span class="normal"><a href="#__codelineno-0-165">165</a></span>
<span class="normal"><a href="#__codelineno-0-166">166</a></span>
<span class="normal"><a href="#__codelineno-0-167">167</a></span>
<span class="normal"><a href="#__codelineno-0-168">168</a></span>
<span class="normal"><a href="#__codelineno-0-169">169</a></span>
<span class="normal"><a href="#__codelineno-0-170">170</a></span>
<span class="normal"><a href="#__codelineno-0-171">171</a></span>
<span class="normal"><a href="#__codelineno-0-172">172</a></span>
<span class="normal"><a href="#__codelineno-0-173">173</a></span>
<span class="normal"><a href="#__codelineno-0-174">174</a></span>
<span class="normal"><a href="#__codelineno-0-175">175</a></span>
<span class="normal"><a href="#__codelineno-0-176">176</a></span>
<span class="normal"><a href="#__codelineno-0-177">177</a></span>
<span class="normal"><a href="#__codelineno-0-178">178</a></span>
<span class="normal"><a href="#__codelineno-0-179">179</a></span>
<span class="normal"><a href="#__codelineno-0-180">180</a></span>
<span class="normal"><a href="#__codelineno-0-181">181</a></span>
<span class="normal"><a href="#__codelineno-0-182">182</a></span>
<span class="normal"><a href="#__codelineno-0-183">183</a></span>
<span class="normal"><a href="#__codelineno-0-184">184</a></span>
<span class="normal"><a href="#__codelineno-0-185">185</a></span>
<span class="normal"><a href="#__codelineno-0-186">186</a></span>
<span class="normal"><a href="#__codelineno-0-187">187</a></span>
<span class="normal"><a href="#__codelineno-0-188">188</a></span>
<span class="normal"><a href="#__codelineno-0-189">189</a></span>
<span class="normal"><a href="#__codelineno-0-190">190</a></span>
<span class="normal"><a href="#__codelineno-0-191">191</a></span>
<span class="normal"><a href="#__codelineno-0-192">192</a></span>
<span class="normal"><a href="#__codelineno-0-193">193</a></span>
<span class="normal"><a href="#__codelineno-0-194">194</a></span>
<span class="normal"><a href="#__codelineno-0-195">195</a></span>
<span class="normal"><a href="#__codelineno-0-196">196</a></span>
<span class="normal"><a href="#__codelineno-0-197">197</a></span>
<span class="normal"><a href="#__codelineno-0-198">198</a></span>
<span class="normal"><a href="#__codelineno-0-199">199</a></span>
<span class="normal"><a href="#__codelineno-0-200">200</a></span>
<span class="normal"><a href="#__codelineno-0-201">201</a></span>
<span class="normal"><a href="#__codelineno-0-202">202</a></span>
<span class="normal"><a href="#__codelineno-0-203">203</a></span>
<span class="normal"><a href="#__codelineno-0-204">204</a></span>
<span class="normal"><a href="#__codelineno-0-205">205</a></span>
<span class="normal"><a href="#__codelineno-0-206">206</a></span>
<span class="normal"><a href="#__codelineno-0-207">207</a></span>
<span class="normal"><a href="#__codelineno-0-208">208</a></span>
<span class="normal"><a href="#__codelineno-0-209">209</a></span>
<span class="normal"><a href="#__codelineno-0-210">210</a></span>
<span class="normal"><a href="#__codelineno-0-211">211</a></span>
<span class="normal"><a href="#__codelineno-0-212">212</a></span>
<span class="normal"><a href="#__codelineno-0-213">213</a></span>
<span class="normal"><a href="#__codelineno-0-214">214</a></span>
<span class="normal"><a href="#__codelineno-0-215">215</a></span>
<span class="normal"><a href="#__codelineno-0-216">216</a></span>
<span class="normal"><a href="#__codelineno-0-217">217</a></span>
<span class="normal"><a href="#__codelineno-0-218">218</a></span>
<span class="normal"><a href="#__codelineno-0-219">219</a></span>
<span class="normal"><a href="#__codelineno-0-220">220</a></span>
<span class="normal"><a href="#__codelineno-0-221">221</a></span>
<span class="normal"><a href="#__codelineno-0-222">222</a></span>
<span class="normal"><a href="#__codelineno-0-223">223</a></span>
<span class="normal"><a href="#__codelineno-0-224">224</a></span>
<span class="normal"><a href="#__codelineno-0-225">225</a></span>
<span class="normal"><a href="#__codelineno-0-226">226</a></span>
<span class="normal"><a href="#__codelineno-0-227">227</a></span>
<span class="normal"><a href="#__codelineno-0-228">228</a></span>
<span class="normal"><a href="#__codelineno-0-229">229</a></span>
<span class="normal"><a href="#__codelineno-0-230">230</a></span>
<span class="normal"><a href="#__codelineno-0-231">231</a></span>
<span class="normal"><a href="#__codelineno-0-232">232</a></span>
<span class="normal"><a href="#__codelineno-0-233">233</a></span>
<span class="normal"><a href="#__codelineno-0-234">234</a></span>
<span class="normal"><a href="#__codelineno-0-235">235</a></span>
<span class="normal"><a href="#__codelineno-0-236">236</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-158" name="__codelineno-0-158"></a><span class="k">def</span><span class="w"> </span><span class="nf">execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">EngineContext</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<a id="__codelineno-0-159" name="__codelineno-0-159"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the aggregation pattern on the input data.</span>
<a id="__codelineno-0-160" name="__codelineno-0-160"></a>
<a id="__codelineno-0-161" name="__codelineno-0-161"></a><span class="sd">    Performs aggregation operations on the source DataFrame, optionally applying incremental</span>
<a id="__codelineno-0-162" name="__codelineno-0-162"></a><span class="sd">    merge with existing target data. The execution flow:</span>
<a id="__codelineno-0-163" name="__codelineno-0-163"></a><span class="sd">    1. Aggregate source data by grain columns with specified measures</span>
<a id="__codelineno-0-164" name="__codelineno-0-164"></a><span class="sd">    2. Apply HAVING clause filtering if configured</span>
<a id="__codelineno-0-165" name="__codelineno-0-165"></a><span class="sd">    3. Merge with existing target data if incremental mode is enabled</span>
<a id="__codelineno-0-166" name="__codelineno-0-166"></a><span class="sd">    4. Add audit columns (load_timestamp, source_system) if configured</span>
<a id="__codelineno-0-167" name="__codelineno-0-167"></a>
<a id="__codelineno-0-168" name="__codelineno-0-168"></a><span class="sd">    Args:</span>
<a id="__codelineno-0-169" name="__codelineno-0-169"></a><span class="sd">        context: Engine context containing the source DataFrame and execution environment.</span>
<a id="__codelineno-0-170" name="__codelineno-0-170"></a>
<a id="__codelineno-0-171" name="__codelineno-0-171"></a><span class="sd">    Returns:</span>
<a id="__codelineno-0-172" name="__codelineno-0-172"></a><span class="sd">        Aggregated DataFrame with measures computed at the specified grain level.</span>
<a id="__codelineno-0-173" name="__codelineno-0-173"></a>
<a id="__codelineno-0-174" name="__codelineno-0-174"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-175" name="__codelineno-0-175"></a><span class="sd">        Exception: If aggregation fails, incremental merge fails, or target loading fails.</span>
<a id="__codelineno-0-176" name="__codelineno-0-176"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-177" name="__codelineno-0-177"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-178" name="__codelineno-0-178"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a id="__codelineno-0-179" name="__codelineno-0-179"></a>
<a id="__codelineno-0-180" name="__codelineno-0-180"></a>    <span class="n">grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-181" name="__codelineno-0-181"></a>    <span class="n">measures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;measures&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-182" name="__codelineno-0-182"></a>    <span class="n">having</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;having&quot;</span><span class="p">)</span>
<a id="__codelineno-0-183" name="__codelineno-0-183"></a>    <span class="n">incremental</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;incremental&quot;</span><span class="p">)</span>
<a id="__codelineno-0-184" name="__codelineno-0-184"></a>    <span class="n">audit_config</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;audit&quot;</span><span class="p">,</span> <span class="p">{})</span>
<a id="__codelineno-0-185" name="__codelineno-0-185"></a>    <span class="n">target</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;target&quot;</span><span class="p">)</span>
<a id="__codelineno-0-186" name="__codelineno-0-186"></a>
<a id="__codelineno-0-187" name="__codelineno-0-187"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-188" name="__codelineno-0-188"></a>        <span class="s2">&quot;AggregationPattern starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-189" name="__codelineno-0-189"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-190" name="__codelineno-0-190"></a>        <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-191" name="__codelineno-0-191"></a>        <span class="n">measures_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">),</span>
<a id="__codelineno-0-192" name="__codelineno-0-192"></a>        <span class="n">incremental</span><span class="o">=</span><span class="n">incremental</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
<a id="__codelineno-0-193" name="__codelineno-0-193"></a>    <span class="p">)</span>
<a id="__codelineno-0-194" name="__codelineno-0-194"></a>
<a id="__codelineno-0-195" name="__codelineno-0-195"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">df</span>
<a id="__codelineno-0-196" name="__codelineno-0-196"></a>    <span class="n">source_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-197" name="__codelineno-0-197"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-198" name="__codelineno-0-198"></a>        <span class="s2">&quot;Aggregation source loaded&quot;</span><span class="p">,</span>
<a id="__codelineno-0-199" name="__codelineno-0-199"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-200" name="__codelineno-0-200"></a>        <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-201" name="__codelineno-0-201"></a>    <span class="p">)</span>
<a id="__codelineno-0-202" name="__codelineno-0-202"></a>
<a id="__codelineno-0-203" name="__codelineno-0-203"></a>    <span class="k">try</span><span class="p">:</span>
<a id="__codelineno-0-204" name="__codelineno-0-204"></a>        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_aggregate</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">having</span><span class="p">)</span>
<a id="__codelineno-0-205" name="__codelineno-0-205"></a>
<a id="__codelineno-0-206" name="__codelineno-0-206"></a>        <span class="k">if</span> <span class="n">incremental</span> <span class="ow">and</span> <span class="n">target</span><span class="p">:</span>
<a id="__codelineno-0-207" name="__codelineno-0-207"></a>            <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_apply_incremental</span><span class="p">(</span>
<a id="__codelineno-0-208" name="__codelineno-0-208"></a>                <span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">grain</span><span class="p">,</span> <span class="n">measures</span><span class="p">,</span> <span class="n">incremental</span><span class="p">,</span> <span class="n">target</span>
<a id="__codelineno-0-209" name="__codelineno-0-209"></a>            <span class="p">)</span>
<a id="__codelineno-0-210" name="__codelineno-0-210"></a>
<a id="__codelineno-0-211" name="__codelineno-0-211"></a>        <span class="n">result_df</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_add_audit_columns</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">result_df</span><span class="p">,</span> <span class="n">audit_config</span><span class="p">)</span>
<a id="__codelineno-0-212" name="__codelineno-0-212"></a>
<a id="__codelineno-0-213" name="__codelineno-0-213"></a>        <span class="n">result_count</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_row_count</span><span class="p">(</span><span class="n">result_df</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">engine_type</span><span class="p">)</span>
<a id="__codelineno-0-214" name="__codelineno-0-214"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-215" name="__codelineno-0-215"></a>
<a id="__codelineno-0-216" name="__codelineno-0-216"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">info</span><span class="p">(</span>
<a id="__codelineno-0-217" name="__codelineno-0-217"></a>            <span class="s2">&quot;AggregationPattern completed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-218" name="__codelineno-0-218"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-219" name="__codelineno-0-219"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-220" name="__codelineno-0-220"></a>            <span class="n">source_rows</span><span class="o">=</span><span class="n">source_count</span><span class="p">,</span>
<a id="__codelineno-0-221" name="__codelineno-0-221"></a>            <span class="n">result_rows</span><span class="o">=</span><span class="n">result_count</span><span class="p">,</span>
<a id="__codelineno-0-222" name="__codelineno-0-222"></a>            <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-223" name="__codelineno-0-223"></a>        <span class="p">)</span>
<a id="__codelineno-0-224" name="__codelineno-0-224"></a>
<a id="__codelineno-0-225" name="__codelineno-0-225"></a>        <span class="k">return</span> <span class="n">result_df</span>
<a id="__codelineno-0-226" name="__codelineno-0-226"></a>
<a id="__codelineno-0-227" name="__codelineno-0-227"></a>    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<a id="__codelineno-0-228" name="__codelineno-0-228"></a>        <span class="n">elapsed_ms</span> <span class="o">=</span> <span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span>
<a id="__codelineno-0-229" name="__codelineno-0-229"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-230" name="__codelineno-0-230"></a>            <span class="sa">f</span><span class="s2">&quot;AggregationPattern failed: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
<a id="__codelineno-0-231" name="__codelineno-0-231"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-232" name="__codelineno-0-232"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-233" name="__codelineno-0-233"></a>            <span class="n">error_type</span><span class="o">=</span><span class="nb">type</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
<a id="__codelineno-0-234" name="__codelineno-0-234"></a>            <span class="n">elapsed_ms</span><span class="o">=</span><span class="nb">round</span><span class="p">(</span><span class="n">elapsed_ms</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
<a id="__codelineno-0-235" name="__codelineno-0-235"></a>        <span class="p">)</span>
<a id="__codelineno-0-236" name="__codelineno-0-236"></a>        <span class="k">raise</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="odibi.patterns.aggregation.AggregationPattern.validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">validate</span><span class="p">()</span></code>

<a href="#odibi.patterns.aggregation.AggregationPattern.validate" class="headerlink" title="Permanent link">&para;</a></h4>


    <div class="doc doc-contents ">

        <p>Validate aggregation pattern configuration parameters.</p>
<p>Ensures that all required parameters are present and valid. Checks that:
- grain is specified (list of GROUP BY columns)
- measures are provided with correct structure (list of dicts with 'name' and 'expr')
- incremental config is valid if provided (requires 'timestamp_column' and valid merge_strategy)</p>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If grain is missing, measures are missing/invalid, or incremental config is invalid.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="mkdocstrings-source">
              <summary>Source code in <code>odibi/patterns/aggregation.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-49"> 49</a></span>
<span class="normal"><a href="#__codelineno-0-50"> 50</a></span>
<span class="normal"><a href="#__codelineno-0-51"> 51</a></span>
<span class="normal"><a href="#__codelineno-0-52"> 52</a></span>
<span class="normal"><a href="#__codelineno-0-53"> 53</a></span>
<span class="normal"><a href="#__codelineno-0-54"> 54</a></span>
<span class="normal"><a href="#__codelineno-0-55"> 55</a></span>
<span class="normal"><a href="#__codelineno-0-56"> 56</a></span>
<span class="normal"><a href="#__codelineno-0-57"> 57</a></span>
<span class="normal"><a href="#__codelineno-0-58"> 58</a></span>
<span class="normal"><a href="#__codelineno-0-59"> 59</a></span>
<span class="normal"><a href="#__codelineno-0-60"> 60</a></span>
<span class="normal"><a href="#__codelineno-0-61"> 61</a></span>
<span class="normal"><a href="#__codelineno-0-62"> 62</a></span>
<span class="normal"><a href="#__codelineno-0-63"> 63</a></span>
<span class="normal"><a href="#__codelineno-0-64"> 64</a></span>
<span class="normal"><a href="#__codelineno-0-65"> 65</a></span>
<span class="normal"><a href="#__codelineno-0-66"> 66</a></span>
<span class="normal"><a href="#__codelineno-0-67"> 67</a></span>
<span class="normal"><a href="#__codelineno-0-68"> 68</a></span>
<span class="normal"><a href="#__codelineno-0-69"> 69</a></span>
<span class="normal"><a href="#__codelineno-0-70"> 70</a></span>
<span class="normal"><a href="#__codelineno-0-71"> 71</a></span>
<span class="normal"><a href="#__codelineno-0-72"> 72</a></span>
<span class="normal"><a href="#__codelineno-0-73"> 73</a></span>
<span class="normal"><a href="#__codelineno-0-74"> 74</a></span>
<span class="normal"><a href="#__codelineno-0-75"> 75</a></span>
<span class="normal"><a href="#__codelineno-0-76"> 76</a></span>
<span class="normal"><a href="#__codelineno-0-77"> 77</a></span>
<span class="normal"><a href="#__codelineno-0-78"> 78</a></span>
<span class="normal"><a href="#__codelineno-0-79"> 79</a></span>
<span class="normal"><a href="#__codelineno-0-80"> 80</a></span>
<span class="normal"><a href="#__codelineno-0-81"> 81</a></span>
<span class="normal"><a href="#__codelineno-0-82"> 82</a></span>
<span class="normal"><a href="#__codelineno-0-83"> 83</a></span>
<span class="normal"><a href="#__codelineno-0-84"> 84</a></span>
<span class="normal"><a href="#__codelineno-0-85"> 85</a></span>
<span class="normal"><a href="#__codelineno-0-86"> 86</a></span>
<span class="normal"><a href="#__codelineno-0-87"> 87</a></span>
<span class="normal"><a href="#__codelineno-0-88"> 88</a></span>
<span class="normal"><a href="#__codelineno-0-89"> 89</a></span>
<span class="normal"><a href="#__codelineno-0-90"> 90</a></span>
<span class="normal"><a href="#__codelineno-0-91"> 91</a></span>
<span class="normal"><a href="#__codelineno-0-92"> 92</a></span>
<span class="normal"><a href="#__codelineno-0-93"> 93</a></span>
<span class="normal"><a href="#__codelineno-0-94"> 94</a></span>
<span class="normal"><a href="#__codelineno-0-95"> 95</a></span>
<span class="normal"><a href="#__codelineno-0-96"> 96</a></span>
<span class="normal"><a href="#__codelineno-0-97"> 97</a></span>
<span class="normal"><a href="#__codelineno-0-98"> 98</a></span>
<span class="normal"><a href="#__codelineno-0-99"> 99</a></span>
<span class="normal"><a href="#__codelineno-0-100">100</a></span>
<span class="normal"><a href="#__codelineno-0-101">101</a></span>
<span class="normal"><a href="#__codelineno-0-102">102</a></span>
<span class="normal"><a href="#__codelineno-0-103">103</a></span>
<span class="normal"><a href="#__codelineno-0-104">104</a></span>
<span class="normal"><a href="#__codelineno-0-105">105</a></span>
<span class="normal"><a href="#__codelineno-0-106">106</a></span>
<span class="normal"><a href="#__codelineno-0-107">107</a></span>
<span class="normal"><a href="#__codelineno-0-108">108</a></span>
<span class="normal"><a href="#__codelineno-0-109">109</a></span>
<span class="normal"><a href="#__codelineno-0-110">110</a></span>
<span class="normal"><a href="#__codelineno-0-111">111</a></span>
<span class="normal"><a href="#__codelineno-0-112">112</a></span>
<span class="normal"><a href="#__codelineno-0-113">113</a></span>
<span class="normal"><a href="#__codelineno-0-114">114</a></span>
<span class="normal"><a href="#__codelineno-0-115">115</a></span>
<span class="normal"><a href="#__codelineno-0-116">116</a></span>
<span class="normal"><a href="#__codelineno-0-117">117</a></span>
<span class="normal"><a href="#__codelineno-0-118">118</a></span>
<span class="normal"><a href="#__codelineno-0-119">119</a></span>
<span class="normal"><a href="#__codelineno-0-120">120</a></span>
<span class="normal"><a href="#__codelineno-0-121">121</a></span>
<span class="normal"><a href="#__codelineno-0-122">122</a></span>
<span class="normal"><a href="#__codelineno-0-123">123</a></span>
<span class="normal"><a href="#__codelineno-0-124">124</a></span>
<span class="normal"><a href="#__codelineno-0-125">125</a></span>
<span class="normal"><a href="#__codelineno-0-126">126</a></span>
<span class="normal"><a href="#__codelineno-0-127">127</a></span>
<span class="normal"><a href="#__codelineno-0-128">128</a></span>
<span class="normal"><a href="#__codelineno-0-129">129</a></span>
<span class="normal"><a href="#__codelineno-0-130">130</a></span>
<span class="normal"><a href="#__codelineno-0-131">131</a></span>
<span class="normal"><a href="#__codelineno-0-132">132</a></span>
<span class="normal"><a href="#__codelineno-0-133">133</a></span>
<span class="normal"><a href="#__codelineno-0-134">134</a></span>
<span class="normal"><a href="#__codelineno-0-135">135</a></span>
<span class="normal"><a href="#__codelineno-0-136">136</a></span>
<span class="normal"><a href="#__codelineno-0-137">137</a></span>
<span class="normal"><a href="#__codelineno-0-138">138</a></span>
<span class="normal"><a href="#__codelineno-0-139">139</a></span>
<span class="normal"><a href="#__codelineno-0-140">140</a></span>
<span class="normal"><a href="#__codelineno-0-141">141</a></span>
<span class="normal"><a href="#__codelineno-0-142">142</a></span>
<span class="normal"><a href="#__codelineno-0-143">143</a></span>
<span class="normal"><a href="#__codelineno-0-144">144</a></span>
<span class="normal"><a href="#__codelineno-0-145">145</a></span>
<span class="normal"><a href="#__codelineno-0-146">146</a></span>
<span class="normal"><a href="#__codelineno-0-147">147</a></span>
<span class="normal"><a href="#__codelineno-0-148">148</a></span>
<span class="normal"><a href="#__codelineno-0-149">149</a></span>
<span class="normal"><a href="#__codelineno-0-150">150</a></span>
<span class="normal"><a href="#__codelineno-0-151">151</a></span>
<span class="normal"><a href="#__codelineno-0-152">152</a></span>
<span class="normal"><a href="#__codelineno-0-153">153</a></span>
<span class="normal"><a href="#__codelineno-0-154">154</a></span>
<span class="normal"><a href="#__codelineno-0-155">155</a></span>
<span class="normal"><a href="#__codelineno-0-156">156</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-49" name="__codelineno-0-49"></a><span class="k">def</span><span class="w"> </span><span class="nf">validate</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<a id="__codelineno-0-50" name="__codelineno-0-50"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Validate aggregation pattern configuration parameters.</span>
<a id="__codelineno-0-51" name="__codelineno-0-51"></a>
<a id="__codelineno-0-52" name="__codelineno-0-52"></a><span class="sd">    Ensures that all required parameters are present and valid. Checks that:</span>
<a id="__codelineno-0-53" name="__codelineno-0-53"></a><span class="sd">    - grain is specified (list of GROUP BY columns)</span>
<a id="__codelineno-0-54" name="__codelineno-0-54"></a><span class="sd">    - measures are provided with correct structure (list of dicts with &#39;name&#39; and &#39;expr&#39;)</span>
<a id="__codelineno-0-55" name="__codelineno-0-55"></a><span class="sd">    - incremental config is valid if provided (requires &#39;timestamp_column&#39; and valid merge_strategy)</span>
<a id="__codelineno-0-56" name="__codelineno-0-56"></a>
<a id="__codelineno-0-57" name="__codelineno-0-57"></a><span class="sd">    Raises:</span>
<a id="__codelineno-0-58" name="__codelineno-0-58"></a><span class="sd">        ValueError: If grain is missing, measures are missing/invalid, or incremental config is invalid.</span>
<a id="__codelineno-0-59" name="__codelineno-0-59"></a><span class="sd">    &quot;&quot;&quot;</span>
<a id="__codelineno-0-60" name="__codelineno-0-60"></a>    <span class="n">ctx</span> <span class="o">=</span> <span class="n">get_logging_context</span><span class="p">()</span>
<a id="__codelineno-0-61" name="__codelineno-0-61"></a>    <span class="n">grain</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;grain&quot;</span><span class="p">)</span>
<a id="__codelineno-0-62" name="__codelineno-0-62"></a>    <span class="n">measures</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;measures&quot;</span><span class="p">,</span> <span class="p">[])</span>
<a id="__codelineno-0-63" name="__codelineno-0-63"></a>
<a id="__codelineno-0-64" name="__codelineno-0-64"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-65" name="__codelineno-0-65"></a>        <span class="s2">&quot;AggregationPattern validation starting&quot;</span><span class="p">,</span>
<a id="__codelineno-0-66" name="__codelineno-0-66"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-67" name="__codelineno-0-67"></a>        <span class="n">grain</span><span class="o">=</span><span class="n">grain</span><span class="p">,</span>
<a id="__codelineno-0-68" name="__codelineno-0-68"></a>        <span class="n">measures_count</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">measures</span><span class="p">),</span>
<a id="__codelineno-0-69" name="__codelineno-0-69"></a>    <span class="p">)</span>
<a id="__codelineno-0-70" name="__codelineno-0-70"></a>
<a id="__codelineno-0-71" name="__codelineno-0-71"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">grain</span><span class="p">:</span>
<a id="__codelineno-0-72" name="__codelineno-0-72"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-73" name="__codelineno-0-73"></a>            <span class="s2">&quot;AggregationPattern validation failed: &#39;grain&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-74" name="__codelineno-0-74"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-75" name="__codelineno-0-75"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-76" name="__codelineno-0-76"></a>        <span class="p">)</span>
<a id="__codelineno-0-77" name="__codelineno-0-77"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-78" name="__codelineno-0-78"></a>            <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;grain&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-79" name="__codelineno-0-79"></a>            <span class="s2">&quot;Grain defines the grouping columns for aggregation (e.g., [&#39;date&#39;, &#39;region&#39;]). &quot;</span>
<a id="__codelineno-0-80" name="__codelineno-0-80"></a>            <span class="s2">&quot;Provide a list of column names to group by.&quot;</span>
<a id="__codelineno-0-81" name="__codelineno-0-81"></a>        <span class="p">)</span>
<a id="__codelineno-0-82" name="__codelineno-0-82"></a>
<a id="__codelineno-0-83" name="__codelineno-0-83"></a>    <span class="k">if</span> <span class="ow">not</span> <span class="n">measures</span><span class="p">:</span>
<a id="__codelineno-0-84" name="__codelineno-0-84"></a>        <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-85" name="__codelineno-0-85"></a>            <span class="s2">&quot;AggregationPattern validation failed: &#39;measures&#39; is required&quot;</span><span class="p">,</span>
<a id="__codelineno-0-86" name="__codelineno-0-86"></a>            <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-87" name="__codelineno-0-87"></a>            <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-88" name="__codelineno-0-88"></a>        <span class="p">)</span>
<a id="__codelineno-0-89" name="__codelineno-0-89"></a>        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-90" name="__codelineno-0-90"></a>            <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;measures&#39; parameter is required. &quot;</span>
<a id="__codelineno-0-91" name="__codelineno-0-91"></a>            <span class="s2">&quot;Measures define the aggregations to compute (e.g., [{&#39;name&#39;: &#39;total_sales&#39;, &#39;expr&#39;: &#39;sum(amount)&#39;}]). &quot;</span>
<a id="__codelineno-0-92" name="__codelineno-0-92"></a>            <span class="s2">&quot;Provide a list of dicts, each with &#39;name&#39; and &#39;expr&#39; keys.&quot;</span>
<a id="__codelineno-0-93" name="__codelineno-0-93"></a>        <span class="p">)</span>
<a id="__codelineno-0-94" name="__codelineno-0-94"></a>
<a id="__codelineno-0-95" name="__codelineno-0-95"></a>    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">measure</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">measures</span><span class="p">):</span>
<a id="__codelineno-0-96" name="__codelineno-0-96"></a>        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">measure</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
<a id="__codelineno-0-97" name="__codelineno-0-97"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-98" name="__codelineno-0-98"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern validation failed: measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] must be a dict&quot;</span><span class="p">,</span>
<a id="__codelineno-0-99" name="__codelineno-0-99"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-100" name="__codelineno-0-100"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-101" name="__codelineno-0-101"></a>            <span class="p">)</span>
<a id="__codelineno-0-102" name="__codelineno-0-102"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-103" name="__codelineno-0-103"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] must be a dict with &#39;name&#39; and &#39;expr&#39;. &quot;</span>
<a id="__codelineno-0-104" name="__codelineno-0-104"></a>                <span class="sa">f</span><span class="s2">&quot;Got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">measure</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">measure</span><span class="si">!r}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-105" name="__codelineno-0-105"></a>                <span class="s2">&quot;Example: {&#39;name&#39;: &#39;total_sales&#39;, &#39;expr&#39;: &#39;sum(amount)&#39;}&quot;</span>
<a id="__codelineno-0-106" name="__codelineno-0-106"></a>            <span class="p">)</span>
<a id="__codelineno-0-107" name="__codelineno-0-107"></a>        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure</span><span class="p">:</span>
<a id="__codelineno-0-108" name="__codelineno-0-108"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-109" name="__codelineno-0-109"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern validation failed: measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;name&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-110" name="__codelineno-0-110"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-111" name="__codelineno-0-111"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-112" name="__codelineno-0-112"></a>            <span class="p">)</span>
<a id="__codelineno-0-113" name="__codelineno-0-113"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-114" name="__codelineno-0-114"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;name&#39;. &quot;</span>
<a id="__codelineno-0-115" name="__codelineno-0-115"></a>                <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">measure</span><span class="si">!r}</span><span class="s2">. Add a &#39;name&#39; key for the output column name.&quot;</span>
<a id="__codelineno-0-116" name="__codelineno-0-116"></a>            <span class="p">)</span>
<a id="__codelineno-0-117" name="__codelineno-0-117"></a>        <span class="k">if</span> <span class="s2">&quot;expr&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">measure</span><span class="p">:</span>
<a id="__codelineno-0-118" name="__codelineno-0-118"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-119" name="__codelineno-0-119"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern validation failed: measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;expr&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-120" name="__codelineno-0-120"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-121" name="__codelineno-0-121"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-122" name="__codelineno-0-122"></a>            <span class="p">)</span>
<a id="__codelineno-0-123" name="__codelineno-0-123"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-124" name="__codelineno-0-124"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): measure[</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">] missing &#39;expr&#39;. &quot;</span>
<a id="__codelineno-0-125" name="__codelineno-0-125"></a>                <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">measure</span><span class="si">!r}</span><span class="s2">. Add an &#39;expr&#39; key with the aggregation expression (e.g., &#39;sum(amount)&#39;).&quot;</span>
<a id="__codelineno-0-126" name="__codelineno-0-126"></a>            <span class="p">)</span>
<a id="__codelineno-0-127" name="__codelineno-0-127"></a>
<a id="__codelineno-0-128" name="__codelineno-0-128"></a>    <span class="n">incremental</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;incremental&quot;</span><span class="p">)</span>
<a id="__codelineno-0-129" name="__codelineno-0-129"></a>    <span class="k">if</span> <span class="n">incremental</span><span class="p">:</span>
<a id="__codelineno-0-130" name="__codelineno-0-130"></a>        <span class="k">if</span> <span class="s2">&quot;timestamp_column&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">incremental</span><span class="p">:</span>
<a id="__codelineno-0-131" name="__codelineno-0-131"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-132" name="__codelineno-0-132"></a>                <span class="s2">&quot;AggregationPattern validation failed: incremental missing &#39;timestamp_column&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-133" name="__codelineno-0-133"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-134" name="__codelineno-0-134"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-135" name="__codelineno-0-135"></a>            <span class="p">)</span>
<a id="__codelineno-0-136" name="__codelineno-0-136"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-137" name="__codelineno-0-137"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): incremental config requires &#39;timestamp_column&#39;. &quot;</span>
<a id="__codelineno-0-138" name="__codelineno-0-138"></a>                <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">incremental</span><span class="si">!r}</span><span class="s2">. &quot;</span>
<a id="__codelineno-0-139" name="__codelineno-0-139"></a>                <span class="s2">&quot;Add &#39;timestamp_column&#39; to specify which column tracks record timestamps.&quot;</span>
<a id="__codelineno-0-140" name="__codelineno-0-140"></a>            <span class="p">)</span>
<a id="__codelineno-0-141" name="__codelineno-0-141"></a>        <span class="n">merge_strategy</span> <span class="o">=</span> <span class="n">incremental</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;merge_strategy&quot;</span><span class="p">,</span> <span class="s2">&quot;replace&quot;</span><span class="p">)</span>
<a id="__codelineno-0-142" name="__codelineno-0-142"></a>        <span class="k">if</span> <span class="n">merge_strategy</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;replace&quot;</span><span class="p">,</span> <span class="s2">&quot;sum&quot;</span><span class="p">,</span> <span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="s2">&quot;max&quot;</span><span class="p">):</span>
<a id="__codelineno-0-143" name="__codelineno-0-143"></a>            <span class="n">ctx</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
<a id="__codelineno-0-144" name="__codelineno-0-144"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern validation failed: invalid merge_strategy &#39;</span><span class="si">{</span><span class="n">merge_strategy</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">,</span>
<a id="__codelineno-0-145" name="__codelineno-0-145"></a>                <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-146" name="__codelineno-0-146"></a>                <span class="n">node</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
<a id="__codelineno-0-147" name="__codelineno-0-147"></a>            <span class="p">)</span>
<a id="__codelineno-0-148" name="__codelineno-0-148"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<a id="__codelineno-0-149" name="__codelineno-0-149"></a>                <span class="sa">f</span><span class="s2">&quot;AggregationPattern (node &#39;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;): &#39;merge_strategy&#39; must be &#39;replace&#39;, &#39;sum&#39;, &#39;min&#39;, or &#39;max&#39;. &quot;</span>
<a id="__codelineno-0-150" name="__codelineno-0-150"></a>                <span class="sa">f</span><span class="s2">&quot;Got: </span><span class="si">{</span><span class="n">merge_strategy</span><span class="si">}</span><span class="s2">&quot;</span>
<a id="__codelineno-0-151" name="__codelineno-0-151"></a>            <span class="p">)</span>
<a id="__codelineno-0-152" name="__codelineno-0-152"></a>
<a id="__codelineno-0-153" name="__codelineno-0-153"></a>    <span class="n">ctx</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
<a id="__codelineno-0-154" name="__codelineno-0-154"></a>        <span class="s2">&quot;AggregationPattern validation passed&quot;</span><span class="p">,</span>
<a id="__codelineno-0-155" name="__codelineno-0-155"></a>        <span class="n">pattern</span><span class="o">=</span><span class="s2">&quot;AggregationPattern&quot;</span><span class="p">,</span>
<a id="__codelineno-0-156" name="__codelineno-0-156"></a>    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["navigation.tabs", "navigation.sections", "navigation.top", "navigation.expand", "toc.integrate", "content.code.copy"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>