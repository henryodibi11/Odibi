project: odibi_store_silver
description: "Silver Layer Enrichment"
engine: pandas

connections:
  bronze_layer:
    type: local
    base_path: ./examples/real_world/data/bronze
  
  silver_layer:
    type: local
    base_path: ./examples/real_world/data/silver

story:
  connection: silver_layer
  path: ../stories/silver
  auto_generate: true

pipelines:
  # --- Pipeline 1: Clean & Enrich Orders ---
  - pipeline: enrich_orders
    description: "Enrich orders with currency rates and calculate delays"
    nodes:
      # Read Inputs
      - name: orders
        read:
          connection: bronze_layer
          path: orders
          format: parquet
          
      - name: rates
        read:
          connection: bronze_layer
          path: exchange_rates
          format: parquet

      # Transformation: Join & Calc
      - name: orders_enriched
        depends_on: [orders, rates]
        transform:
          steps:
            - sql: |
                SELECT 
                  o.order_id,
                  o.customer_id,
                  o.order_status,
                  CAST(o.order_purchase_timestamp AS TIMESTAMP) as purchase_ts,
                  CAST(o.order_delivered_customer_date AS TIMESTAMP) as delivered_ts,
                  CAST(o.order_estimated_delivery_date AS TIMESTAMP) as estimated_ts,
                  -- Calculate Delay (Days)
                  date_diff('day', CAST(o.order_estimated_delivery_date AS TIMESTAMP), CAST(o.order_delivered_customer_date AS TIMESTAMP)) as delay_days,
                  -- Date for Join
                  CAST(o.order_purchase_timestamp AS DATE) as order_date,
                  r.usd as rate_usd,
                  r.eur as rate_eur
                FROM orders o
                LEFT JOIN rates r ON CAST(o.order_purchase_timestamp AS DATE) = r.date

      - name: save_silver_orders
        depends_on: [orders_enriched]
        write:
          connection: silver_layer
          path: orders_enriched
          format: parquet
          mode: overwrite

  # --- Pipeline 2: Translate & Enrich Products ---
  - pipeline: enrich_products
    description: "Translate product categories to English"
    nodes:
      - name: products
        read:
          connection: bronze_layer
          path: products
          format: parquet
          
      - name: translations
        read:
          connection: bronze_layer
          path: category_translation
          format: parquet

      - name: products_translated
        depends_on: [products, translations]
        transform:
          steps:
            - sql: |
                SELECT 
                  p.product_id,
                  -- Coalesce to use English if available, else Original
                  COALESCE(t.product_category_name_english, p.product_category_name, 'unknown') as category,
                  p.product_weight_g,
                  p.product_length_cm,
                  p.product_height_cm,
                  p.product_width_cm
                FROM products p
                LEFT JOIN translations t ON p.product_category_name = t.product_category_name

      - name: save_silver_products
        depends_on: [products_translated]
        write:
          connection: silver_layer
          path: products_enriched
          format: parquet
          mode: overwrite

  # --- Pipeline 3: Enrich Items with Price (USD) ---
  - pipeline: enrich_items
    description: "Calculate item price in USD"
    nodes:
      - name: items
        read:
          connection: bronze_layer
          path: order_items
          format: parquet
      
      # We need orders to get the rate, or we join items -> orders -> rates again?
      # Ideally we join items -> silver_orders
      - name: silver_orders
        read:
          connection: silver_layer
          path: orders_enriched
          format: parquet

      - name: items_with_currency
        depends_on: [items, silver_orders]
        transform:
          steps:
            - sql: |
                SELECT 
                  i.order_id,
                  i.product_id,
                  i.seller_id,
                  i.price as price_brl,
                  i.freight_value as freight_brl,
                  o.rate_usd,
                  -- Calc USD
                  ROUND(i.price * o.rate_usd, 2) as price_usd,
                  ROUND(i.freight_value * o.rate_usd, 2) as freight_usd
                FROM items i
                JOIN silver_orders o ON i.order_id = o.order_id

      - name: save_silver_items
        depends_on: [items_with_currency]
        write:
          connection: silver_layer
          path: items_enriched
          format: parquet
          mode: overwrite
