project: odibi_guard
description: "Security Log Analysis"
engine: pandas

connections:
  raw_data:
    type: local
    base_path: ./examples/odibi_guard/data/raw
  lake:
    type: local
    base_path: ./examples/odibi_guard/data/lake

story:
  connection: lake
  path: ../stories
  auto_generate: true

pipelines:
  - pipeline: ingest_logs
    nodes:
      - name: read_log
        read:
          connection: raw_data
          path: access.log
          format: csv
          options:
            header: null
            names: ["line"]
            sep: "\t" # Logs are space separated, so tab won't split them

      - name: parse
        depends_on: [read_log]
        transform:
          steps:
            - function: parse_logs
              params: {}

      - name: detect_attacks
        depends_on: [parse]
        transform:
          steps:
            - sql: |
                SELECT
                  ip,
                  url,
                  status,
                  CASE
                    WHEN url LIKE '%OR 1=1%' THEN 'SQL_INJECTION'
                    WHEN url LIKE '%/etc/passwd%' THEN 'LFI'
                    ELSE 'NORMAL'
                  END as threat_level
                FROM parse
                WHERE url LIKE '%OR 1=1%' OR url LIKE '%/etc/passwd%'

      - name: save_alerts
        depends_on: [detect_attacks]
        write:
          connection: lake
          path: gold/alerts
          format: parquet
          mode: overwrite
