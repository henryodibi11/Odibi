project: odibi_match
description: "World Cup 2018 Final Analysis"
engine: pandas

connections:
  raw_data:
    type: local
    base_path: ./examples/odibi_match/data/raw
  lake:
    type: local
    base_path: ./examples/odibi_match/data/lake

story:
  connection: lake
  path: ../stories
  auto_generate: true

pipelines:
  - pipeline: analyze_match
    nodes:
      - name: read_events
        read:
          connection: raw_data
          path: match_8658.json
          format: json

      - name: flatten
        depends_on: [read_events]
        transform:
          steps:
            - function: flatten_events
              params: {}

      - name: extract_shots
        depends_on: [flatten]
        transform:
          steps:
            - function: extract_shots
              params: {}

      - name: player_stats
        depends_on: [extract_shots]
        transform:
          steps:
            - sql: |
                SELECT
                  player,
                  team,
                  COUNT(*) as shots,
                  SUM(CASE WHEN outcome = 'Goal' THEN 1 ELSE 0 END) as goals,
                  ROUND(SUM(xg), 2) as total_xg
                FROM extract_shots
                GROUP BY player, team
                ORDER BY total_xg DESC

      - name: save_report
        depends_on: [player_stats]
        write:
          connection: lake
          path: gold/player_shooting
          format: parquet
          mode: overwrite
